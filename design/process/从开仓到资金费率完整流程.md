# ä»å¼€ä»“åˆ°èµ„é‡‘è´¹ç‡çš„å®Œæ•´BDDä¸šåŠ¡æµç¨‹

## æ¦‚è¿°
æœ¬æ–‡æ¡£æè¿°æ°¸ç»­åˆçº¦ä»ç”¨æˆ·å¼€ä»“åˆ°èµ„é‡‘è´¹ç‡ç»“ç®—çš„å®Œæ•´ä¸šåŠ¡æµç¨‹,åŸºäºä»£ç åº“å®é™…å®ç°ã€‚

---

## ğŸ“Š å®Œæ•´æµç¨‹æ¦‚è§ˆ

```
ç”¨æˆ·æ“ä½œ â†’ è®¢å•å¤„ç† â†’ æŒä»“ç®¡ç† â†’ é£é™©ç›‘æ§ â†’ èµ„é‡‘è´¹ç‡ç»“ç®—
    â†“         â†“           â†“           â†“              â†“
  è®¾ç½®æ æ†   å¸‚ä»·/é™ä»·   æŒä»“åˆ›å»º    å¼ºå¹³ç›‘æ§      æ¯8å°æ—¶ç»“ç®—
    â†“         â†“           â†“           â†“              â†“
  é£æ§æ£€æŸ¥   æˆäº¤æ’®åˆ   ä¿è¯é‡‘é”å®š   ä»·æ ¼è§¦å‘      è´¹ç”¨æ”¶å–/æ”¯ä»˜
```

---

## ç¬¬ä¸€é˜¶æ®µï¼šå¼€ä»“å‡†å¤‡ (Pre-Opening)

### Step 1: è´¦æˆ·é…ç½®
**æ–‡ä»¶**: `proc/operating/exchange/prep/tests/bdd_perp_order_exch_proc.rs:1030-1060`

```gherkin
Feature: è®¾ç½®æ æ†å€æ•°
  Scenario: ç”¨æˆ·è®¾ç½®äº¤æ˜“æ æ†

    Given: ç”¨æˆ·æœ‰10000 USDTä½™é¢
    When: ç”¨æˆ·è®¾ç½®BTCUSDTçš„æ æ†ä¸º10å€
    Then:
      - æ æ†é…ç½®æˆåŠŸ
      - æ—§æ æ† = 1å€
      - æ–°æ æ† = 10å€
      - ä¿è¯é‡‘å ç”¨è°ƒæ•´ï¼ˆå¦‚æœ‰æŒä»“ï¼‰
```

**ä»£ç å®ç°**:
```rust:proc/operating/exchange/prep/tests/bdd_perp_order_exch_proc.rs
let set_leverage_cmd = SetLeverageCommand::new(Symbol::new("BTCUSDT"), 10);
let result = matching_service.set_leverage(set_leverage_cmd);

assert_eq!(result.old_leverage, 1);
assert_eq!(result.new_leverage, 10);
```

**å…³é”®è®¡ç®—**:
- ä¿è¯é‡‘éœ€æ±‚ = åä¹‰ä»·å€¼ / æ æ†å€æ•°
- 10å€æ æ†ï¼š50000 USDT / 10 = 5000 USDTä¿è¯é‡‘

---

## ç¬¬äºŒé˜¶æ®µï¼šè®¢å•æäº¤ä¸æˆäº¤ (Order Execution)

### Step 2: å¸‚ä»·å¼€ä»“
**æ–‡ä»¶**: `proc/operating/exchange/prep/tests/bdd_perp_order_exch_proc.rs:450-492`

```gherkin
Feature: å¼€å¤šä»“
  Scenario: ä½™é¢å……è¶³æ—¶æˆåŠŸå¼€å¤šä»“

    Given: ç”¨æˆ·æœ‰10000 USDTä½™é¢
      And: è®¾ç½®äº†5å€æ æ†
    When: ç”¨æˆ·ä»¥å¸‚ä»·å¼€å¤šä»“1 BTC
    Then:
      - è®¢å•ç«‹å³æˆäº¤
      - çŠ¶æ€ = OrderStatus::Filled
      - æŒä»“åˆ›å»ºæˆåŠŸ
      - ä¿è¯é‡‘é”å®š = 10000 USDT
```

**ä»£ç å®ç°**:
```rust:proc/operating/exchange/prep/tests/bdd_perp_order_exch_proc.rs
let open_cmd = OpenPositionCommand::market_long(
    Symbol::new("BTCUSDT"),
    Quantity::from_f64(1.0)
).with_leverage(5);

let open_result = matching_service.open_position(open_cmd);

assert_eq!(open_result.status, OrderStatus::Filled);
assert!(!open_result.trades.is_empty());
```

### Step 3: é™ä»·æŒ‚å•ï¼ˆå¯é€‰ï¼‰
**æ–‡ä»¶**: `proc/operating/exchange/prep/tests/bdd_perp_order_exch_proc.rs:570-607`

```gherkin
Feature: é™ä»·å•å¼€ä»“
  Scenario: é™ä»·å•è¿›å…¥è®¢å•ç°¿ç­‰å¾…æˆäº¤

    Given: ç”¨æˆ·æœ‰10000 USDTä½™é¢
    When: ç”¨æˆ·ä»¥49000ä»·æ ¼æŒ‚é™ä»·ä¹°å•1 BTC
    Then:
      - è®¢å•è¿›å…¥è®¢å•ç°¿
      - çŠ¶æ€ = OrderStatus::Submitted
      - æˆäº¤è®°å½•ä¸ºç©º
      - ç­‰å¾…å¸‚åœºä»·æ ¼è§¦è¾¾
```

---

## ç¬¬ä¸‰é˜¶æ®µï¼šæŒä»“ç®¡ç† (Position Management)

### Step 4: æŒä»“åˆ›å»ºä¸å¼ºå¹³ä»·è®¡ç®—
**æ–‡ä»¶**: `proc/operating/exchange/prep/tests/bdd_order_to_liquidation.rs:64-133`

```gherkin
Feature: æŒä»“åˆ›å»º
  Scenario: è®¢å•æˆäº¤ååˆ›å»ºæŒä»“å¹¶è®¡ç®—å¼ºå¹³ä»·

    Given: è®¢å•ä»¥50000 USDTæˆäº¤
      And: æ æ†å€æ•°ä¸º10å€
    When: åˆ›å»ºæŒä»“è®°å½•
    Then:
      - æŒä»“æ•°é‡ = 1.0 BTC
      - å¼€ä»“ä»· = 50000 USDT
      - ä¿è¯é‡‘ = 5000 USDT
      - å¼ºå¹³ä»· = 45500 USDT (å¤šä»“)
```

**ä»£ç å®ç°**:
```rust:proc/operating/exchange/prep/tests/bdd_order_to_liquidation.rs
let position = matching_service.query_position(
    QueryPositionCommand::long(Symbol::new("BTCUSDT"))
).unwrap();

assert_eq!(position.quantity.to_f64(), 1.0);
assert_eq!(position.entry_price.to_f64(), 50000.0);
assert_eq!(position.margin.to_f64(), 5000.0);

// å¼ºå¹³ä»·æ ¼è®¡ç®—
let liquidation_price = calculate_liquidation_price(
    entry_price,
    10,  // æ æ†
    PositionSide::Long
);
// ç»“æœ: 50000 Ã— (1 - 1/10 + 0.005 + 0.005) = 45500 USDT
```

**å¼ºå¹³ä»·æ ¼è®¡ç®—å…¬å¼**:
- **å¤šä»“**: `å…¥åœºä»· Ã— (1 - 1/æ æ† + ç»´æŒä¿è¯é‡‘ç‡ + Takerè´¹ç‡)`
- **ç©ºä»“**: `å…¥åœºä»· Ã— (1 + 1/æ æ† - ç»´æŒä¿è¯é‡‘ç‡ - Takerè´¹ç‡)`
- ç»´æŒä¿è¯é‡‘ç‡ = 0.5%
- Takerè´¹ç‡ = 0.5%

---

## ç¬¬å››é˜¶æ®µï¼šé£é™©ç›‘æ§ä¸å¼ºå¹³è§¦å‘ (Risk Monitoring)

### Step 5: æ ‡è®°ä»·æ ¼ç›‘æ§
**æ–‡ä»¶**: `proc/operating/exchange/prep/tests/bdd_order_to_liquidation.rs:134-145`

```gherkin
Feature: å¼ºå¹³ç›‘æ§
  Scenario: æ ‡è®°ä»·æ ¼è§¦åŠå¼ºå¹³ä»·

    Given: æŒä»“å¼ºå¹³ä»·ä¸º45500 USDT
    When: æ ‡è®°ä»·æ ¼è·Œè‡³45490 USDT
    Then:
      - è§¦å‘å¼ºå¹³æ¡ä»¶: mark_price <= liquidation_price
      - å¯åŠ¨ä¸‰çº§å¼ºå¹³æœºåˆ¶
```

**ä»£ç å®ç°**:
```rust:proc/operating/exchange/prep/tests/bdd_order_to_liquidation.rs
let mark_price = Price::from_f64(liquidation_price.to_f64() - 10.0);
let should_liquidate = mark_price <= liquidation_price;

assert!(should_liquidate);
println!("ğŸ”¥ è§¦å‘å¼ºå¹³æ¡ä»¶ï¼");
```

### Step 6: ä¸‰çº§å¼ºå¹³æœºåˆ¶
**æ–‡ä»¶**: `proc/operating/exchange/prep/tests/bdd_liquidation_flow.rs:378-434`

```gherkin
Feature: ä¸‰çº§å¼ºå¹³æœºåˆ¶
  Scenario: ç¬¬ä¸€çº§ - å¸‚åœºå¼ºå¹³æˆåŠŸ

    Given: æŒä»“è§¦å‘å¼ºå¹³
    When: æ‰§è¡Œå¸‚åœºå¼ºå¹³
    Then:
      - ä»¥å¸‚åœºä»·ç«‹å³å¹³ä»“
      - æˆäº¤ä»· â‰ˆ 45600 USDT
      - æŸå¤± = (50000 - 45600) Ã— 1.0 = 4400 USDT
      - ç”¨æˆ·æ‰¿æ‹…æŸå¤±ï¼ˆ< ä¿è¯é‡‘ï¼‰
      - ä¿é™©åŸºé‡‘æ— æŸå¤±
```

```gherkin
  Scenario: ç¬¬äºŒçº§ - ä¿é™©åŸºé‡‘æ¥ç®¡ï¼ˆæç«¯è¡Œæƒ…ï¼‰

    Given: å¸‚åœºä»·æš´è·Œè‡³40000 USDT
    When: å¸‚åœºå¼ºå¹³æˆäº¤ä»·ä½äºå¼ºå¹³ä»·
    Then:
      - æ€»æŸå¤± = 10000 USDT
      - ç”¨æˆ·æŸå¤± = 5000 USDT (å…¨éƒ¨ä¿è¯é‡‘)
      - ä¿é™©åŸºé‡‘æ‰¿æ‹… = 5000 USDT (è¶…é¢æŸå¤±)
```

```gherkin
  Scenario: ç¬¬ä¸‰çº§ - è‡ªåŠ¨å‡ä»“ADLï¼ˆä¿é™©åŸºé‡‘ä¸è¶³ï¼‰

    Given: ä¿é™©åŸºé‡‘ä½™é¢ä¸è¶³
    When: å¯»æ‰¾ç›ˆåˆ©å¯¹æ‰‹æ–¹
    Then:
      - æŸ¥æ‰¾å¯¹æ–¹å‘ç›ˆåˆ©ä»“ä½
      - å¼ºåˆ¶å¹³ä»“å¯¹æ‰‹æ–¹éƒ¨åˆ†æŒä»“
      - åˆ†é…æŸå¤±ç»™ç›ˆåˆ©ç”¨æˆ·
```

**ä»£ç å®ç°**:
```rust:proc/operating/exchange/prep/tests/bdd_order_to_liquidation.rs
let liquidation_result = liquidation_processor
    .execute_liquidation_with_position(position.clone(), mark_price)
    .await;

assert_eq!(result.liquidation_type, LiquidationType::Market);
assert_eq!(result.order_status, OrderStatus::Filled);
assert_eq!(result.insurance_fund_loss.to_f64(), 0.0);
```

**æŸå¤±åˆ†é…é€»è¾‘**:
```rust
// ç”¨æˆ·æŸå¤±
let user_loss = min(total_loss, margin);

// ä¿é™©åŸºé‡‘æŸå¤±
let insurance_loss = if total_loss > margin {
    total_loss - margin
} else {
    0.0
};
```

---

## ç¬¬äº”é˜¶æ®µï¼šèµ„é‡‘è´¹ç‡ç»“ç®— (Funding Rate Settlement)

### Step 7: èµ„é‡‘è´¹ç‡è®¡ç®—ï¼ˆæ¯8å°æ—¶ï¼‰
**æ–‡ä»¶**: `design/process/perp_order_exch_proc.xpdl:2159-2274`

```gherkin
Feature: èµ„é‡‘è´¹ç‡ç»“ç®—
  Scenario: æ¯8å°æ—¶ç»“ç®—ä¸€æ¬¡èµ„é‡‘è´¹ç‡

    Given: åˆ°è¾¾ç»“ç®—æ—¶é—´ (00:00, 08:00, 16:00 UTC)
    When: æ‰§è¡Œèµ„é‡‘è´¹ç‡ç»“ç®—æµç¨‹
    Then:
      - è®¡ç®—premium_indexï¼ˆæº¢ä»·æŒ‡æ•°ï¼‰
      - è®¡ç®—funding_rate = premium_index + clamped_diff
      - å¯¹æ‰€æœ‰æŒä»“æ”¶å–/æ”¯ä»˜èµ„é‡‘è´¹ç”¨
```

**èµ„é‡‘è´¹ç‡è®¡ç®—å…¬å¼**:
```rust
// 1. è®¡ç®—æº¢ä»·æŒ‡æ•°
let premium_index = (mark_price - index_price) / index_price;

// 2. è®¡ç®—EMAå·®å€¼
let ema_diff = (ema_mark - ema_index) / ema_index;

// 3. é™åˆ¶åœ¨Â±0.05%èŒƒå›´å†…
let clamped_diff = clamp(ema_diff, -0.0005, 0.0005);

// 4. æœ€ç»ˆèµ„é‡‘è´¹ç‡
let funding_rate = premium_index + clamped_diff;
```

### Step 8: èµ„é‡‘è´¹ç”¨æ”¶å–/æ”¯ä»˜
**æ–‡ä»¶**: `design/process/perp_order_exch_proc.xpdl:2246-2270`

```gherkin
Feature: èµ„é‡‘è´¹ç”¨ç»“ç®—
  Scenario: æŒä»“æ”¶å–æˆ–æ”¯ä»˜èµ„é‡‘è´¹ç”¨

    Given: ç”¨æˆ·æŒæœ‰1 BTCå¤šä»“ @ 50000 USDT
      And: å½“å‰èµ„é‡‘è´¹ç‡ = +0.01%
    When: æ‰§è¡Œèµ„é‡‘è´¹ç‡ç»“ç®—
    Then:
      - æŒä»“ä»·å€¼ = 1.0 Ã— 50000 = 50000 USDT
      - èµ„é‡‘è´¹ç”¨ = 50000 Ã— 0.0001 = 5 USDT
      - å¤šä»“æ”¯ä»˜ 5 USDT
      - ç©ºä»“æ”¶å– 5 USDT
```

**ä»£ç å®ç°**:
```rust
// è®¡ç®—èµ„é‡‘è´¹ç”¨
let position_value = position.quantity * mark_price;
let funding_fee = (position_value * funding_rate) as i64;

// å¤šä»“æ”¯ä»˜ï¼Œç©ºä»“æ”¶å–ï¼ˆå½“funding_rate > 0æ—¶ï¼‰
if position.is_long() {
    if funding_fee > 0 {
        // å¤šä»“æ”¯ä»˜
        deduct_balance(position.trader, funding_fee);
    } else {
        // å¤šä»“æ”¶å–
        add_balance(position.trader, funding_fee.abs());
    }
}
```

**èµ„é‡‘è´¹ç‡æ–¹å‘è§„åˆ™**:
- `funding_rate > 0`: å¤šå¤´æ”¯ä»˜ç»™ç©ºå¤´ï¼ˆåˆçº¦æº¢ä»·ï¼‰
- `funding_rate < 0`: ç©ºå¤´æ”¯ä»˜ç»™å¤šå¤´ï¼ˆåˆçº¦æŠ˜ä»·ï¼‰

### Step 9: èµ„é‡‘è´¹ç”¨å¯¹ä¿è¯é‡‘çš„å½±å“
**æ–‡ä»¶**: `lib/core/settlement/design.md:204-210`

```gherkin
Feature: èµ„é‡‘è´¹ç”¨å½±å“ä¿è¯é‡‘
  Scenario: èµ„é‡‘è´¹ç”¨å¯¼è‡´ä¿è¯é‡‘ä¸è¶³å¯èƒ½è§¦å‘å¼ºå¹³

    Given: ç”¨æˆ·ä¿è¯é‡‘ä½™é¢ = 5010 USDT
      And: ç»´æŒä¿è¯é‡‘è¦æ±‚ = 5000 USDT
    When: æ”¯ä»˜èµ„é‡‘è´¹ç”¨ 15 USDT
    Then:
      - æ–°ä½™é¢ = 4995 USDT
      - ä½äºç»´æŒä¿è¯é‡‘è¦æ±‚
      - è§¦å‘å¼ºå¹³é¢„è­¦æˆ–æ‰§è¡Œå¼ºå¹³
```

**ä¿è¯é‡‘æ£€æŸ¥é€»è¾‘**:
```rust
// æ”¯ä»˜èµ„é‡‘è´¹ç”¨åæ£€æŸ¥ä¿è¯é‡‘
let new_margin = current_margin - funding_fee;

if new_margin < maintenance_margin {
    // è§¦å‘å¼ºå¹³
    trigger_liquidation(position);
}
```

---

## ğŸ“ˆ å®Œæ•´æµç¨‹æ—¶é—´çº¿ç¤ºä¾‹

```
æ—¶é—´è½´                    äº‹ä»¶                        çŠ¶æ€å˜åŒ–
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
T0: 00:00 UTC          è®¾ç½®æ æ†10å€                  ä½™é¢: 10000 USDT
                                                    æ æ†: 10x

T1: 00:05 UTC          å¼€å¤šä»“ 1 BTC @ 50000         æŒä»“: 1 BTC Long
                                                    ä¿è¯é‡‘: 5000 USDT
                                                    å¼ºå¹³ä»·: 45500 USDT
                                                    å¯ç”¨ä½™é¢: 5000 USDT

T2: 04:30 UTC          ä»·æ ¼æ³¢åŠ¨ç›‘æ§                  æ ‡è®°ä»·: 51000 USDT
                                                    æœªå®ç°ç›ˆäº: +1000 USDT

T3: 08:00 UTC      ğŸ”” ç¬¬ä¸€æ¬¡èµ„é‡‘è´¹ç‡ç»“ç®—             èµ„é‡‘è´¹ç‡: +0.01%
                       (å¤šå¤´æ”¯ä»˜ç©ºå¤´)                è´¹ç”¨: -5 USDT
                                                    ä¿è¯é‡‘: 4995 USDT
                                                    å¯ç”¨ä½™é¢: 4995 USDT

T4: 12:45 UTC          ä»·æ ¼ä¸‹è·Œ                      æ ‡è®°ä»·: 48000 USDT
                                                    æœªå®ç°ç›ˆäº: -2000 USDT
                                                    ä¿è¯é‡‘: 4995 USDT

T5: 16:00 UTC      ğŸ”” ç¬¬äºŒæ¬¡èµ„é‡‘è´¹ç‡ç»“ç®—             èµ„é‡‘è´¹ç‡: +0.015%
                                                    è´¹ç”¨: -7.2 USDT
                                                    ä¿è¯é‡‘: 4987.8 USDT

T6: 18:30 UTC      âš ï¸ ä»·æ ¼è§¦åŠå¼ºå¹³ä»·                æ ‡è®°ä»·: 45490 USDT
                                                    è§¦å‘å¼ºå¹³

T7: 18:30:001      ğŸ”¥ æ‰§è¡Œå¸‚åœºå¼ºå¹³                   å¹³ä»“ä»·: 45600 USDT
                                                    æŸå¤±: 4400 USDT
                                                    å‰©ä½™: 587.8 USDT
                                                    (ä¿è¯é‡‘ - æŸå¤± - è´¹ç”¨)

T8: 24:00 UTC      ğŸ”” ä¸‹ä¸€æ¬¡èµ„é‡‘è´¹ç‡ç»“ç®—             æ— æŒä»“,ä¸æ”¶å–
                       (å·²æ— æŒä»“)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## ğŸ”‘ å…³é”®æ•°æ®æµè½¬

### 1. ä¿è¯é‡‘æµè½¬
```
åˆå§‹ä½™é¢ 10000 USDT
    â†“
é”å®šä¿è¯é‡‘ -5000 USDT (å¼€ä»“)
    â†“
å¯ç”¨ä½™é¢ 5000 USDT
    â†“
æ”¯ä»˜èµ„é‡‘è´¹ç”¨ -5 USDT (08:00)
    â†“
æ”¯ä»˜èµ„é‡‘è´¹ç”¨ -7.2 USDT (16:00)
    â†“
å¼ºå¹³æŸå¤± -4400 USDT (18:30)
    â†“
æœ€ç»ˆä½™é¢ 587.8 USDT
```

### 2. æŒä»“çŠ¶æ€å˜åŒ–
```
[ç©ºä»“] â†’ [å¼€ä»“ä¸­] â†’ [æŒä»“ä¸­] â†’ [ç›‘æ§ä¸­] â†’ [å¼ºå¹³è§¦å‘] â†’ [å¹³ä»“å®Œæˆ] â†’ [ç©ºä»“]
   â†‘         â†‘          â†‘          â†‘           â†‘            â†‘          â†‘
  åˆå§‹    è®¢å•æäº¤   è®¢å•æˆäº¤   ä»·æ ¼ç›‘æ§    è§¦åŠå¼ºå¹³ä»·   å¸‚åœºå¼ºå¹³    ç»“ç®—å®Œæˆ
```

### 3. é£é™©ç­‰çº§å˜åŒ–
```
å¼€ä»“æ—¶:
  é£é™©ç­‰çº§ = LOW
  è·ç¦»å¼ºå¹³ä»·: 4500 USDT (9%)

ç¬¬ä¸€æ¬¡æ”¶è´¹å:
  é£é™©ç­‰çº§ = LOW
  è·ç¦»å¼ºå¹³ä»·: 4495 USDT (8.99%)

ä»·æ ¼ä¸‹è·Œå:
  é£é™©ç­‰çº§ = MEDIUM
  è·ç¦»å¼ºå¹³ä»·: 2500 USDT (5.5%)

ç¬¬äºŒæ¬¡æ”¶è´¹å:
  é£é™©ç­‰çº§ = HIGH
  è·ç¦»å¼ºå¹³ä»·: 2487.8 USDT (5.5%)

è§¦å‘å¼ºå¹³:
  é£é™©ç­‰çº§ = CRITICAL
  è·ç¦»å¼ºå¹³ä»·: -10 USDT (å·²è§¦å‘)
```

---

## ğŸ“ ä¸šåŠ¡è§„åˆ™æ€»ç»“

### å¼€ä»“é˜¶æ®µè§„åˆ™
1. **æ æ†é™åˆ¶**: 1x - 125x (ä¸åŒäº¤æ˜“å¯¹ä¸åŒ)
2. **ä¿è¯é‡‘æ£€æŸ¥**: ä½™é¢ â‰¥ åä¹‰ä»·å€¼ / æ æ†
3. **é£é™©æç¤º**: æ æ†è¶Šé«˜ï¼Œå¼ºå¹³ä»·è¶Šæ¥è¿‘å¼€ä»“ä»·
4. **è®¢å•ç±»å‹**: å¸‚ä»·å•ç«‹å³æˆäº¤ï¼Œé™ä»·å•è¿›å…¥è®¢å•ç°¿

### æŒä»“ç®¡ç†è§„åˆ™
1. **å¼ºå¹³ä»·è®¡ç®—**: è€ƒè™‘æ æ†ã€ç»´æŒä¿è¯é‡‘ç‡ã€æ‰‹ç»­è´¹
2. **å¤šä»“å¼ºå¹³**: ä»·æ ¼ä¸‹è·Œè‡³å¼ºå¹³ä»·
3. **ç©ºä»“å¼ºå¹³**: ä»·æ ¼ä¸Šæ¶¨è‡³å¼ºå¹³ä»·
4. **æŒä»“æ¨¡å¼**: å•å‘æŒä»“(BOTH) æˆ– åŒå‘å¯¹å†²(LONG/SHORT)

### èµ„é‡‘è´¹ç‡è§„åˆ™
1. **ç»“ç®—å‘¨æœŸ**: æ¯8å°æ—¶ (00:00, 08:00, 16:00 UTC)
2. **è´¹ç‡èŒƒå›´**: é€šå¸¸åœ¨ -0.05% åˆ° +0.05%
3. **æ”¯ä»˜æ–¹å‘**:
   - æ­£è´¹ç‡: å¤šå¤´ä»˜ç»™ç©ºå¤´
   - è´Ÿè´¹ç‡: ç©ºå¤´ä»˜ç»™å¤šå¤´
4. **è®¡ç®—åŸºç¡€**: æŒä»“åä¹‰ä»·å€¼ Ã— èµ„é‡‘è´¹ç‡
5. **ä¿è¯é‡‘å½±å“**: è´¹ç”¨ä»ä¿è¯é‡‘æ‰£é™¤ï¼Œå¯èƒ½è§¦å‘å¼ºå¹³

### å¼ºå¹³æœºåˆ¶è§„åˆ™
1. **ç¬¬ä¸€çº§ - å¸‚åœºå¼ºå¹³**:
   - ä¼˜å…ˆçº§æœ€é«˜
   - å¸‚åœºä»·ç«‹å³å¹³ä»“
   - ç”¨æˆ·æ‰¿æ‹…æŸå¤± â‰¤ ä¿è¯é‡‘

2. **ç¬¬äºŒçº§ - ä¿é™©åŸºé‡‘**:
   - å¸‚åœºå¼ºå¹³å¤±è´¥æˆ–æŸå¤±è¶…ä¿è¯é‡‘
   - ä¿é™©åŸºé‡‘æ‰¿æ‹…è¶…é¢æŸå¤±
   - ä¿æŠ¤å…¶ä»–ç”¨æˆ·åˆ©ç›Š

3. **ç¬¬ä¸‰çº§ - ADLè‡ªåŠ¨å‡ä»“**:
   - ä¿é™©åŸºé‡‘ä¸è¶³æ—¶å¯åŠ¨
   - å¹³æ‰å¯¹æ–¹å‘ç›ˆåˆ©ä»“ä½
   - æŒ‰ç›ˆåˆ©ç‡å’Œæ æ†æ’åº

---

## ğŸ§ª æµ‹è¯•åœºæ™¯æ±‡æ€»

### æ­£å¸¸æµç¨‹æµ‹è¯•
âœ… **å®Œæ•´å¼€ä»“åˆ°å¹³ä»“æµç¨‹** (`bdd_perp_order_exch_proc.rs:1472`)
âœ… **å¸‚ä»·å¼€ä»“ç«‹å³æˆäº¤** (`bdd_perp_order_exch_proc.rs:450`)
âœ… **é™ä»·æŒ‚å•ç­‰å¾…æˆäº¤** (`bdd_perp_order_exch_proc.rs:571`)
âœ… **ç›ˆåˆ©å¹³ä»“è¿”è¿˜ä¿è¯é‡‘** (`bdd_perp_order_exch_proc.rs:669`)

### é£é™©åœºæ™¯æµ‹è¯•
âœ… **ä½™é¢ä¸è¶³æ‹’ç»å¼€ä»“** (`bdd_perp_order_exch_proc.rs:495`)
âœ… **ä»·æ ¼ä¸‹è·Œè§¦å‘å¼ºå¹³** (`bdd_order_to_liquidation.rs:24`)
âœ… **æç«¯è¡Œæƒ…ä¿é™©åŸºé‡‘ä»‹å…¥** (`bdd_order_to_liquidation.rs:348`)
âœ… **é«˜æ æ†æ›´æ˜“å¼ºå¹³** (`bdd_order_to_liquidation.rs:430`)

### èµ„é‡‘è´¹ç‡æµ‹è¯•
âœ… **æ­£è´¹ç‡å¤šå¤´æ”¯ä»˜** (è®¾è®¡æ–‡æ¡£å®šä¹‰)
âœ… **è´Ÿè´¹ç‡ç©ºå¤´æ”¯ä»˜** (è®¾è®¡æ–‡æ¡£å®šä¹‰)
âœ… **è´¹ç”¨å½±å“ä¿è¯é‡‘** (è®¾è®¡æ–‡æ¡£å®šä¹‰)
âœ… **è´¹ç”¨å¯¼è‡´å¼ºå¹³** (é€»è¾‘æ¨æ¼”)

---

## ğŸ“š ç›¸å…³ä»£ç æ–‡ä»¶ç´¢å¼•

### æ ¸å¿ƒä¸šåŠ¡æµç¨‹
- `proc/operating/exchange/prep/tests/bdd_perp_order_exch_proc.rs` - è®¢å•å¤„ç†BDDæµ‹è¯•
- `proc/operating/exchange/prep/tests/bdd_order_to_liquidation.rs` - å¼€ä»“åˆ°å¼ºå¹³å®Œæ•´æµç¨‹
- `proc/operating/exchange/prep/tests/bdd_liquidation_flow.rs` - ä¸‰çº§å¼ºå¹³æœºåˆ¶æµ‹è¯•

### é¢†åŸŸæ¨¡å‹
- `lib/core/exchange/prep/src/domain/entity/position.rs` - æŒä»“å®ä½“
- `proc/operating/exchange/prep/src/proc/trading_prep_order_proc.rs` - è®¢å•å‘½ä»¤å®šä¹‰
- `proc/operating/exchange/prep/src/proc/liquidation_proc.rs` - å¼ºå¹³å¤„ç†å™¨

### è®¾è®¡æ–‡æ¡£
- `design/process/perp_order_exch_proc.xpdl` - å®Œæ•´ä¸šåŠ¡æµç¨‹å®šä¹‰(XPDL)
- `lib/core/settlement/design.md` - èµ„é‡‘è´¹ç‡ç»“ç®—è®¾è®¡
- `design/process/story/market_data/mkdata.md` - å¸‚åœºæ•°æ®è®¾è®¡

### èµ„é‡‘è´¹ç‡
- `proc/operating/exchange/prep/src/proc/funding_rate.rs` - èµ„é‡‘è´¹ç‡æ¨¡å—(å¾…å®ç°)
- `design/process/perp_order_exch_proc.xpdl:2159` - èµ„é‡‘è´¹ç‡ç»“ç®—æµç¨‹å®šä¹‰

---

## ğŸ¯ æ€»ç»“

ä»**å¼€ä»“**åˆ°**èµ„é‡‘è´¹ç‡**çš„å®Œæ•´ä¸šåŠ¡æµç¨‹æ¶µç›–ï¼š

1. **å‡†å¤‡é˜¶æ®µ**: è´¦æˆ·é…ç½®ã€æ æ†è®¾ç½®
2. **äº¤æ˜“é˜¶æ®µ**: è®¢å•æäº¤ã€å¸‚åœºæ’®åˆã€æŒä»“åˆ›å»º
3. **ç›‘æ§é˜¶æ®µ**: å¼ºå¹³ä»·è®¡ç®—ã€æ ‡è®°ä»·æ ¼ç›‘æ§ã€é£é™©è¯„ä¼°
4. **ç»“ç®—é˜¶æ®µ**: èµ„é‡‘è´¹ç‡è®¡ç®—ã€è´¹ç”¨æ”¶å–/æ”¯ä»˜ã€ä¿è¯é‡‘è°ƒæ•´
5. **é£æ§é˜¶æ®µ**: å¼ºå¹³è§¦å‘ã€ä¸‰çº§å¼ºå¹³æœºåˆ¶ã€æŸå¤±åˆ†é…

æ¯ä¸ªé˜¶æ®µéƒ½æœ‰æ˜ç¡®çš„ä¸šåŠ¡è§„åˆ™ã€é£é™©æ§åˆ¶å’Œé”™è¯¯å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿ç³»ç»Ÿçš„å¥å£®æ€§å’Œç”¨æˆ·èµ„äº§å®‰å…¨ã€‚

**èµ„é‡‘è´¹ç‡ä½œä¸ºæ°¸ç»­åˆçº¦çš„æ ¸å¿ƒæœºåˆ¶**ï¼Œé€šè¿‡æ¯8å°æ—¶çš„å‘¨æœŸæ€§ç»“ç®—ï¼Œè°ƒèŠ‚åˆçº¦ä»·æ ¼ä¸ç°è´§ä»·æ ¼çš„é”šå®šå…³ç³»ï¼ŒåŒæ—¶ä¹Ÿä¼šå½±å“ç”¨æˆ·çš„ä¿è¯é‡‘ä½™é¢ï¼Œæˆä¸ºè§¦å‘å¼ºå¹³çš„æ½œåœ¨å› ç´ ä¹‹ä¸€ã€‚
