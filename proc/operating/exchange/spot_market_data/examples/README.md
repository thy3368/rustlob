# é‡åŒ–äº¤æ˜“è¡Œæƒ…æ•°æ®æ¶ˆè´¹ç¤ºä¾‹

## æ¦‚è¿°

æœ¬ç¤ºä¾‹å±•ç¤ºäº†é‡åŒ–äº¤æ˜“å‘˜å¦‚ä½•ä½¿ç”¨ `MarketDataQueryProcessorImpl` æ¶ˆè´¹ L1/L2/L3 è¡Œæƒ…æ•°æ®ï¼Œå®ç°çœŸå®çš„é‡åŒ–äº¤æ˜“ç­–ç•¥ã€‚

## è¿è¡Œç¤ºä¾‹

```bash
cargo run --example quant_market_data_consumer
```

## ç¤ºä¾‹åœºæ™¯

### åœºæ™¯ 1: é«˜é¢‘äº¤æ˜“ç­–ç•¥ - ä»·å·®æ•æ‰

**ç­–ç•¥ç›®æ ‡**: ç›‘æ§ L1 æœ€ä¼˜ä¹°å–ä»·ï¼Œæ•æ‰ä»·å·®å¥—åˆ©æœºä¼š

**ä½¿ç”¨çš„æ•°æ®å±‚çº§**: Level 1 (BBO - Best Bid/Offer)

**ç­–ç•¥é€»è¾‘**:
1. æŸ¥è¯¢ L1 æ•°æ®è·å–æœ€ä¼˜ä¹°å–ä»·
2. è®¡ç®—ä»·å·® (Spread)
3. åˆ¤æ–­ä»·å·®æ˜¯å¦æ»¡è¶³æœ€å°é˜ˆå€¼
4. æ£€æŸ¥æµåŠ¨æ€§æ˜¯å¦å……è¶³
5. ç”Ÿæˆäº¤æ˜“ä¿¡å·

**ä»£ç ç¤ºä¾‹**:
```rust
let hft_strategy = SpreadCaptureStrategy::new(symbol_id, 5, 50);
let query_l1 = QueryLevel1::new(symbol_id, 1000);
let result = processor.handle_query_level1(query_l1)?;
hft_strategy.analyze_level1(&result.snapshot);
```

**è¾“å‡ºç¤ºä¾‹**:
```
=== é«˜é¢‘äº¤æ˜“ç­–ç•¥ï¼šä»·å·®æ•æ‰ ===
äº¤æ˜“å¯¹: 1
æœ€ä¼˜ä¹°ä»·: 49999 (æ•°é‡: 100)
æœ€ä¼˜å–ä»·: 50001 (æ•°é‡: 150)
ä»·å·®: 2 (0.004%)
âœ… å‘ç°äº¤æ˜“æœºä¼šï¼
   å»ºè®®æ“ä½œ: ä¹°å…¥ 50 @ 49999, å–å‡º 50 @ 50001
   é¢„æœŸåˆ©æ¶¦: 100
```

### åœºæ™¯ 2: åšå¸‚å•†ç­–ç•¥ - æ·±åº¦åˆ†æ

**ç­–ç•¥ç›®æ ‡**: åˆ†æ L2 æ·±åº¦æ•°æ®ï¼ŒåŠ¨æ€è°ƒæ•´åšå¸‚æŠ¥ä»·

**ä½¿ç”¨çš„æ•°æ®å±‚çº§**: Level 2 (Market Depth)

**ç­–ç•¥é€»è¾‘**:
1. æŸ¥è¯¢ L2 æ•°æ®è·å–å¤šæ¡£æ·±åº¦
2. è®¡ç®—ä¹°å–ç›˜æ€»é‡
3. è®¡ç®—è®¢å•ç°¿å¤±è¡¡åº¦ (Imbalance)
4. æ ¹æ®å¤±è¡¡åº¦å†³å®šåšå¸‚æ–¹å‘
5. æ¨èæœ€ä¼˜æŠ¥ä»·ä½ç½®

**ä»£ç ç¤ºä¾‹**:
```rust
let mm_strategy = MarketMakingStrategy::new(symbol_id, 5, 0.2);
let query_l2 = QueryLevel2::depth_10(symbol_id, 1000);
let l2_result = processor.handle_query_level2(query_l2);
mm_strategy.analyze_level2(&l2_result.snapshot);
```

**è¾“å‡ºç¤ºä¾‹**:
```
=== åšå¸‚å•†ç­–ç•¥ï¼šæ·±åº¦åˆ†æ ===
ä¹°ç›˜æ·±åº¦ (å‰5æ¡£):
  æ¡£ä½ 1: ä»·æ ¼=50000, æ•°é‡=100, è®¢å•æ•°=1
  æ¡£ä½ 2: ä»·æ ¼=49990, æ•°é‡=150, è®¢å•æ•°=2
  ...

å–ç›˜æ·±åº¦ (å‰5æ¡£):
  æ¡£ä½ 1: ä»·æ ¼=50001, æ•°é‡=150, è®¢å•æ•°=1
  ...

è®¢å•ç°¿åˆ†æ:
  ä¹°ç›˜æ€»é‡: 1000
  å–ç›˜æ€»é‡: 1050
  å¤±è¡¡åº¦: -2.44%
âœ… å–ç›˜å‹åŠ›å¤§ï¼Œå»ºè®®åœ¨ä¹°æ–¹æŒ‚å•åšå¸‚
   æ¨èä»·æ ¼: 50000 (ä¹°ä¸€ä»·)
```

### åœºæ™¯ 3: å¤§å•è¿½è¸ªç­–ç•¥ - L3 è®¢å•åˆ†æ

**ç­–ç•¥ç›®æ ‡**: ç›‘æ§ L3 è®¢å•ç°¿ï¼Œè¯†åˆ«å¤§é¢è®¢å•å’Œæœºæ„è¡Œä¸º

**ä½¿ç”¨çš„æ•°æ®å±‚çº§**: Level 3 (Full Order Book)

**ç­–ç•¥é€»è¾‘**:
1. æŸ¥è¯¢ L3 æ•°æ®è·å–å®Œæ•´è®¢å•ç°¿
2. è¯†åˆ«å¤§é¢è®¢å• (è¶…è¿‡é˜ˆå€¼)
3. åˆ†æå¤§å•åˆ†å¸ƒ
4. åˆ¤æ–­å¸‚åœºæ–¹å‘
5. ç”Ÿæˆè·Ÿå•ä¿¡å·

**ä»£ç ç¤ºä¾‹**:
```rust
let large_order_strategy = LargeOrderTrackingStrategy::new(symbol_id, 100);
let query_l3 = QueryLevel3::new(symbol_id, 1000);
let l3_result = processor.handle_query_level3(query_l3);
large_order_strategy.analyze_level3(&l3_result.snapshot);
```

**è¾“å‡ºç¤ºä¾‹**:
```
=== å¤§å•è¿½è¸ªç­–ç•¥ï¼šL3 è®¢å•åˆ†æ ===
å¤§é¢ä¹°å• (>= 100):
  è®¢å•ID: 10000, ä»·æ ¼: 50000, æ•°é‡: 100
  è®¢å•ID: 10001, ä»·æ ¼: 49990, æ•°é‡: 120
  ...

å¤§é¢å–å• (>= 100):
  è®¢å•ID: 20000, ä»·æ ¼: 50001, æ•°é‡: 150
  ...

å¤§å•ç»Ÿè®¡:
  å¤§é¢ä¹°å•æ•°é‡: 5
  å¤§é¢å–å•æ•°é‡: 3
âœ… ä¹°æ–¹å¤§å•å ä¼˜ï¼Œå¸‚åœºå¯èƒ½ä¸Šæ¶¨
```

### åœºæ™¯ 4: å¢é‡æ•°æ®å®æ—¶ç›‘æ§

**ç­–ç•¥ç›®æ ‡**: å®æ—¶ç›‘æ§è®¢å•ç°¿å˜æ›´ã€æˆäº¤å’Œä»·æ ¼å˜åŠ¨

**ä½¿ç”¨çš„æ•°æ®ç±»å‹**: å¢é‡æ•°æ® (Incremental Data)

**ç­–ç•¥é€»è¾‘**:
1. æŸ¥è¯¢å¢é‡æ•°æ® (æŒ‡å®šåºåˆ—å·èŒƒå›´)
2. å¤„ç†è®¢å•ç°¿å˜æ›´äº‹ä»¶ (Add/Modify/Delete)
3. å¤„ç†æˆäº¤äº‹ä»¶
4. å¤„ç†æœ€ä¼˜ä¹°å–ä»·å˜æ›´äº‹ä»¶
5. ç»Ÿè®¡å¸‚åœºæ´»è·ƒåº¦

**ä»£ç ç¤ºä¾‹**:
```rust
let mut monitor = IncrementalDataMonitor::new(symbol_id, 1000);
let query_incremental = QueryIncrementalData::new(symbol_id, 1000, 1005);
let result = processor.handle_query_incremental_data(query_incremental)?;
monitor.process_incremental_data(&result);
```

**è¾“å‡ºç¤ºä¾‹**:
```
=== å¢é‡æ•°æ®å®æ—¶ç›‘æ§ ===
åºåˆ—å·èŒƒå›´: 1000 -> 1005
äº‹ä»¶æ•°é‡: 5

ğŸ“ è®¢å•ç°¿å˜æ›´:
  åºåˆ—å·: 1001
  å˜æ›´ç±»å‹: Add
  è®¢å•ID: 30001
  ä»·æ ¼: 49998
  æ•°é‡: 200
  âœ… æ–°å¢è®¢å•

ğŸ’° æˆäº¤äº‹ä»¶:
  åºåˆ—å·: 1002
  æˆäº¤ID: 5001
  æˆäº¤ä»·: 50000
  æˆäº¤é‡: 50
  æˆäº¤é¢: 2500000

ğŸ“Š æœ€ä¼˜ä¹°å–ä»·å˜æ›´:
  åºåˆ—å·: 1004
  æœ€ä¼˜ä¹°ä»·: 49998 (æ•°é‡: 200)
  æœ€ä¼˜å–ä»·: 50001 (æ•°é‡: 150)
  ä»·å·®: 3

ç»Ÿè®¡ä¿¡æ¯:
  ç´¯è®¡æˆäº¤æ¬¡æ•°: 1
  ç´¯è®¡è®¢å•ç°¿å˜æ›´: 3
```

### åœºæ™¯ 5: ç»¼åˆç­–ç•¥å†³ç­–

**ç­–ç•¥ç›®æ ‡**: ç»“åˆå¤šå±‚çº§æ•°æ®åšå‡ºç»¼åˆäº¤æ˜“å†³ç­–

**ä½¿ç”¨çš„æ•°æ®å±‚çº§**: L1 + L2 + L3 + å¢é‡æ•°æ®

**ç­–ç•¥é€»è¾‘**:
1. L1 æ•°æ®: åˆ¤æ–­ä»·å·®æ˜¯å¦æ»¡è¶³æ¡ä»¶
2. L2 æ•°æ®: åˆ†æè®¢å•ç°¿å¤±è¡¡åº¦
3. L3 æ•°æ®: è¯†åˆ«å¤§å•æ”¯æ’‘/å‹åŠ›ä½
4. å¢é‡æ•°æ®: è¯„ä¼°å¸‚åœºæ´»è·ƒåº¦
5. ç»¼åˆåˆ†æç”Ÿæˆæœ€ç»ˆå†³ç­–

## æ ¸å¿ƒç»„ä»¶

### 1. MarketDataQueryProcessorImpl

è¡Œæƒ…æŸ¥è¯¢å¤„ç†å™¨ï¼Œè´Ÿè´£å¤„ç†æ‰€æœ‰è¡Œæƒ…æŸ¥è¯¢è¯·æ±‚ã€‚

**åˆå§‹åŒ–**:
```rust
let processor = MarketDataQueryProcessorImpl::new(
    snapshot_repo,      // å¿«ç…§æ•°æ®ä»“å‚¨
    incremental_repo,   // å¢é‡æ•°æ®ä»“å‚¨
);
```

### 2. æ•°æ®ä»“å‚¨æ¥å£

**å¿«ç…§æ•°æ®ä»“å‚¨**:
- `Level1SnapshotRepo`: æä¾› L1 å¿«ç…§
- `Level2SnapshotRepo`: æä¾› L2 å¿«ç…§
- `Level3SnapshotRepo`: æä¾› L3 å¿«ç…§

**å¢é‡æ•°æ®ä»“å‚¨**:
- `IncrementalDataRepo`: æä¾›å¢é‡æ•°æ®æŸ¥è¯¢

### 3. æŸ¥è¯¢å‘½ä»¤

**å¿«ç…§æŸ¥è¯¢**:
- `QueryLevel1`: æŸ¥è¯¢å•ä¸ªäº¤æ˜“å¯¹çš„ L1 æ•°æ®
- `QueryLevel1Batch`: æ‰¹é‡æŸ¥è¯¢å¤šä¸ªäº¤æ˜“å¯¹çš„ L1 æ•°æ®
- `QueryLevel2`: æŸ¥è¯¢æŒ‡å®šæ·±åº¦çš„ L2 æ•°æ®
- `QueryLevel3`: æŸ¥è¯¢å®Œæ•´çš„ L3 è®¢å•ç°¿

**å¢é‡æŸ¥è¯¢**:
- `QueryIncrementalData`: æŸ¥è¯¢æŒ‡å®šåºåˆ—å·èŒƒå›´çš„å¢é‡æ•°æ®

### 4. æŸ¥è¯¢ç»“æœ

**å¿«ç…§ç»“æœ**:
- `Level1QueryResult`: L1 æŸ¥è¯¢ç»“æœ
- `Level2QueryResult`: L2 æŸ¥è¯¢ç»“æœ
- `Level3QueryResult`: L3 æŸ¥è¯¢ç»“æœ

**å¢é‡ç»“æœ**:
- `IncrementalDataResult`: å¢é‡æ•°æ®æŸ¥è¯¢ç»“æœ
  - `deltas`: å¢é‡äº‹ä»¶åˆ—è¡¨
  - `has_more`: æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®

### 5. å¢é‡äº‹ä»¶ç±»å‹

**è®¢å•ç°¿å˜æ›´**:
```rust
OrderBookDelta {
    change_type: OrderBookChangeType,  // Add/Modify/Delete
    order_id: OrderId,
    price: Price,
    quantity: Quantity,
    ...
}
```

**æˆäº¤äº‹ä»¶**:
```rust
TradeEvent {
    trade_id: u64,
    buyer_order_id: OrderId,
    seller_order_id: OrderId,
    price: Price,
    quantity: Quantity,
    aggressor_side: Side,
    ...
}
```

**æœ€ä¼˜ä¹°å–ä»·å˜æ›´**:
```rust
BboChangeEvent {
    best_bid: Option<Price>,
    best_bid_quantity: Quantity,
    best_ask: Option<Price>,
    best_ask_quantity: Quantity,
    ...
}
```

## å®é™…åº”ç”¨åœºæ™¯

### 1. é«˜é¢‘äº¤æ˜“ (HFT)
- ä½¿ç”¨ L1 æ•°æ®è¿›è¡Œæ¯«ç§’çº§å†³ç­–
- æ•æ‰å¾®å°ä»·å·®å¥—åˆ©æœºä¼š
- è¦æ±‚æä½å»¶è¿Ÿ

### 2. åšå¸‚å•† (Market Making)
- ä½¿ç”¨ L2 æ•°æ®åˆ†æå¸‚åœºæ·±åº¦
- åŠ¨æ€è°ƒæ•´ä¹°å–æŠ¥ä»·
- ç®¡ç†åº“å­˜é£é™©

### 3. ç®—æ³•äº¤æ˜“ (Algo Trading)
- ä½¿ç”¨ L3 æ•°æ®è¯†åˆ«å¤§å•
- TWAP/VWAP æ‰§è¡Œç®—æ³•
- å†°å±±è®¢å•æ£€æµ‹

### 4. é‡åŒ–ç ”ç©¶ (Quant Research)
- ä½¿ç”¨å¢é‡æ•°æ®è¿›è¡Œå›æµ‹
- åˆ†æè®¢å•æµ
- æ„å»ºé¢„æµ‹æ¨¡å‹

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®å±‚çº§é€‰æ‹©
- **L1**: æœ€å¿«ï¼Œé€‚åˆé«˜é¢‘ç­–ç•¥
- **L2**: ä¸­ç­‰ï¼Œé€‚åˆåšå¸‚ç­–ç•¥
- **L3**: æœ€æ…¢ï¼Œé€‚åˆæ·±åº¦åˆ†æ

### 2. æ‰¹é‡æŸ¥è¯¢
```rust
// æ‰¹é‡æŸ¥è¯¢å¤šä¸ªäº¤æ˜“å¯¹ï¼Œå‡å°‘ç½‘ç»œå¾€è¿”
let query_batch = QueryLevel1Batch::new(vec![1, 2, 3], sequence);
let result = processor.handle_query_level1_batch(query_batch);
```

### 3. å¢é‡æ•°æ®åˆ†é¡µ
```rust
// åˆ†é¡µæŸ¥è¯¢å¢é‡æ•°æ®ï¼Œé¿å…ä¸€æ¬¡åŠ è½½è¿‡å¤š
let query = QueryIncrementalData::new(symbol_id, from_seq, to_seq);
let result = processor.handle_query_incremental_data(query)?;

if result.has_more {
    // ç»§ç»­æŸ¥è¯¢ä¸‹ä¸€é¡µ
}
```

### 4. ç¼“å­˜ç­–ç•¥
- ç¼“å­˜ L1 æ•°æ®ç”¨äºå¿«é€Ÿè®¿é—®
- å®šæœŸåˆ·æ–° L2/L3 æ•°æ®
- å¢é‡æ•°æ®å®æ—¶æ›´æ–°

## æ‰©å±•ç¤ºä¾‹

### è‡ªå®šä¹‰ç­–ç•¥å®ç°

```rust
struct MyCustomStrategy {
    // ç­–ç•¥å‚æ•°
}

impl MyCustomStrategy {
    fn analyze(&self, l1: &Level1, l2: &Level2<10>, l3: &Level3) {
        // 1. åˆ†æ L1 æ•°æ®
        let spread = l1.best_ask.unwrap() - l1.best_bid.unwrap();

        // 2. åˆ†æ L2 æ·±åº¦
        let bid_volume = calculate_volume(&l2.bids);
        let ask_volume = calculate_volume(&l2.asks);

        // 3. åˆ†æ L3 å¤§å•
        let large_orders = find_large_orders(&l3);

        // 4. ç”Ÿæˆäº¤æ˜“ä¿¡å·
        if spread < threshold && bid_volume > ask_volume {
            println!("âœ… ä¹°å…¥ä¿¡å·");
        }
    }
}
```

## æ³¨æ„äº‹é¡¹

1. **åºåˆ—å·ç®¡ç†**: ç¡®ä¿å¢é‡æ•°æ®æŸ¥è¯¢çš„åºåˆ—å·è¿ç»­æ€§
2. **é”™è¯¯å¤„ç†**: å¤„ç†æŸ¥è¯¢å¤±è´¥å’Œæ•°æ®ç¼ºå¤±æƒ…å†µ
3. **æ€§èƒ½ç›‘æ§**: ç›‘æ§æŸ¥è¯¢å»¶è¿Ÿå’Œååé‡
4. **å†…å­˜ç®¡ç†**: åŠæ—¶é‡Šæ”¾ä¸å†ä½¿ç”¨çš„æ•°æ®

## ç›¸å…³æ–‡æ¡£

- [è¡Œæƒ…æ•°æ®æ¥å£è®¾è®¡](lob/domain/service/trading_market_data_proc.rs)
- [æŸ¥è¯¢å¤„ç†å™¨å®ç°](lob/domain/service/trading_market_data_proc_impl.rs)
- [Level 1-3 æ•°æ®ç±»å‹](../src/lob/domain/entity/level_types.rs)
