//! OrderBookDelta åˆ†é…æ€§èƒ½åŸºå‡†æµ‹è¯• - è¯¦ç»†æ³¨é‡Šæ•™å­¦ç‰ˆ
//!
//! è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Criterion åŸºå‡†æµ‹è¯•ç¤ºä¾‹ï¼ŒåŒ…å«è¯¦ç»†çš„æ³¨é‡Šå’Œæœ€ä½³å®è·µè¯´æ˜ã€‚
//! é€‚åˆä½œä¸ºå­¦ä¹  Criterion çš„å‚è€ƒä»£ç ã€‚
//!
//! # å­¦ä¹ ç›®æ ‡
//!
//! 1. ç†è§£ Criterion çš„åŸºæœ¬ç”¨æ³•
//! 2. å­¦ä¼šä½¿ç”¨ black_box é˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–
//! 3. æŒæ¡å‚æ•°åŒ–åŸºå‡†æµ‹è¯•
//! 4. äº†è§£å¦‚ä½•å¯¹æ¯”ä¸åŒå®ç°
//!
//! # è¿è¡Œæ–¹å¼
//!
//! ```bash
//! # è¿è¡Œæ‰€æœ‰åŸºå‡†æµ‹è¯•
//! cargo bench --bench orderbook_delta_allocation_annotated
//!
//! # åªè¿è¡Œç‰¹å®šæµ‹è¯•
//! cargo bench --bench orderbook_delta_allocation_annotated -- single
//!
//! # æŸ¥çœ‹ HTML æŠ¥å‘Š
//! cargo bench --bench orderbook_delta_allocation_annotated
//! open target/criterion/report/index.html
//! ```

// ============================================================================
// å¯¼å…¥å¿…è¦çš„ä¾èµ–
// ============================================================================

use criterion::{
    black_box,       // é˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–æ‰æµ‹è¯•ä»£ç 
    criterion_group, // å®šä¹‰åŸºå‡†æµ‹è¯•ç»„
    criterion_main,  // å®šä¹‰ä¸»å…¥å£
    BenchmarkId,     // å‚æ•°åŒ–æµ‹è¯•çš„ ID
    Criterion        // åŸºå‡†æµ‹è¯•ä¸Šä¸‹æ–‡
};
use lob::lob::{Side, TraderId};
use spot_market_data::domain::entity::level_types::{OrderChangeType, OrderDelta};

// ============================================================================
// è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºæµ‹è¯•æ•°æ®
// ============================================================================

/// åˆ›å»ºä¸€ä¸ªç¤ºä¾‹ OrderDelta
///
/// # ä¸ºä»€ä¹ˆä½¿ç”¨ #[inline]ï¼Ÿ
///
/// `#[inline]` æç¤ºç¼–è¯‘å™¨å†…è”è¿™ä¸ªå‡½æ•°ï¼Œå‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€ã€‚
/// åœ¨åŸºå‡†æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›æµ‹é‡çš„æ˜¯æ•°æ®ç»“æ„çš„åˆ›å»ºæˆæœ¬ï¼Œè€Œä¸æ˜¯å‡½æ•°è°ƒç”¨å¼€é”€ã€‚
///
/// # å‚æ•°
///
/// * `index` - ç”¨äºç”Ÿæˆä¸åŒçš„æµ‹è¯•æ•°æ®ï¼Œé¿å…ç¼–è¯‘å™¨ä¼˜åŒ–
#[inline]
fn create_orderbook_delta(index: u64) -> OrderDelta {
    OrderDelta {
        symbol_id: 1,
        timestamp: 1234567890 + index,
        sequence: 1000 + index,
        change_type: OrderChangeType::Add,
        order_id: 10000 + index,
        side: if index % 2 == 0 { Side::Buy } else { Side::Sell },
        price: 50000 + (index as u32),
        quantity: 100 + (index as u32),
        trader_id: Some(TraderId::new([(index % 256) as u8, ((index / 256) % 256) as u8, 1, 2, 3, 4, 5, 6]))
    }
}

// ============================================================================
// åŸºå‡†æµ‹è¯• 1: å•æ¬¡åˆ†é…
// ============================================================================

/// åŸºå‡†æµ‹è¯•ï¼šå•æ¬¡åˆ†é… OrderDelta
///
/// # æµ‹è¯•ç›®æ ‡
///
/// æµ‹é‡åˆ›å»ºå•ä¸ª OrderDelta å®ä¾‹çš„æ—¶é—´ã€‚
///
/// # Criterion åŸºç¡€æ¦‚å¿µ
///
/// - `c.bench_function()`: åˆ›å»ºä¸€ä¸ªåŸºå‡†æµ‹è¯•
/// - `|b|`: é—­åŒ…å‚æ•° b æ˜¯ Bencherï¼Œç”¨äºæ‰§è¡Œæµ‹è¯•
/// - `b.iter()`: æ‰§è¡Œæµ‹è¯•ä»£ç ï¼ŒCriterion ä¼šè‡ªåŠ¨å†³å®šè¿è¡Œå¤šå°‘æ¬¡
///
/// # black_box çš„ä½œç”¨
///
/// ```rust
/// // âŒ æ²¡æœ‰ black_box - ç¼–è¯‘å™¨å¯èƒ½ä¼˜åŒ–æ‰
/// b.iter(|| {
///     let delta = create_orderbook_delta(0);
///     // delta æœªä½¿ç”¨ï¼Œç¼–è¯‘å™¨å¯èƒ½åˆ é™¤æ•´ä¸ªè®¡ç®—
/// });
///
/// // âœ… ä½¿ç”¨ black_box - å‘Šè¯‰ç¼–è¯‘å™¨è¿™ä¸ªå€¼ä¼šè¢«ä½¿ç”¨
/// b.iter(|| {
///     let delta = create_orderbook_delta(black_box(0));
///     black_box(delta);  // ç¡®ä¿ delta ä¸è¢«ä¼˜åŒ–æ‰
/// });
/// ```
fn bench_single_allocation(c: &mut Criterion) {
    c.bench_function("single_orderbook_delta_allocation", |b| {
        b.iter(|| {
            // black_box(0): é˜²æ­¢ç¼–è¯‘å™¨å°† 0 ä¼˜åŒ–ä¸ºå¸¸é‡
            let delta = create_orderbook_delta(black_box(0));

            // black_box(delta): é˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–æ‰æ•´ä¸ª delta
            black_box(delta);
        });
    });
}

// ============================================================================
// åŸºå‡†æµ‹è¯• 2: Vec åˆ†é…ï¼ˆæ— é¢„åˆ†é…ï¼‰
// ============================================================================

/// åŸºå‡†æµ‹è¯•ï¼šåˆ†é… 100 ä¸ª OrderDelta åˆ° Vecï¼ˆæ— é¢„åˆ†é…ï¼‰
///
/// # æµ‹è¯•ç›®æ ‡
///
/// æµ‹é‡ä¸é¢„åˆ†é…å®¹é‡æ—¶ï¼ŒVec çš„æ€§èƒ½è¡¨ç°ã€‚
///
/// # ä¸ºä»€ä¹ˆæ…¢ï¼Ÿ
///
/// Vec::new() åˆå§‹å®¹é‡ä¸º 0ï¼Œéšç€å…ƒç´ å¢åŠ ä¼šå¤šæ¬¡é‡æ–°åˆ†é…ï¼š
/// - 0 -> 4 -> 8 -> 16 -> 32 -> 64 -> 128
/// - æ¯æ¬¡é‡æ–°åˆ†é…éƒ½éœ€è¦ï¼š
///   1. åˆ†é…æ–°å†…å­˜
///   2. æ‹·è´æ—§æ•°æ®
///   3. é‡Šæ”¾æ—§å†…å­˜
///
/// # é¢„æœŸç»“æœ
///
/// è¿™åº”è¯¥æ˜¯æœ€æ…¢çš„æ–¹æ³•ï¼Œå› ä¸ºæœ‰å¤šæ¬¡å†…å­˜é‡æ–°åˆ†é…ã€‚
fn bench_vec_allocation_no_reserve(c: &mut Criterion) {
    c.bench_function("vec_100_orderbook_deltas_no_reserve", |b| {
        b.iter(|| {
            let mut deltas = Vec::new(); // åˆå§‹å®¹é‡ä¸º 0

            for i in 0..100 {
                // black_box(i): é˜²æ­¢ç¼–è¯‘å™¨å±•å¼€å¾ªç¯æˆ–ä¼˜åŒ–æ‰å¾ªç¯
                deltas.push(create_orderbook_delta(black_box(i)));
            }

            // black_box(deltas): ç¡®ä¿ Vec ä¸è¢«ä¼˜åŒ–æ‰
            black_box(deltas);
        });
    });
}

// ============================================================================
// åŸºå‡†æµ‹è¯• 3: Vec åˆ†é…ï¼ˆé¢„åˆ†é…å®¹é‡ï¼‰
// ============================================================================

/// åŸºå‡†æµ‹è¯•ï¼šåˆ†é… 100 ä¸ª OrderDelta åˆ° Vecï¼ˆé¢„åˆ†é…å®¹é‡ï¼‰
///
/// # æµ‹è¯•ç›®æ ‡
///
/// æµ‹é‡é¢„åˆ†é…å®¹é‡æ—¶ï¼ŒVec çš„æ€§èƒ½è¡¨ç°ã€‚
///
/// # ä¸ºä»€ä¹ˆå¿«ï¼Ÿ
///
/// Vec::with_capacity(100) ä¸€æ¬¡æ€§åˆ†é…è¶³å¤Ÿçš„å†…å­˜ï¼š
/// - åªåˆ†é…ä¸€æ¬¡å†…å­˜
/// - æ— éœ€é‡æ–°åˆ†é…
/// - æ— éœ€æ‹·è´æ•°æ®
///
/// # é¢„æœŸç»“æœ
///
/// æ¯”æ— é¢„åˆ†é…å¿«çº¦ 2 å€ã€‚
fn bench_vec_allocation_with_reserve(c: &mut Criterion) {
    c.bench_function("vec_100_orderbook_deltas_with_reserve", |b| {
        b.iter(|| {
            // é¢„åˆ†é… 100 ä¸ªå…ƒç´ çš„å®¹é‡
            let mut deltas = Vec::with_capacity(100);

            for i in 0..100 {
                deltas.push(create_orderbook_delta(black_box(i)));
            }

            black_box(deltas);
        });
    });
}

// ============================================================================
// åŸºå‡†æµ‹è¯• 4: ä½¿ç”¨ collect()
// ============================================================================

/// åŸºå‡†æµ‹è¯•ï¼šä½¿ç”¨ collect åˆ†é… 100 ä¸ª OrderDelta
///
/// # æµ‹è¯•ç›®æ ‡
///
/// æµ‹é‡ä½¿ç”¨è¿­ä»£å™¨ + collect() çš„æ€§èƒ½ã€‚
///
/// # ä¸ºä»€ä¹ˆæœ€å¿«ï¼Ÿ
///
/// 1. **ç¼–è¯‘å™¨å¯è§æ€§**: ç¼–è¯‘å™¨èƒ½çœ‹åˆ°å®Œæ•´çš„æ•°æ®æµ
/// 2. **ç²¾ç¡®å¤§å°æç¤º**: Range è¿­ä»£å™¨æä¾›ç¡®åˆ‡çš„å¤§å°
/// 3. **ä¼˜åŒ–å‹å¥½**: å¯ä»¥åº”ç”¨å¾ªç¯å±•å¼€ã€å‘é‡åŒ–ç­‰ä¼˜åŒ–
/// 4. **æ— è¿è¡Œæ—¶æ£€æŸ¥**: ä½¿ç”¨ unsafe å¿«é€Ÿè·¯å¾„
///
/// # å†…éƒ¨å®ç°ï¼ˆç®€åŒ–ï¼‰
///
/// ```rust
/// impl<T> FromIterator<T> for Vec<T> {
///     fn from_iter<I: IntoIterator<Item = T>>(iter: I) -> Self {
///         let mut iter = iter.into_iter();
///         let (lower, upper) = iter.size_hint();
///
///         if upper == Some(lower) {
///             // ç²¾ç¡®å¤§å°å·²çŸ¥ - ä¸€æ¬¡æ€§åˆ†é…
///             let mut vec = Vec::with_capacity(lower);
///             for item in iter {
///                 // ä½¿ç”¨ unsafe å¿«é€Ÿè·¯å¾„ï¼Œè·³è¿‡å®¹é‡æ£€æŸ¥
///                 vec.push_unchecked(item);
///             }
///             vec
///         } else {
///             // å¤§å°æœªçŸ¥ - å¢é‡åˆ†é…
///             // ...
///         }
///     }
/// }
/// ```
///
/// # é¢„æœŸç»“æœ
///
/// æœ€å¿«çš„æ–¹æ³•ï¼Œæ¯”æ‰‹åŠ¨å¾ªç¯å¿«çº¦ 20-30%ã€‚
fn bench_vec_allocation_collect(c: &mut Criterion) {
    c.bench_function("vec_100_orderbook_deltas_collect", |b| {
        b.iter(|| {
            // ä½¿ç”¨è¿­ä»£å™¨ + collect()
            // Range (0..100) æä¾›ç²¾ç¡®çš„å¤§å°æç¤º
            let deltas: Vec<OrderDelta> = (0..100).map(|i| create_orderbook_delta(black_box(i))).collect();

            black_box(deltas);
        });
    });
}

// ============================================================================
// åŸºå‡†æµ‹è¯• 5: æ ˆæ•°ç»„åˆ†é…
// ============================================================================

/// åŸºå‡†æµ‹è¯•ï¼šåˆ†é… 100 ä¸ª OrderDelta åˆ°æ ˆæ•°ç»„
///
/// # æµ‹è¯•ç›®æ ‡
///
/// æµ‹é‡æ ˆåˆ†é…çš„æ€§èƒ½ã€‚
///
/// # æ ˆ vs å †
///
/// - **æ ˆåˆ†é…**: å¿«é€Ÿï¼Œä½†å¤§å°å›ºå®šï¼Œç©ºé—´æœ‰é™ï¼ˆé€šå¸¸ 1-8 MBï¼‰
/// - **å †åˆ†é…**: çµæ´»ï¼Œä½†éœ€è¦åˆ†é…å™¨å¼€é”€
///
/// # ä¸ºä»€ä¹ˆå¯èƒ½æ›´æ…¢ï¼Ÿ
///
/// 1. **æ ˆç©ºé—´å¼€é”€**: 100 * 56 å­—èŠ‚ = 5,600 å­—èŠ‚
/// 2. **åˆå§‹åŒ–é¡ºåº**: å¿…é¡»æŒ‰é¡ºåºåˆå§‹åŒ–
/// 3. **æ— æ³•å¹¶è¡Œ**: ä¸èƒ½åˆ©ç”¨ SIMD ä¼˜åŒ–
/// 4. **æ ˆæº¢å‡ºé£é™©**: å¤§æ•°ç»„å¯èƒ½å¯¼è‡´æ ˆæº¢å‡º
///
/// # é¢„æœŸç»“æœ
///
/// æ¯” collect() æ…¢çº¦ 2 å€ã€‚
fn bench_array_allocation(c: &mut Criterion) {
    c.bench_function("array_100_orderbook_deltas", |b| {
        b.iter(|| {
            // std::array::from_fn: ä½¿ç”¨é—­åŒ…åˆå§‹åŒ–æ•°ç»„
            let deltas: [OrderDelta; 100] = std::array::from_fn(|i| create_orderbook_delta(black_box(i as u64)));

            black_box(deltas);
        });
    });
}

// ============================================================================
// åŸºå‡†æµ‹è¯• 6: å‚æ•°åŒ–æµ‹è¯•
// ============================================================================

/// åŸºå‡†æµ‹è¯•ï¼šä¸åŒæ•°é‡çš„ OrderDelta åˆ†é…ï¼ˆå‚æ•°åŒ–æµ‹è¯•ï¼‰
///
/// # æµ‹è¯•ç›®æ ‡
///
/// æµ‹é‡ä¸åŒæ•°é‡ä¸‹çš„æ€§èƒ½è¡¨ç°ï¼Œæ‰¾å‡ºæ€§èƒ½ç‰¹å¾ã€‚
///
/// # å‚æ•°åŒ–æµ‹è¯•çš„ä¼˜åŠ¿
///
/// 1. **å‘ç°æ€§èƒ½æ‹ç‚¹**: æ‰¾å‡ºæ€§èƒ½çªå˜çš„ä¸´ç•Œç‚¹
/// 2. **éªŒè¯å¤æ‚åº¦**: éªŒè¯ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ï¼ˆO(n)ã€O(nÂ²) ç­‰ï¼‰
/// 3. **å¯¹æ¯”ä¸åŒè§„æ¨¡**: å°æ•°æ® vs å¤§æ•°æ®çš„è¡¨ç°
///
/// # BenchmarkGroup çš„ä½œç”¨
///
/// - å°†ç›¸å…³çš„åŸºå‡†æµ‹è¯•ç»„ç»‡åœ¨ä¸€èµ·
/// - ç”Ÿæˆå¯¹æ¯”å›¾è¡¨
/// - å…±äº«é…ç½®ï¼ˆé‡‡æ ·æ•°ã€é¢„çƒ­æ—¶é—´ç­‰ï¼‰
///
/// # é¢„æœŸç»“æœ
///
/// åº”è¯¥å‘ˆç°çº¿æ€§å…³ç³»ï¼šæ—¶é—´ âˆ æ•°é‡
fn bench_varying_sizes(c: &mut Criterion) {
    // åˆ›å»ºåŸºå‡†æµ‹è¯•ç»„
    let mut group = c.benchmark_group("orderbook_delta_allocation_varying_sizes");

    // æµ‹è¯•ä¸åŒçš„å¤§å°
    for size in [10, 50, 100, 200, 500, 1000].iter() {
        // bench_with_input: å‚æ•°åŒ–æµ‹è¯•
        // BenchmarkId: ä¸ºæ¯ä¸ªå‚æ•°åˆ›å»ºå”¯ä¸€çš„ ID
        group.bench_with_input(BenchmarkId::new("vec_with_reserve", size), size, |b, &size| {
            b.iter(|| {
                let mut deltas = Vec::with_capacity(size);
                for i in 0..size {
                    deltas.push(create_orderbook_delta(black_box(i as u64)));
                }
                black_box(deltas);
            });
        });
    }

    // å®Œæˆæµ‹è¯•ç»„ï¼ˆç”ŸæˆæŠ¥å‘Šï¼‰
    group.finish();
}

// ============================================================================
// åŸºå‡†æµ‹è¯• 7: Copy æ€§èƒ½
// ============================================================================

/// åŸºå‡†æµ‹è¯•ï¼šOrderDelta çš„ Copy æ€§èƒ½
///
/// # æµ‹è¯•ç›®æ ‡
///
/// æµ‹é‡ Copy trait çš„æ€§èƒ½ï¼ˆmemcpyï¼‰ã€‚
///
/// # Copy vs Clone
///
/// - **Copy**: æŒ‰ä½æ‹·è´ï¼Œéå¸¸å¿«ï¼ˆmemcpyï¼‰
/// - **Clone**: å¯èƒ½æœ‰é¢å¤–é€»è¾‘ï¼Œå¯èƒ½æ…¢
///
/// # OrderDelta çš„ Copy
///
/// OrderDelta æ˜¯ 56 å­—èŠ‚ï¼ŒCopy å°±æ˜¯æ‹·è´ 56 å­—èŠ‚ã€‚
///
/// # é¢„æœŸç»“æœ
///
/// éå¸¸å¿«ï¼Œçº¦ 3-5 nsï¼ˆå‡ ä¸ª CPU å‘¨æœŸï¼‰ã€‚
fn bench_copy_performance(c: &mut Criterion) {
    let delta = create_orderbook_delta(0);

    c.bench_function("orderbook_delta_copy", |b| {
        b.iter(|| {
            // Copy æ˜¯éšå¼çš„
            let copied = black_box(delta);
            black_box(copied);
        });
    });
}

// ============================================================================
// åŸºå‡†æµ‹è¯• 8: Clone æ€§èƒ½
// ============================================================================

/// åŸºå‡†æµ‹è¯•ï¼šOrderDelta çš„ Clone æ€§èƒ½
///
/// # æµ‹è¯•ç›®æ ‡
///
/// æµ‹é‡ Clone trait çš„æ€§èƒ½ã€‚
///
/// # å¯¹äº Copy ç±»å‹
///
/// å¦‚æœç±»å‹å®ç°äº† Copyï¼ŒClone é€šå¸¸å°±æ˜¯ Copyã€‚
///
/// # é¢„æœŸç»“æœ
///
/// åº”è¯¥å’Œ Copy æ€§èƒ½ç›¸åŒã€‚
fn bench_clone_performance(c: &mut Criterion) {
    let delta = create_orderbook_delta(0);

    c.bench_function("orderbook_delta_clone", |b| {
        b.iter(|| {
            // æ˜¾å¼è°ƒç”¨ clone()
            let cloned = black_box(delta.clone());
            black_box(cloned);
        });
    });
}

// ============================================================================
// åŸºå‡†æµ‹è¯• 9: æ‰¹é‡ Copy
// ============================================================================

/// åŸºå‡†æµ‹è¯•ï¼šæ‰¹é‡ Copy 100 ä¸ª OrderDelta
///
/// # æµ‹è¯•ç›®æ ‡
///
/// æµ‹é‡æ‰¹é‡æ‹·è´çš„æ€§èƒ½ï¼ŒéªŒè¯ç¼“å­˜æ•ˆåº”ã€‚
///
/// # ç¼“å­˜å±€éƒ¨æ€§
///
/// - **é¡ºåºè®¿é—®**: ç¼“å­˜å‹å¥½ï¼Œé¢„å–æ•ˆç‡é«˜
/// - **éšæœºè®¿é—®**: ç¼“å­˜ä¸å‹å¥½ï¼Œç¼“å­˜æœªå‘½ä¸­å¤š
///
/// # é¢„æœŸç»“æœ
///
/// çº¦ 350 nsï¼ˆæ¯ä¸ª 3.5 nsï¼‰ï¼Œå—ç¼“å­˜å½±å“ã€‚
fn bench_batch_copy(c: &mut Criterion) {
    // é¢„å…ˆåˆ›å»ºæºæ•°æ®ï¼ˆä¸è®¡å…¥æµ‹é‡æ—¶é—´ï¼‰
    let source: Vec<OrderDelta> = (0..100).map(create_orderbook_delta).collect();

    c.bench_function("batch_copy_100_orderbook_deltas", |b| {
        b.iter(|| {
            let mut dest = Vec::with_capacity(100);

            // é¡ºåºæ‹·è´
            for delta in source.iter() {
                dest.push(black_box(*delta));
            }

            black_box(dest);
        });
    });
}

// ============================================================================
// åŸºå‡†æµ‹è¯• 10: å†…å­˜å¸ƒå±€åˆ†æ
// ============================================================================

/// åŸºå‡†æµ‹è¯•ï¼šå†…å­˜å¸ƒå±€åˆ†æ - æµ‹é‡ OrderDelta çš„å¤§å°
///
/// # æµ‹è¯•ç›®æ ‡
///
/// è™½ç„¶è¿™ä¸æ˜¯çœŸæ­£çš„æ€§èƒ½æµ‹è¯•ï¼Œä½†å¯ä»¥éªŒè¯ size_of çš„å¼€é”€ã€‚
///
/// # size_of æ˜¯ç¼–è¯‘æ—¶å¸¸é‡
///
/// `std::mem::size_of::<T>()` åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šäº†ï¼Œè¿è¡Œæ—¶å¼€é”€ä¸º 0ã€‚
///
/// # é¢„æœŸç»“æœ
///
/// æå¿«ï¼Œçº¦ 0.3 psï¼ˆçš®ç§’ï¼‰ï¼ŒåŸºæœ¬æ˜¯æµ‹é‡å™ªå£°ã€‚
fn bench_memory_layout(c: &mut Criterion) {
    c.bench_function("orderbook_delta_size_of", |b| {
        b.iter(|| {
            let size = std::mem::size_of::<OrderDelta>();
            black_box(size);
        });
    });
}

// ============================================================================
// ç»„ç»‡åŸºå‡†æµ‹è¯•
// ============================================================================

/// criterion_group! å®
///
/// å°†æ‰€æœ‰åŸºå‡†æµ‹è¯•å‡½æ•°ç»„ç»‡æˆä¸€ä¸ªç»„ã€‚
///
/// # è¯­æ³•
///
/// ```rust
/// criterion_group!(
///     ç»„å,
///     æµ‹è¯•å‡½æ•°1,
///     æµ‹è¯•å‡½æ•°2,
///     ...
/// );
/// ```
criterion_group!(
    benches,
    bench_single_allocation,
    bench_vec_allocation_no_reserve,
    bench_vec_allocation_with_reserve,
    bench_vec_allocation_collect,
    bench_array_allocation,
    bench_varying_sizes,
    bench_copy_performance,
    bench_clone_performance,
    bench_batch_copy,
    bench_memory_layout,
);

/// criterion_main! å®
///
/// ç”Ÿæˆ main å‡½æ•°ï¼Œè¿è¡Œæ‰€æœ‰åŸºå‡†æµ‹è¯•ã€‚
///
/// # è¯­æ³•
///
/// ```rust
/// criterion_main!(ç»„å1, ç»„å2, ...);
/// ```
///
/// # ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
///
/// Criterion éœ€è¦ç¦ç”¨ Rust é»˜è®¤çš„ benchmark harnessï¼ˆåœ¨ Cargo.toml ä¸­è®¾ç½®
/// `harness = false`ï¼‰ï¼Œ æ‰€ä»¥éœ€è¦è‡ªå·±æä¾› main å‡½æ•°ã€‚
criterion_main!(benches);

// ============================================================================
// å­¦ä¹ æ€»ç»“
// ============================================================================

// # Criterion åŸºå‡†æµ‹è¯•å…³é”®è¦ç‚¹
//
// ## 1. å¿…é¡»ä½¿ç”¨ black_box
//
// ```rust
// âŒ é”™è¯¯
// b.iter(|| compute(42));
//
// âœ… æ­£ç¡®
// b.iter(|| {
// let result = compute(black_box(42));
// black_box(result);
// });
// ```
//
// ## 2. ç†è§£é¢„çƒ­çš„é‡è¦æ€§
//
// Criterion è‡ªåŠ¨é¢„çƒ­ 3 ç§’ï¼Œç¡®ä¿ï¼š
// - CPU ç¼“å­˜å·²åŠ è½½
// - åˆ†æ”¯é¢„æµ‹å™¨å·²è®­ç»ƒ
// - ç¨³å®šçš„æµ‹é‡ç¯å¢ƒ
//
// ## 3. å‚æ•°åŒ–æµ‹è¯•æ‰¾å‡ºæ€§èƒ½ç‰¹å¾
//
// ```rust
// for size in [10, 100, 1000, 10000].iter() {
// group.bench_with_input(BenchmarkId::from_parameter(size), size, |b, &size| {
// æµ‹è¯•ä»£ç 
// });
// }
// ```
//
// ## 4. å¯¹æ¯”å¤šä¸ªå®ç°
//
// ```rust
// group.bench_function("method_1", |b| { /* ... */ });
// group.bench_function("method_2", |b| { /* ... */ });
// group.bench_function("method_3", |b| { /* ... */ });
// ```
//
// ## 5. æŸ¥çœ‹ HTML æŠ¥å‘Š
//
// ```bash
// cargo bench
// open target/criterion/report/index.html
// ```
//
// ## 6. ä¿å­˜åŸºçº¿ç”¨äºå›å½’æ£€æµ‹
//
// ```bash
// # ä¿å­˜åŸºçº¿
// cargo bench -- --save-baseline my-baseline
//
// # å¯¹æ¯”åŸºçº¿
// cargo bench -- --baseline my-baseline
// ```
//
// ## 7. å¸¸è§é™·é˜±
//
// - å¿˜è®°ä½¿ç”¨ black_box
// - æµ‹é‡äº†ä¸è¯¥æµ‹é‡çš„ä¸œè¥¿ï¼ˆå¦‚è®¾ç½®ä»£ç ï¼‰
// - æµ‹é‡æ—¶é—´å¤ªçŸ­ï¼ˆ< 1nsï¼‰
// - ä¸ç¨³å®šçš„æµ‹é‡ç¯å¢ƒ
//
// ## 8. æœ€ä½³å®è·µ
//
// - åœ¨ç¨³å®šç¯å¢ƒä¸­è¿è¡Œï¼ˆå…³é—­åå°ç¨‹åºï¼‰
// - æµ‹è¯•å¤šä¸ªè¾“å…¥å¤§å°
// - å¯¹æ¯”å¤šä¸ªå®ç°
// - è®°å½•ä¼˜åŒ–å‰åçš„æ•°æ®
// - æŸ¥çœ‹ç”Ÿæˆçš„å›¾è¡¨å’ŒæŠ¥å‘Š
//
// # è¿›ä¸€æ­¥å­¦ä¹ 
//
// - ğŸ“š [Criterion.rs å®˜æ–¹æ–‡æ¡£](https://bheisler.github.io/criterion.rs/book/)
// - ğŸ“– [CRITERION_TUTORIAL.md](./CRITERION_TUTORIAL.md)
// - ğŸ“Š [PERFORMANCE_ANALYSIS.md](./PERFORMANCE_ANALYSIS.md)
