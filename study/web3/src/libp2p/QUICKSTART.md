# å¿«é€Ÿå…¥é—¨æŒ‡å—

5åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹ libp2p P2P Chatï¼

## ç¬¬ä¸€æ­¥ï¼šç¼–è¯‘é¡¹ç›®

```bash
cd /Users/hongyaotang/src/rustlob/study/web3

# æ£€æŸ¥ Rust ç‰ˆæœ¬ï¼ˆéœ€è¦ 1.70+ï¼‰
rustc --version

# ç¼–è¯‘é¡¹ç›®
cargo build --bin chat

# é¦–æ¬¡ç¼–è¯‘å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿä¸‹è½½ä¾èµ–
```

## ç¬¬äºŒæ­¥ï¼šå¯åŠ¨ç¬¬ä¸€ä¸ªèŠ‚ç‚¹

```bash
# å¯åŠ¨èŠ‚ç‚¹ 1
RUST_LOG=info cargo run --bin chat
```

ä½ ä¼šçœ‹åˆ°ç±»ä¼¼çš„è¾“å‡ºï¼š
```
ğŸš€ å¯åŠ¨ libp2p P2P Chat ç¨‹åº
ğŸ”‘ æœ¬åœ°èŠ‚ç‚¹ PeerID: 12D3KooWJvyMxY...
âœ… ä¼ è¾“å±‚é…ç½®å®Œæˆ: TCP + Noise + Yamux
âœ… Gossipsub åè®®é…ç½®å®Œæˆ
âœ… mDNS åè®®é…ç½®å®Œæˆ
âœ… Identify åè®®é…ç½®å®Œæˆ
âœ… Swarm åˆ›å»ºå®Œæˆ
ğŸ“¢ å·²è®¢é˜…èŠå¤©å®¤ä¸»é¢˜: chat-room
ğŸ§ å¼€å§‹ç›‘å¬ç½‘ç»œè¿æ¥...
ğŸ§ ç›‘å¬åœ°å€: /ip4/127.0.0.1/tcp/54321
ğŸŒ èŠ‚ç‚¹åœ°å€: /ip4/192.168.1.100/tcp/54321/p2p/12D3KooWJvyMxY...
ğŸ’¬ èŠå¤©å®¤å·²å‡†å¤‡å°±ç»ªï¼è¾“å…¥æ¶ˆæ¯åæŒ‰å›è½¦å‘é€
ğŸ“ æç¤ºï¼šè¾“å…¥ /quit é€€å‡ºç¨‹åº

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   æ¬¢è¿æ¥åˆ° libp2p P2P èŠå¤©å®¤ï¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨ç¬¬äºŒä¸ªèŠ‚ç‚¹

æ‰“å¼€æ–°çš„ç»ˆç«¯çª—å£ï¼š

```bash
cd /Users/hongyaotang/src/rustlob/study/web3

# å¯åŠ¨èŠ‚ç‚¹ 2
RUST_LOG=info cargo run --bin chat
```

## ç¬¬å››æ­¥ï¼šç­‰å¾…èŠ‚ç‚¹å‘ç°

ç¨ç­‰ 1-3 ç§’ï¼Œä¸¤ä¸ªèŠ‚ç‚¹ä¼šé€šè¿‡ mDNS è‡ªåŠ¨å‘ç°å½¼æ­¤ï¼š

```
ğŸ” å‘ç°æ–°èŠ‚ç‚¹: 12D3KooW... at /ip4/192.168.1.100/tcp/54321
âœ… æ–°æˆå‘˜åŠ å…¥èŠå¤©å®¤: 12D3KooW...
ğŸ”— å»ºç«‹è¿æ¥: 12D3KooW... (/ip4/192.168.1.100/tcp/54321)
```

## ç¬¬äº”æ­¥ï¼šå‘é€æ¶ˆæ¯

åœ¨ä»»ä¸€ç»ˆç«¯è¾“å…¥æ¶ˆæ¯å¹¶æŒ‰å›è½¦ï¼š

**èŠ‚ç‚¹ 1 è¾“å…¥ï¼š**
```
> Hello from Node 1!
```

**èŠ‚ç‚¹ 2 ä¼šæ”¶åˆ°ï¼š**
```
ğŸ’¬ [12D3KooW] Hello from Node 1!
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**èŠ‚ç‚¹ 2 è¾“å…¥ï¼š**
```
> Hi! I received your message!
```

**èŠ‚ç‚¹ 1 ä¼šæ”¶åˆ°ï¼š**
```
ğŸ’¬ [12D3KooW] Hi! I received your message!
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## ç¬¬å…­æ­¥ï¼šå¤šèŠ‚ç‚¹æµ‹è¯•

ç»§ç»­æ‰“å¼€ç¬¬ä¸‰ä¸ªã€ç¬¬å››ä¸ªç»ˆç«¯...æ‰€æœ‰èŠ‚ç‚¹ä¼šè‡ªåŠ¨å‘ç°å¹¶äº’ç›¸é€šä¿¡ï¼

```bash
# ç»ˆç«¯ 3
RUST_LOG=info cargo run --bin chat

# ç»ˆç«¯ 4
RUST_LOG=info cargo run --bin chat

# ç»ˆç«¯ 5
RUST_LOG=info cargo run --bin chat
```

## é€€å‡ºç¨‹åº

åœ¨ä»»ä¸€èŠ‚ç‚¹è¾“å…¥ï¼š
```
> /quit
```

---

## å¸¸è§å‘½ä»¤

è™½ç„¶å½“å‰ç‰ˆæœ¬åªæ”¯æŒåŸºæœ¬èŠå¤©ï¼Œä½†ä½ å¯ä»¥æ‰©å±•ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
/quit          # é€€å‡ºç¨‹åº
/peers         # æ˜¾ç¤ºè¿æ¥çš„èŠ‚ç‚¹ï¼ˆéœ€è¦å®ç°ï¼‰
/topics        # æ˜¾ç¤ºè®¢é˜…çš„ä¸»é¢˜ï¼ˆéœ€è¦å®ç°ï¼‰
/info          # æ˜¾ç¤ºæœ¬åœ°èŠ‚ç‚¹ä¿¡æ¯ï¼ˆéœ€è¦å®ç°ï¼‰
/help          # æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ï¼ˆéœ€è¦å®ç°ï¼‰
```

---

## è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰ libp2p æ—¥å¿—
RUST_LOG=libp2p=debug cargo run --bin chat

# åªçœ‹ Gossipsub æ—¥å¿—
RUST_LOG=libp2p_gossipsub=trace cargo run --bin chat

# å¤šä¸ªæ¨¡å—
RUST_LOG=libp2p_gossipsub=debug,libp2p_mdns=debug cargo run --bin chat
```

### 2. æµ‹è¯•è·¨æœºå™¨é€šä¿¡

å¦‚æœæœ‰å¤šå°ç”µè„‘åœ¨åŒä¸€å±€åŸŸç½‘ï¼š

**æœºå™¨ 1:**
```bash
RUST_LOG=info cargo run --bin chat
# è®°ä¸‹è¾“å‡ºçš„åœ°å€ï¼Œä¾‹å¦‚ï¼š
# /ip4/192.168.1.100/tcp/54321/p2p/12D3KooW...
```

**æœºå™¨ 2:**
```bash
# mDNS åº”è¯¥èƒ½è‡ªåŠ¨å‘ç°
RUST_LOG=info cargo run --bin chat
```

å¦‚æœ mDNS ä¸å·¥ä½œï¼Œå¯ä»¥æ‰‹åŠ¨è¿æ¥ï¼ˆéœ€è¦ä¿®æ”¹ä»£ç æ·»åŠ ï¼‰ï¼š
```rust
swarm.dial("/ip4/192.168.1.100/tcp/54321/p2p/12D3KooW...".parse()?)?;
```

### 3. ç½‘ç»œéš”ç¦»æµ‹è¯•

å¦‚æœèŠ‚ç‚¹æ— æ³•å‘ç°ï¼š

**æ£€æŸ¥é˜²ç«å¢™ï¼š**
```bash
# macOS
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate

# Linux (UFW)
sudo ufw status

# å…è®¸ç«¯å£
sudo ufw allow 54321/tcp
```

**æ£€æŸ¥ mDNSï¼š**
```bash
# macOS/Linux æ£€æŸ¥ mDNS æœåŠ¡
avahi-browse -a  # Linux
dns-sd -B _ipfs-discovery._udp  # macOS
```

---

## æ€§èƒ½æµ‹è¯•

### æµ‹è¯•æ¶ˆæ¯å»¶è¿Ÿ

1. å¯åŠ¨ 2 ä¸ªèŠ‚ç‚¹
2. åœ¨èŠ‚ç‚¹ 1 è¾“å…¥æ¶ˆæ¯å¹¶è®°å½•æ—¶é—´
3. è§‚å¯ŸèŠ‚ç‚¹ 2 æ”¶åˆ°æ¶ˆæ¯çš„æ—¶é—´
4. è®¡ç®—å»¶è¿Ÿ

**é¢„æœŸç»“æœ**ï¼š
- å±€åŸŸç½‘ï¼š< 10ms
- åŒä¸€æœºå™¨ï¼š< 5ms

### æµ‹è¯•ååé‡

å¿«é€Ÿè¿ç»­å‘é€å¤šæ¡æ¶ˆæ¯ï¼š

```bash
# èŠ‚ç‚¹ 1
for i in {1..100}; do echo "Message $i"; done
```

è§‚å¯Ÿæ‰€æœ‰èŠ‚ç‚¹æ˜¯å¦éƒ½èƒ½æ”¶åˆ°æ‰€æœ‰æ¶ˆæ¯ã€‚

---

## ä¸‹ä¸€æ­¥å®è·µ

### ç»ƒä¹  1ï¼šæ·»åŠ æ˜µç§°

ä¿®æ”¹ä»£ç ï¼Œè®©ç”¨æˆ·å¯ä»¥è®¾ç½®æ˜µç§°ï¼š

```rust
// æç¤ºï¼šåœ¨å¯åŠ¨æ—¶è¯¢é—®ç”¨æˆ·æ˜µç§°
println!("è¯·è¾“å…¥ä½ çš„æ˜µç§°ï¼š");
let mut nickname = String::new();
std::io::stdin().read_line(&mut nickname)?;

// åœ¨æ¶ˆæ¯ä¸­åŒ…å«æ˜µç§°
let msg = format!("{}: {}", nickname.trim(), line);
```

### ç»ƒä¹  2ï¼šæ·»åŠ æ—¶é—´æˆ³

åœ¨æ¯æ¡æ¶ˆæ¯å‰æ˜¾ç¤ºæ—¶é—´ï¼š

```rust
use chrono::Utc;

let timestamp = Utc::now().format("%H:%M:%S");
println!("[{}] ğŸ’¬ [{}] {}", timestamp, sender, msg_str);
```

### ç»ƒä¹  3ï¼šæ¶ˆæ¯æŒä¹…åŒ–

ä¿å­˜æ¶ˆæ¯åˆ°æ–‡ä»¶ï¼š

```rust
use std::fs::OpenOptions;
use std::io::Write;

let mut file = OpenOptions::new()
    .create(true)
    .append(true)
    .open("chat_history.txt")?;

writeln!(file, "[{}] {}: {}", timestamp, sender, message)?;
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šç¼–è¯‘å¤±è´¥

**é”™è¯¯ç¤ºä¾‹ï¼š**
```
error: failed to compile `web3` v0.1.0
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ¸…ç†å¹¶é‡æ–°ç¼–è¯‘
cargo clean
cargo build --bin chat

# æ›´æ–° Rust
rustup update
```

### é—®é¢˜ 2ï¼šèŠ‚ç‚¹æ— æ³•å‘ç°

**åŸå› ï¼š**
- ä¸åœ¨åŒä¸€ç½‘ç»œ
- é˜²ç«å¢™é˜»æ­¢
- mDNS è¢«ç¦ç”¨

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€å±€åŸŸç½‘
2. å…³é—­é˜²ç«å¢™æˆ–æ·»åŠ ä¾‹å¤–
3. æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯

### é—®é¢˜ 3ï¼šæ¶ˆæ¯å‘é€å¤±è´¥

**æ£€æŸ¥ï¼š**
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
RUST_LOG=libp2p_gossipsub=debug cargo run --bin chat
```

**å¸¸è§åŸå› ï¼š**
- æ²¡æœ‰è¿æ¥çš„å¯¹ç­‰èŠ‚ç‚¹
- ä¸»é¢˜æœªè®¢é˜…
- æ¶ˆæ¯è¿‡å¤§

---

## å‚è€ƒèµ„æ–™

- [å®Œæ•´ README](./README.md) - è¯¦ç»†çš„é¡¹ç›®æ–‡æ¡£
- [libp2p å­¦ä¹ è®¡åˆ’](../../../doc/libp2p_learning_plan.md) - ç³»ç»Ÿå­¦ä¹ è·¯å¾„
- [å®˜æ–¹æ–‡æ¡£](https://docs.libp2p.io/) - libp2p å®˜æ–¹æ–‡æ¡£

---

## è·å–å¸®åŠ©

é‡åˆ°é—®é¢˜ï¼Ÿ

1. æŸ¥çœ‹ [README.md](./README.md) çš„æ•…éšœæ’æŸ¥ç« èŠ‚
2. æ£€æŸ¥æ—¥å¿—è¾“å‡ºï¼ˆ`RUST_LOG=debug`ï¼‰
3. æœç´¢ [libp2p GitHub Issues](https://github.com/libp2p/rust-libp2p/issues)
4. åŠ å…¥ [libp2p Discord](https://discord.gg/libp2p)

---

**ç¥ä½ å­¦ä¹ æ„‰å¿«ï¼ğŸš€**
