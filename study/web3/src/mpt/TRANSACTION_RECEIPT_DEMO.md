# ä»¥å¤ªåŠäº¤æ˜“æ ‘ä¸æ”¶æ®æ ‘ - é«˜é¢‘åœºæ™¯ç¤ºä¾‹

## æ¦‚è¿°

æœ¬ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Merkle Patricia Trie (MPT) å®ç°ä»¥å¤ªåŠçš„äº¤æ˜“æ ‘å’Œæ”¶æ®æ ‘ï¼Œå¹¶åœ¨é«˜é¢‘åœºæ™¯ä¸‹è¿›è¡Œæ€§èƒ½æµ‹è¯•ã€‚

## è®¾è®¡æ¶æ„

éµå¾ª **Clean Architecture** åŸåˆ™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Presentation Layer (main.rs, example.rs)      â”‚
â”‚  - å‘½ä»¤è¡Œç•Œé¢                                     â”‚
â”‚  - æ¼”ç¤ºç¤ºä¾‹                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Use Cases Layer (usecases.rs)                 â”‚
â”‚  - InsertUseCase                                â”‚
â”‚  - GetUseCase                                   â”‚
â”‚  - RootHashUseCase                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Core Implementation (trie.rs)                  â”‚
â”‚  - MerklePatriciaTrie                           â”‚
â”‚  - é€’å½’ç®—æ³•å®ç°                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Interface Adapters (storage.rs)               â”‚
â”‚  - Storage trait                                â”‚
â”‚  - InMemoryStorage                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Entities Layer (entities.rs)                  â”‚
â”‚  - Node (Leaf/Extension/Branch)                 â”‚
â”‚  - Path                                         â”‚
â”‚  - MptError                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒåœºæ™¯

### åœºæ™¯ 1: äº¤æ˜“æ ‘ (Transaction Trie)

æ¨¡æ‹Ÿä»¥å¤ªåŠåŒºå—ä¸­çš„äº¤æ˜“æ ‘ï¼Œå±•ç¤ºé«˜é¢‘äº¤æ˜“å¤„ç†èƒ½åŠ›ã€‚

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- æ‰¹é‡æ’å…¥ 150 ç¬”äº¤æ˜“ï¼ˆæ ‡å‡†åŒºå—å¤§å°ï¼‰
- é«˜æ€§èƒ½æŸ¥è¯¢éªŒè¯
- è‡ªåŠ¨è®¡ç®—äº¤æ˜“æ ¹å“ˆå¸Œ

**æ€§èƒ½æŒ‡æ ‡ï¼š**
```
âœ“ æ’å…¥ååé‡: ~249,000 tx/s
âœ“ å¹³å‡æ’å…¥å»¶è¿Ÿ: ~4Âµs
âœ“ æŸ¥è¯¢ QPS: ~1,576,000 queries/s
âœ“ å¹³å‡æŸ¥è¯¢å»¶è¿Ÿ: ~634ns
```

### åœºæ™¯ 2: æ”¶æ®æ ‘ (Receipt Trie)

æ¨¡æ‹Ÿäº¤æ˜“æ‰§è¡Œåçš„æ”¶æ®æ ‘ï¼Œå­˜å‚¨äº¤æ˜“æ‰§è¡Œç»“æœã€‚

**æ”¶æ®ç»“æ„ï¼š**
- äº¤æ˜“å“ˆå¸Œ
- æ‰§è¡ŒçŠ¶æ€ (success/failed)
- Gas ä½¿ç”¨é‡
- ç´¯è®¡ Gas
- æ—¥å¿—æ•°é‡
- åˆçº¦åœ°å€ï¼ˆå¦‚æœæ˜¯åˆçº¦åˆ›å»ºï¼‰

**æ€§èƒ½æŒ‡æ ‡ï¼š**
```
âœ“ æ’å…¥ååé‡: ~249,000 receipt/s
âœ“ å¹³å‡æ’å…¥å»¶è¿Ÿ: ~4Âµs
```

### åœºæ™¯ 3: åŒºå—å®Œæ•´æ€§éªŒè¯

éªŒè¯äº¤æ˜“æ ‘å’Œæ”¶æ®æ ‘çš„å®Œæ•´æ€§ï¼š

```
ğŸ“‹ åŒºå—å¤´ä¿¡æ¯:
   åŒºå—å·: 18000000
   äº¤æ˜“æ•°: 150
   Gas ä½¿ç”¨: 6150000/30000000
   Gas ä½¿ç”¨ç‡: 20.5%

ğŸŒ³ Merkle æ ‘æ ¹:
   ğŸ“ äº¤æ˜“æ ¹:  be8d3d1208a653ae8403c1bc5ccb0220c41f2633...
   ğŸ“ æ”¶æ®æ ¹:  cc433e0183ce86f12d7f3589ccff46085916d64f...
```

### åœºæ™¯ 4: æ€§èƒ½ç»Ÿè®¡ä¸åˆ†æ

è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”ï¼š
- å†™å…¥æ€§èƒ½ (tx/s, receipt/s)
- è¯»å–æ€§èƒ½ (QPS, å»¶è¿Ÿ)
- å­˜å‚¨ç»Ÿè®¡

### åœºæ™¯ 5: æé™å‹åŠ›æµ‹è¯•

æµ‹è¯• 1000 ç¬”äº¤æ˜“çš„æé™æ€§èƒ½ï¼š

```
ğŸš€ æé™æ€§èƒ½æŒ‡æ ‡:
   - äº¤æ˜“æ•°: 1000
   - å³°å€¼åå: ~188,000 tx/s
   - å¹³å‡å»¶è¿Ÿ: ~5.3Âµs/tx
   - æŸ¥è¯¢ QPS: ~1,156,000 queries/s
```

## è¿è¡Œç¤ºä¾‹

### ç¼–è¯‘

```bash
cd /Users/hongyaotang/src/rustlob/study/web3
cargo build --release --bin mpt_demo
```

### è¿è¡Œ

```bash
cargo run --release --bin mpt_demo
```

## å®é™…åº”ç”¨åœºæ™¯

### 1. åŒºå—éªŒè¯å™¨
å¿«é€ŸéªŒè¯äº¤æ˜“å’Œæ”¶æ®æ ¹å“ˆå¸Œï¼Œç¡®ä¿åŒºå—æ•°æ®å®Œæ•´æ€§ã€‚

```rust
// éªŒè¯åŒºå—å¤´ä¸­çš„äº¤æ˜“æ ¹
let computed_tx_root = tx_trie.root_hash();
assert_eq!(computed_tx_root, block_header.transactions_root);
```

### 2. è½»å®¢æˆ·ç«¯
ç”Ÿæˆ Merkle è¯æ˜ï¼ŒéªŒè¯äº¤æ˜“å­˜åœ¨æ€§ï¼Œæ— éœ€ä¸‹è½½å®Œæ•´åŒºå—æ•°æ®ã€‚

```rust
// ç”Ÿæˆäº¤æ˜“å­˜åœ¨æ€§è¯æ˜
let proof = tx_trie.prove(tx_index)?;
// è½»å®¢æˆ·ç«¯éªŒè¯
assert!(proof.verify());
```

### 3. å½’æ¡£èŠ‚ç‚¹
é«˜æ•ˆå­˜å‚¨å’Œæ£€ç´¢å†å²äº¤æ˜“æ•°æ®ã€‚

```rust
// å¿«é€Ÿæ£€ç´¢å†å²äº¤æ˜“
let tx = tx_trie.get(tx_index)?;
let receipt = receipt_trie.get(tx_index)?;
```

### 4. çŠ¶æ€åŒæ­¥
æ‰¹é‡å¤„ç†åŒºå—æ•°æ®ï¼Œå®ç°å¿«é€ŸåŒæ­¥ã€‚

```rust
// æ‰¹é‡æ’å…¥äº¤æ˜“
for (index, tx) in transactions.iter().enumerate() {
    tx_trie.insert(&index.to_le_bytes(), tx.encode())?;
}
```

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. å†…å­˜ä¼˜åŒ–
- ä½¿ç”¨ `HashMap` ç¼“å­˜é¢‘ç¹è®¿é—®çš„èŠ‚ç‚¹
- èŠ‚ç‚¹å“ˆå¸Œè®¡ç®—ä½¿ç”¨ Keccak256
- Nibble è·¯å¾„å‹ç¼©å‡å°‘å­˜å‚¨ç©ºé—´

### 2. ç®—æ³•ä¼˜åŒ–
- é€’å½’æ’å…¥ç®—æ³• O(log n)
- è·¯å¾„å…¬å…±å‰ç¼€ä¼˜åŒ–
- åˆ†æ”¯èŠ‚ç‚¹æ™ºèƒ½åˆ†è£‚

### 3. å¹¶å‘ä¼˜åŒ–ï¼ˆæœªæ¥ï¼‰
- è¯»å†™åˆ†ç¦»
- æ— é”æ•°æ®ç»“æ„
- æ‰¹é‡æ“ä½œåŸå­åŒ–

## ä½å»¶è¿Ÿä¼˜åŒ–å»ºè®®

æ ¹æ®é¡¹ç›®çš„ä½å»¶è¿Ÿè¦æ±‚ï¼Œå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š

### å†…å­˜å¯¹é½
```rust
#[repr(align(64))]  // ç¼“å­˜è¡Œå¯¹é½
pub struct Node {
    // ...
}
```

### SIMD åŠ é€Ÿå“ˆå¸Œè®¡ç®—
```rust
use std::arch::x86_64::*;

// ä½¿ç”¨ AVX2/AVX-512 åŠ é€Ÿæ‰¹é‡å“ˆå¸Œè®¡ç®—
unsafe fn batch_hash_simd(nodes: &[Node]) -> Vec<[u8; 32]> {
    // SIMD å®ç°
}
```

### æ— é”å¹¶å‘
```rust
use std::sync::atomic::{AtomicPtr, Ordering};

// ä½¿ç”¨æ— é”æ•°æ®ç»“æ„å®ç°å¹¶å‘è®¿é—®
pub struct ConcurrentMPT {
    root: AtomicPtr<Node>,
}
```

## æŠ€æœ¯æ ˆ

- **è¯­è¨€**: Rust 2021 Edition
- **å“ˆå¸Œ**: sha3 (Keccak256)
- **ç¼–ç **: hex
- **å­˜å‚¨**: HashMap (å†…å­˜)
- **æ¶æ„**: Clean Architecture

## å‚è€ƒèµ„æº

- [ä»¥å¤ªåŠé»„çš®ä¹¦](https://ethereum.github.io/yellowpaper/)
- [Merkle Patricia Trie è§„èŒƒ](https://ethereum.org/en/developers/docs/data-structures-and-encoding/patricia-merkle-trie/)
- [Clean Architecture](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)

## æœªæ¥æ”¹è¿›

- [ ] å®ç°å®Œæ•´çš„ Merkle è¯æ˜ç”Ÿæˆå’ŒéªŒè¯
- [ ] æ·»åŠ æŒä¹…åŒ–å­˜å‚¨æ”¯æŒ (RocksDB, LMDB)
- [ ] æ”¯æŒå¹¶å‘è¯»å†™
- [ ] æ·»åŠ  SIMD ä¼˜åŒ–
- [ ] å®ç°ç¼“å­˜è¡Œå¯¹é½ä¼˜åŒ–
- [ ] æ”¯æŒè½»å®¢æˆ·ç«¯ Merkle è¯æ˜éªŒè¯

## License

MIT
