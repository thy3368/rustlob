# 跨境支付五级流程模型

> **文档类型**: 业务流程架构
> **版本**: v4.6
> **创建日期**: 2025-12-03
> **最后更新**: 2025-12-03
> **建模标准**: 银行业五级流程模型 (APQC/eTOM) + CQRS Command模式

---

## 1. 五级流程模型概述

```
银行业五级流程模型层次:

┌─────────────────────────────────────────────────────────────────────────────┐
│ Level 1: 价值链 (Value Chain)                                               │
│ 定义: 企业核心价值活动领域                                                    │
│ 示例: 跨境支付服务                                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ Level 2: 流程域 (Process Area)                                              │
│ 定义: 价值链下的主要业务流程领域                                              │
│ 示例: 汇出汇款、汇入汇款、换汇、清结算                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ Level 3: 流程组 (Process Group)                                             │
│ 定义: 流程域内的端到端业务流程                                                │
│ 示例: B2B付款流程、C2C汇款流程                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│ Level 4: 业务任务 (Task)                                                    │
│ 定义: 可独立执行的原子业务活动                                                │
│ 示例: 创建订单、风控审核、换汇执行                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│ Level 5: 步骤与规则 (Step & Rule)                                           │
│ 定义: 任务执行的具体步骤和业务规则                                            │
│ 示例: 校验金额 > 0、查询实时汇率、计算手续费                                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 跨境支付流程全景图

### 2.1 L1 价值链

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        L1: 跨境支付服务价值链                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         核心业务流程                                  │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │   │
│  │  │ 汇出汇款  │→│ 换汇处理  │→│ 通道路由  │→│ 清算结算  │           │   │
│  │  │ Outward   │ │ FX        │ │ Routing   │ │ Settlement│           │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         支撑业务流程                                  │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │   │
│  │  │ 客户管理  │ │ 风险管控  │ │ 合规管理  │ │ 账户管理  │           │   │
│  │  │ Customer  │ │ Risk      │ │ Compliance│ │ Account   │           │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 L2 流程域

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    L2: 流程域分解                                                │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                  核心业务流程域                                           │   │
│  ├─────────────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                         │   │
│  │  L2.1 汇出汇款域          L2.2 汇入汇款域          L2.3 换汇域          L2.4 清结算域   │   │
│  │  ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐   ┌─────────────┐ │   │
│  │  │ • B2B 贸易付款  │     │ • 收款入账      │     │ • 实时换汇      │   │ • 通道清算  │ │   │
│  │  │ • B2C 个人汇款  │     │ • 收款通知      │     │ • 远期换汇      │   │ • 内部结算  │ │   │
│  │  │ • C2C 转账      │     │ • 退汇处理      │     │ • 批量换汇      │   │ • 对账核销  │ │   │
│  │  │ • 批量付款      │     │ • 追索处理      │     │ • 头寸管理      │   │ • 差错处理  │ │   │
│  │  │ • 定期付款      │     │ • 代收代付      │     │ • 汇率管理      │   │ • 资金归集  │ │   │
│  │  └─────────────────┘     └─────────────────┘     └─────────────────┘   └─────────────┘ │   │
│  │                                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                  风控合规流程域                                           │   │
│  ├─────────────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                         │   │
│  │  L2.5 风控合规域          L2.6 争议处理域                                               │   │
│  │  ┌─────────────────┐     ┌─────────────────┐                                           │   │
│  │  │ • 交易风控      │     │ • 拒付处理      │                                           │   │
│  │  │ • AML/CFT       │     │ • 争议仲裁      │                                           │   │
│  │  │ • 制裁筛查      │     │ • 赔付管理      │                                           │   │
│  │  │ • 合规报送      │     │ • 举证调单      │                                           │   │
│  │  │ • 黑名单管理    │     │ • 申诉处理      │                                           │   │
│  │  └─────────────────┘     └─────────────────┘                                           │   │
│  │                                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                  客户商户流程域                                           │   │
│  ├─────────────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                         │   │
│  │  L2.7 商户管理域          L2.8 账户管理域                                               │   │
│  │  ┌─────────────────┐     ┌─────────────────┐                                           │   │
│  │  │ • 商户入驻      │     │ • 客户注册      │                                           │   │
│  │  │ • 合同管理      │     │ • KYC/KYB       │                                           │   │
│  │  │ • 商户分级      │     │ • 账户开立      │                                           │   │
│  │  │ • API接入       │     │ • 钱包管理      │                                           │   │
│  │  │ • 商户结算      │     │ • 余额管理      │                                           │   │
│  │  └─────────────────┘     └─────────────────┘                                           │   │
│  │                                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                  运营支撑流程域                                           │   │
│  ├─────────────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                         │   │
│  │  L2.9 通道管理域          L2.10 费用管理域        L2.11 资金管理域       L2.12 报表域   │   │
│  │  ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐   ┌─────────────┐ │   │
│  │  │ • 通道接入      │     │ • 费率配置      │     │ • 备付金监控    │   │ • 交易报表  │ │   │
│  │  │ • 通道监控      │     │ • 阶梯定价      │     │ • 资金调拨      │   │ • 财务报表  │ │   │
│  │  │ • 通道路由      │     │ • 分润结算      │     │ • 流动性预警    │   │ • 监管报表  │ │   │
│  │  │ • 限额管理      │     │ • 成本核算      │     │ • 头寸管理      │   │ • 经营分析  │ │   │
│  │  │ • 通道切换      │     │ • 账单生成      │     │ • 银行对接      │   │ • 实时大屏  │ │   │
│  │  └─────────────────┘     └─────────────────┘     └─────────────────┘   └─────────────┘ │   │
│  │                                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

**L2 流程域说明：**

| 分类 | L2 编号 | 流程域名称 | 核心职责 |
|------|---------|-----------|---------|
| 核心业务 | L2.1 | 汇出汇款域 | 跨境付款全流程，含B2B/B2C/C2C/批量 |
| 核心业务 | L2.2 | 汇入汇款域 | 跨境收款、入账、退汇、追索 |
| 核心业务 | L2.3 | 换汇域 | 汇率报价、换汇成交、头寸对冲 |
| 核心业务 | L2.4 | 清结算域 | 通道清算、对账、差错、资金归集 |
| 风控合规 | L2.5 | 风控合规域 | 交易风控、AML、制裁筛查、合规报送 |
| 风控合规 | L2.6 | 争议处理域 | 拒付、争议、赔付、举证 |
| 客户商户 | L2.7 | 商户管理域 | 商户入驻、合同、分级、API接入 |
| 客户商户 | L2.8 | 账户管理域 | 客户注册、KYC/KYB、账户钱包 |
| 运营支撑 | L2.9 | 通道管理域 | 通道接入、监控、路由、限额 |
| 运营支撑 | L2.10 | 费用管理域 | 费率、定价、分润、成本 |
| 运营支撑 | L2.11 | 资金管理域 | 备付金、流动性、资金调拨 |
| 运营支撑 | L2.12 | 报表分析域 | 交易/财务/监管报表、经营分析 |

### 2.3 L3 流程组

#### 2.3.1 L2.1 汇出汇款域 → L3 流程组

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L3.1.1 B2B贸易付款流程                                                       │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐       │
│ │创建 │──→│审核 │──→│风控 │──→│换汇 │──→│路由 │──→│出款 │──→│完成 │       │
│ │订单 │   │贸易 │   │审查 │   │处理 │   │选择 │   │执行 │   │通知 │       │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘       │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.1.2 B2C个人汇款流程                                                       │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │创建 │──→│身份 │──→│风控 │──→│换汇 │──→│出款 │──→│完成 │                 │
│ │订单 │   │验证 │   │审查 │   │处理 │   │执行 │   │通知 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.1.3 C2C转账流程                                                           │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │创建 │──→│收款 │──→│风控 │──→│换汇 │──→│即时 │──→│双向 │                 │
│ │转账 │   │人验 │   │审查 │   │处理 │   │到账 │   │通知 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.1.4 批量付款流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐       │
│ │上传 │──→│文件 │──→│批量 │──→│批量 │──→│批量 │──→│批量 │──→│汇总 │       │
│ │文件 │   │解析 │   │风控 │   │换汇 │   │路由 │   │出款 │   │报告 │       │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘       │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.1.5 定期付款流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐       │
│ │创建 │──→│定期 │──→│触发 │──→│风控 │──→│换汇 │──→│出款 │──→│周期 │       │
│ │计划 │   │调度 │   │执行 │   │审查 │   │处理 │   │执行 │   │通知 │       │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘       │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.1.6 付款取消流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │取消 │──→│状态 │──→│资金 │──→│通道 │──→│取消 │                           │
│ │请求 │   │校验 │   │解冻 │   │撤销 │   │通知 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.1.7 付款退款流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │退款 │──→│原单 │──→│退款 │──→│资金 │──→│账务 │──→│退款 │                 │
│ │申请 │   │核验 │   │审批 │   │退回 │   │冲正 │   │通知 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.1.8 汇款入金流程（充值）                                                   │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │发起 │──→│选择 │──→│调用 │──→│入金 │──→│更新 │──→│入金 │                 │
│ │入金 │   │支付 │   │收单 │   │回调 │   │余额 │   │通知 │                 │
│ │请求 │   │方式 │   │通道 │   │确认 │   │入账 │   │推送 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.3.2 L2.2 汇入汇款域 → L3 流程组

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L3.2.1 收款入账流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐       │
│ │接收 │──→│报文 │──→│风控 │──→│换汇 │──→│账户 │──→│入账 │──→│到账 │       │
│ │通知 │   │解析 │   │筛查 │   │处理 │   │匹配 │   │确认 │   │通知 │       │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘       │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.2.2 收款通知流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │入账 │──→│通知 │──→│多渠 │──→│送达 │──→│回执 │                           │
│ │触发 │   │生成 │   │下发 │   │确认 │   │记录 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.2.3 退汇处理流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │退汇 │──→│原因 │──→│账务 │──→│资金 │──→│通道 │──→│结果 │                 │
│ │触发 │   │分析 │   │冲正 │   │退回 │   │通知 │   │记录 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.2.4 追索处理流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐       │
│ │追索 │──→│原单 │──→│证据 │──→│发起 │──→│等待 │──→│结果 │──→│账务 │       │
│ │请求 │   │查询 │   │收集 │   │追索 │   │响应 │   │处理 │   │调整 │       │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘       │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.2.5 代收代付流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐       │
│ │代收 │──→│授权 │──→│风控 │──→│扣款 │──→│资金 │──→│代付 │──→│完成 │       │
│ │指令 │   │验证 │   │审查 │   │执行 │   │归集 │   │分发 │   │通知 │       │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘       │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.2.6 收款出金流程（提现）                                                   │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │发起 │──→│出金 │──→│选择 │──→│调用 │──→│扣减 │──→│出金 │                 │
│ │出金 │   │风控 │   │出金 │   │代付 │   │余额 │   │到账 │                 │
│ │请求 │   │校验 │   │银行卡│   │通道 │   │出账 │   │通知 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.3.3 L2.3 换汇域 → L3 流程组

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L3.3.1 实时换汇流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │询价 │──→│聚合 │──→│加点 │──→│锁定 │──→│成交 │──→│头寸 │                 │
│ │请求 │   │报价 │   │报价 │   │汇率 │   │确认 │   │更新 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.3.2 远期换汇流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐       │
│ │远期 │──→│期限 │──→│掉期 │──→│保证 │──→│合约 │──→│到期 │──→│交割 │       │
│ │询价 │   │定价 │   │点数 │   │金计 │   │签订 │   │提醒 │   │执行 │       │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘       │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.3.3 批量换汇流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │批量 │──→│金额 │──→│统一 │──→│拆单 │──→│批量 │──→│汇总 │                 │
│ │请求 │   │汇总 │   │询价 │   │执行 │   │成交 │   │报告 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.3.4 头寸对冲流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │头寸 │──→│阈值 │──→│对冲 │──→│询价 │──→│执行 │──→│头寸 │                 │
│ │监控 │   │触发 │   │决策 │   │下单 │   │成交 │   │更新 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.3.5 日终轧平流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │日终 │──→│头寸 │──→│轧平 │──→│执行 │──→│盈亏 │──→│报表 │                 │
│ │触发 │   │汇总 │   │决策 │   │交易 │   │计算 │   │生成 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.3.6 汇率管理流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │汇率 │──→│异常 │──→│人工 │──→│汇率 │──→│生效 │                           │
│ │订阅 │   │监控 │   │干预 │   │更新 │   │通知 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.3.4 L2.4 清结算域 → L3 流程组

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L3.4.1 日终清算流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐       │
│ │日切 │──→│交易 │──→│轧差 │──→│生成 │──→│发送 │──→│接收 │──→│清算 │       │
│ │触发 │   │汇总 │   │计算 │   │文件 │   │指令 │   │结果 │   │确认 │       │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘       │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.4.2 实时清算流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │交易 │──→│即时 │──→│发送 │──→│等待 │──→│状态 │                           │
│ │完成 │   │封装 │   │清算 │   │确认 │   │更新 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.4.3 对账流程                                                              │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │获取 │──→│解析 │──→│数据 │──→│自动 │──→│差异 │──→│对账 │                 │
│ │对账单│   │文件 │   │加载 │   │匹配 │   │标记 │   │报告 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.4.4 差错处理流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │差异 │──→│原因 │──→│处理 │──→│调账 │──→│审批 │──→│结案 │                 │
│ │发现 │   │分析 │   │方案 │   │执行 │   │确认 │   │归档 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.4.5 资金归集流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │余额 │──→│归集 │──→│生成 │──→│发起 │──→│到账 │──→│余额 │                 │
│ │监控 │   │决策 │   │指令 │   │划拨 │   │确认 │   │更新 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.3.5 L2.5 风控合规域 → L3 流程组

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L3.5.1 交易风控流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │交易 │──→│规则 │──→│模型 │──→│风险 │──→│决策 │──→│结果 │                 │
│ │触发 │   │匹配 │   │评分 │   │定级 │   │输出 │   │记录 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.5.2 AML检测流程                                                           │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐       │
│ │交易 │──→│行为 │──→│模式 │──→│可疑 │──→│案件 │──→│SAR  │──→│监管 │       │
│ │监控 │   │分析 │   │识别 │   │标记 │   │调查 │   │生成 │   │报送 │       │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘       │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.5.3 制裁筛查流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │提取 │──→│名单 │──→│模糊 │──→│命中 │──→│人工 │──→│处置 │                 │
│ │实体 │   │比对 │   │匹配 │   │标记 │   │复核 │   │决策 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.5.4 合规报送流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │数据 │──→│报表 │──→│合规 │──→│格式 │──→│加密 │──→│报送 │                 │
│ │抽取 │   │生成 │   │审核 │   │转换 │   │签名 │   │确认 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.5.5 人工审核流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │任务 │──→│案件 │──→│证据 │──→│审核 │──→│决策 │──→│结果 │                 │
│ │分配 │   │加载 │   │收集 │   │分析 │   │记录 │   │流转 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.5.6 黑名单管理流程                                                        │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │名单 │──→│审核 │──→│名单 │──→│生效 │──→│通知 │                           │
│ │申请 │   │确认 │   │更新 │   │同步 │   │下发 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.3.6 L2.6 争议处理域 → L3 流程组

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L3.6.1 拒付处理流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐       │
│ │拒付 │──→│原单 │──→│原因 │──→│举证 │──→│提交 │──→│仲裁 │──→│结果 │       │
│ │通知 │   │查询 │   │分析 │   │准备 │   │抗辩 │   │等待 │   │执行 │       │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘       │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.6.2 争议仲裁流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │争议 │──→│证据 │──→│仲裁 │──→│听证 │──→│裁决 │──→│执行 │                 │
│ │受理 │   │交换 │   │申请 │   │安排 │   │结果 │   │落实 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.6.3 赔付管理流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │赔付 │──→│责任 │──→│金额 │──→│审批 │──→│资金 │──→│结案 │                 │
│ │申请 │   │认定 │   │核算 │   │流程 │   │划付 │   │归档 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.6.4 举证调单流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │调单 │──→│资料 │──→│证据 │──→│材料 │──→│提交 │                           │
│ │请求 │   │收集 │   │整理 │   │封装 │   │归档 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.6.5 客户申诉流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │申诉 │──→│工单 │──→│调查 │──→│处理 │──→│回复 │──→│满意 │                 │
│ │受理 │   │创建 │   │核实 │   │方案 │   │客户 │   │回访 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.3.7 L2.7 商户管理域 → L3 流程组

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L3.7.1 商户入驻流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐       │
│ │入驻 │──→│资料 │──→│KYB  │──→│资质 │──→│合同 │──→│账户 │──→│入驻 │       │
│ │申请 │   │提交 │   │审核 │   │审批 │   │签署 │   │开通 │   │完成 │       │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘       │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.7.2 合同管理流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │合同 │──→│条款 │──→│法务 │──→│双方 │──→│合同 │──→│到期 │                 │
│ │起草 │   │协商 │   │审核 │   │签署 │   │归档 │   │提醒 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.7.3 商户分级流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │交易 │──→│指标 │──→│等级 │──→│权益 │──→│通知 │                           │
│ │统计 │   │评估 │   │调整 │   │更新 │   │商户 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.7.4 API接入流程                                                           │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │接入 │──→│密钥 │──→│沙箱 │──→│联调 │──→│验收 │──→│上线 │                 │
│ │申请 │   │分配 │   │测试 │   │对接 │   │测试 │   │开通 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.7.5 商户结算流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │结算 │──→│交易 │──→│费用 │──→│净额 │──→│打款 │──→│结算 │                 │
│ │触发 │   │汇总 │   │扣除 │   │计算 │   │执行 │   │对账 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.3.8 L2.8 账户管理域 → L3 流程组

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L3.8.1 客户注册流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │注册 │──→│信息 │──→│验证 │──→│协议 │──→│创建 │──→│欢迎 │                 │
│ │申请 │   │填写 │   │码验 │   │同意 │   │账户 │   │引导 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.8.2 KYC/KYB认证流程                                                       │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐       │
│ │发起 │──→│资料 │──→│OCR  │──→│活体 │──→│人工 │──→│结果 │──→│权限 │       │
│ │认证 │   │上传 │   │识别 │   │检测 │   │复核 │   │判定 │   │开通 │       │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘       │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.8.3 账户开立流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │开户 │──→│类型 │──→│创建 │──→│初始 │──→│开户 │                           │
│ │申请 │   │选择 │   │账户 │   │钱包 │   │完成 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.8.4 钱包管理流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │创建 │──→│币种 │──→│钱包 │──→│限额 │──→│激活 │                           │
│ │钱包 │   │选择 │   │生成 │   │配置 │   │完成 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.8.5 余额管理流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │余额 │──→│变动 │──→│记账 │──→│余额 │──→│通知 │                           │
│ │操作 │   │校验 │   │处理 │   │更新 │   │触发 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.8.6 绑卡管理流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │发起 │──→│银行卡│──→│短信 │──→│协议 │──→│绑卡 │──→│绑卡 │                 │
│ │绑卡 │   │要素 │   │验证码│   │签约 │   │信息 │   │完成 │                 │
│ │请求 │   │验证 │   │校验 │   │确认 │   │存储 │   │通知 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.3.9 L2.9 通道管理域 → L3 流程组

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L3.9.1 通道接入流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐       │
│ │通道 │──→│合同 │──→│技术 │──→│沙箱 │──→│联调 │──→│验收 │──→│上线 │       │
│ │评估 │   │签署 │   │对接 │   │测试 │   │调试 │   │测试 │   │发布 │       │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘       │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.9.2 通道监控流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │实时 │──→│指标 │──→│异常 │──→│告警 │──→│通知 │──→│处置 │                 │
│ │采集 │   │计算 │   │检测 │   │触发 │   │下发 │   │跟进 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.9.3 智能路由流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │交易 │──→│规则 │──→│评分 │──→│通道 │──→│执行 │                           │
│ │请求 │   │匹配 │   │排序 │   │选择 │   │路由 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.9.4 限额管理流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │限额 │──→│审批 │──→│配置 │──→│生效 │──→│监控 │                           │
│ │申请 │   │流程 │   │更新 │   │通知 │   │预警 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.9.5 通道切换流程                                                          │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │故障 │──→│切换 │──→│流量 │──→│备用 │──→│监控 │──→│恢复 │                 │
│ │检测 │   │决策 │   │迁移 │   │接管 │   │验证 │   │回切 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.3.10 L2.10 费用管理域 → L3 流程组

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L3.10.1 费率配置流程                                                         │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │费率 │──→│审批 │──→│配置 │──→│生效 │──→│通知 │                           │
│ │申请 │   │流程 │   │录入 │   │发布 │   │商户 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.10.2 阶梯定价流程                                                         │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │交易 │──→│累计 │──→│阶梯 │──→│费率 │──→│费用 │──→│账单 │                 │
│ │完成 │   │统计 │   │匹配 │   │适用 │   │计算 │   │生成 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.10.3 分润结算流程                                                         │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │收入 │──→│分润 │──→│金额 │──→│审核 │──→│打款 │──→│对账 │                 │
│ │统计 │   │比例 │   │计算 │   │确认 │   │执行 │   │确认 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.10.4 成本核算流程                                                         │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │成本 │──→│分摊 │──→│利润 │──→│报表 │──→│分析 │                           │
│ │归集 │   │计算 │   │核算 │   │生成 │   │输出 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.10.5 账单生成流程                                                         │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │周期 │──→│费用 │──→│账单 │──→│审核 │──→│发送 │──→│催收 │                 │
│ │触发 │   │汇总 │   │生成 │   │确认 │   │商户 │   │跟进 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.3.11 L2.11 资金管理域 → L3 流程组

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L3.11.1 备付金监控流程                                                       │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │余额 │──→│阈值 │──→│预警 │──→│通知 │──→│处置 │                           │
│ │采集 │   │比对 │   │触发 │   │下发 │   │跟进 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.11.2 资金调拨流程                                                         │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │调拨 │──→│审批 │──→│生成 │──→│发起 │──→│到账 │──→│确认 │                 │
│ │申请 │   │流程 │   │指令 │   │划拨 │   │确认 │   │记录 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.11.3 流动性预警流程                                                       │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │流量 │──→│预测 │──→│缺口 │──→│预警 │──→│筹资 │──→│补充 │                 │
│ │分析 │   │模型 │   │识别 │   │触发 │   │决策 │   │执行 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.11.4 头寸管理流程                                                         │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │头寸 │──→│限额 │──→│超限 │──→│调整 │──→│平衡 │                           │
│ │统计 │   │校验 │   │预警 │   │执行 │   │确认 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.11.5 银行对接流程                                                         │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │开户 │──→│签约 │──→│渠道 │──→│对账 │──→│回单 │──→│归档 │                 │
│ │申请 │   │授权 │   │对接 │   │配置 │   │获取 │   │管理 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.3.12 L2.12 报表分析域 → L3 流程组

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L3.12.1 交易报表流程                                                         │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │数据 │──→│指标 │──→│报表 │──→│格式 │──→│分发 │                           │
│ │抽取 │   │计算 │   │生成 │   │导出 │   │推送 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.12.2 财务报表流程                                                         │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │账务 │──→│科目 │──→│试算 │──→│报表 │──→│审计 │──→│归档 │                 │
│ │汇总 │   │核对 │   │平衡 │   │生成 │   │复核 │   │存档 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.12.3 监管报表流程                                                         │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                 │
│ │数据 │──→│口径 │──→│报表 │──→│合规 │──→│加密 │──→│报送 │                 │
│ │准备 │   │调整 │   │填报 │   │审核 │   │签名 │   │确认 │                 │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.12.4 经营分析流程                                                         │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │数据 │──→│多维 │──→│趋势 │──→│洞察 │──→│报告 │                           │
│ │建模 │   │分析 │   │预测 │   │提炼 │   │输出 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
├─────────────────────────────────────────────────────────────────────────────┤
│ L3.12.5 实时大屏流程                                                         │
│ ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐                           │
│ │实时 │──→│指标 │──→│可视 │──→│大屏 │──→│异常 │                           │
│ │采集 │   │聚合 │   │渲染 │   │展示 │   │高亮 │                           │
│ └─────┘   └─────┘   └─────┘   └─────┘   └─────┘                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. L4 业务任务与Command映射

### 3.1 客户触发的 L4 任务总览

以下L4任务由客户（个人/商户）直接触发，是系统的主要入口点：

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              客户触发的 L4 任务清单                                               │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.1 汇出汇款域 - 客户触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.1.1.1 创建付款订单│ CreatePaymentOrderCommand    │ 企业/个人客户 │ 发起跨境付款      │   │
│  │ L4.1.1.2 确认换汇报价│ ConfirmFxQuoteCommand        │ 企业/个人客户 │ 锁定汇率          │   │
│  │ L4.1.1.3 添加收款人  │ AddBeneficiaryCommand        │ 企业/个人客户 │ 添加常用收款人    │   │
│  │ L4.1.1.4 编辑收款人  │ UpdateBeneficiaryCommand     │ 企业/个人客户 │ 修改收款人信息    │   │
│  │ L4.1.1.5 删除收款人  │ RemoveBeneficiaryCommand     │ 企业/个人客户 │ 删除收款人        │   │
│  │ L4.1.4.1 上传批量文件│ UploadBatchFileCommand       │ 企业客户      │ 批量付款文件上传  │   │
│  │ L4.1.4.2 确认批量付款│ ConfirmBatchPaymentCommand   │ 企业客户      │ 确认批量付款      │   │
│  │ L4.1.6.1 取消付款申请│ CancelPaymentCommand         │ 企业/个人客户 │ 取消未完成订单    │   │
│  │ L4.1.7.1 申请退款    │ RequestRefundCommand         │ 企业/个人客户 │ 申请付款退款      │   │
│  │ L4.1.8.1 发起入金    │ InitiateDepositCommand       │ 企业/个人客户 │ 充值到平台账户    │   │
│  │ L4.1.8.2 选择支付方式│ SelectPaymentMethodCommand   │ 企业/个人客户 │ 选择绑定卡/网银   │   │
│  │ L4.1.8.3 确认入金    │ ConfirmDepositCommand        │ 企业/个人客户 │ 确认充值金额      │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.2 汇入汇款域 - 客户触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.2.6.1 发起出金    │ InitiateWithdrawCommand      │ 企业/个人客户 │ 提现到银行卡      │   │
│  │ L4.2.6.2 选择出金银行│ SelectWithdrawBankCommand    │ 企业/个人客户 │ 选择提现目标卡    │   │
│  │ L4.2.6.3 确认出金    │ ConfirmWithdrawCommand       │ 企业/个人客户 │ 确认提现金额      │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.3 换汇域 - 客户触发任务                                   │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.3.1.1 获取汇率报价│ RequestFxQuoteCommand        │ 企业/个人客户 │ 主动询价          │   │
│  │ L4.3.1.2 锁定汇率    │ LockFxRateCommand            │ 企业/个人客户 │ 锁定报价30秒      │   │
│  │ L4.3.1.3 确认换汇    │ ConfirmFxDealCommand         │ 企业/个人客户 │ 确认换汇成交      │   │
│  │ L4.3.2.1 创建远期合约│ CreateForwardContractCommand │ 企业客户      │ 远期换汇预约      │   │
│  │ L4.3.2.2 取消远期合约│ CancelForwardContractCommand │ 企业客户      │ 取消远期合约      │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.6 争议处理域 - 客户触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.6.5.1 提交申诉    │ SubmitComplaintCommand       │ 企业/个人客户 │ 发起交易申诉      │   │
│  │ L4.6.5.2 补充材料    │ SubmitEvidenceCommand        │ 企业/个人客户 │ 补充举证材料      │   │
│  │ L4.6.5.3 撤回申诉    │ WithdrawComplaintCommand     │ 企业/个人客户 │ 撤回申诉请求      │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.7 商户管理域 - 商户触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.7.1.1 提交入驻申请│ SubmitMerchantAppCommand     │ 商户          │ 申请成为商户      │   │
│  │ L4.7.1.2 补充资质材料│ SubmitQualificationCommand   │ 商户          │ 补充企业资质      │   │
│  │ L4.7.2.1 签署合同    │ SignContractCommand          │ 商户          │ 电子签约          │   │
│  │ L4.7.4.1 申请API接入 │ ApplyApiAccessCommand        │ 商户          │ 申请API密钥       │   │
│  │ L4.7.4.2 重置密钥    │ ResetApiKeyCommand           │ 商户          │ 重置API密钥       │   │
│  │ L4.7.4.3 配置回调地址│ ConfigureWebhookCommand      │ 商户          │ 设置Webhook       │   │
│  │ L4.7.4.4 配置IP白名单│ ConfigureIpWhitelistCommand  │ 商户          │ API安全配置       │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.8 账户管理域 - 客户触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.8.1.1 提交注册申请│ SubmitRegistrationCommand    │ 企业/个人客户 │ 注册账户          │   │
│  │ L4.8.1.2 验证手机/邮箱│ VerifyContactCommand         │ 企业/个人客户 │ 验证联系方式      │   │
│  │ L4.8.1.3 设置登录密码│ SetPasswordCommand           │ 企业/个人客户 │ 首次设置密码      │   │
│  │ L4.8.2.1 提交KYC资料 │ SubmitKycDocumentsCommand    │ 个人客户      │ 个人身份认证      │   │
│  │ L4.8.2.2 提交KYB资料 │ SubmitKybDocumentsCommand    │ 企业客户      │ 企业资质认证      │   │
│  │ L4.8.2.3 补充认证材料│ SubmitAdditionalDocsCommand  │ 企业/个人客户 │ 补充KYC/KYB材料   │   │
│  │ L4.8.3.1 申请开户    │ ApplyAccountOpeningCommand   │ 企业/个人客户 │ 开立主账户        │   │
│  │ L4.8.4.1 创建钱包    │ CreateWalletCommand          │ 企业/个人客户 │ 创建多币种钱包    │   │
│  │ L4.8.5.1 修改登录密码│ ChangePasswordCommand        │ 企业/个人客户 │ 修改登录密码      │   │
│  │ L4.8.5.2 设置支付密码│ SetPaymentPinCommand         │ 企业/个人客户 │ 首次设置支付密码  │   │
│  │ L4.8.5.3 修改支付密码│ ChangePaymentPinCommand      │ 企业/个人客户 │ 修改支付密码      │   │
│  │ L4.8.5.4 重置密码    │ ResetPasswordCommand         │ 企业/个人客户 │ 忘记密码重置      │   │
│  │ L4.8.5.5 绑定MFA设备 │ BindMfaDeviceCommand         │ 企业/个人客户 │ 绑定二次验证      │   │
│  │ L4.8.5.6 解绑MFA设备 │ UnbindMfaDeviceCommand       │ 企业/个人客户 │ 解除二次验证      │   │
│  │ L4.8.5.7 设置通知偏好│ SetNotificationPrefCommand   │ 企业/个人客户 │ 通知方式设置      │   │
│  │ L4.8.6.1 发起绑卡    │ InitiateBindCardCommand      │ 企业/个人客户 │ 绑定银行卡        │   │
│  │ L4.8.6.2 验证绑卡短信│ VerifyBindCardSmsCommand     │ 企业/个人客户 │ 短信验证码确认    │   │
│  │ L4.8.6.3 解绑银行卡  │ UnbindCardCommand            │ 企业/个人客户 │ 解除银行卡绑定    │   │
│  │ L4.8.6.4 设为默认卡  │ SetDefaultCardCommand        │ 企业/个人客户 │ 设置默认银行卡    │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.10 费用管理域 - 客户触发任务                              │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.10.1.1 申请开票   │ RequestInvoiceCommand        │ 企业客户      │ 申请开具发票      │   │
│  │ L4.10.1.2 修改开票信息│ UpdateInvoiceInfoCommand     │ 企业客户      │ 修改发票抬头等    │   │
│  │ L4.10.1.3 下载电子发票│ DownloadInvoiceCommand       │ 企业客户      │ 下载已开发票      │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.12 报表分析域 - 客户触发任务                              │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.12.1.1 导出交易报表│ ExportTransactionReportCmd   │ 企业/个人客户 │ 导出交易明细      │   │
│  │ L4.12.1.2 订阅定期报表│ SubscribeReportCommand       │ 企业客户      │ 订阅周报/月报     │   │
│  │ L4.12.1.3 取消报表订阅│ UnsubscribeReportCommand     │ 企业客户      │ 取消报表订阅      │   │
│  │ L4.12.1.4 自定义报表  │ CustomizeReportCommand       │ 企业客户      │ 自定义报表模板    │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              客户触发的 Query（只读查询）                                 │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ Query                │ 接口                         │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ 查询账户余额         │ QueryBalanceQuery            │ 企业/个人客户 │ 各币种余额        │   │
│  │ 查询交易记录         │ QueryTransactionHistoryQuery │ 企业/个人客户 │ 交易流水          │   │
│  │ 查询付款状态         │ QueryPaymentStatusQuery      │ 企业/个人客户 │ 单笔付款状态      │   │
│  │ 查询收款记录         │ QueryReceiptHistoryQuery     │ 企业/个人客户 │ 收款流水          │   │
│  │ 查询汇率             │ QueryFxRateQuery             │ 企业/个人客户 │ 实时汇率          │   │
│  │ 查询汇率历史         │ QueryFxHistoryQuery          │ 企业/个人客户 │ 历史汇率          │   │
│  │ 查询收款人列表       │ QueryBeneficiaryListQuery    │ 企业/个人客户 │ 常用收款人        │   │
│  │ 查询绑定银行卡       │ QueryBoundCardsQuery         │ 企业/个人客户 │ 已绑银行卡        │   │
│  │ 查询申诉进度         │ QueryComplaintStatusQuery    │ 企业/个人客户 │ 申诉处理状态      │   │
│  │ 下载交易对账单       │ DownloadStatementQuery       │ 企业/个人客户 │ 对账单PDF/Excel   │   │
│  │ 查询API调用记录      │ QueryApiLogsQuery            │ 商户          │ API调用日志       │   │
│  │ 查询结算记录         │ QuerySettlementHistoryQuery  │ 商户          │ 商户结算流水      │   │
│  │ 查询费用明细         │ QueryFeeDetailQuery          │ 企业/个人客户 │ 各项费用明细      │   │
│  │ 查询发票列表         │ QueryInvoiceListQuery        │ 企业客户      │ 已开发票列表      │   │
│  │ 查询报表订阅         │ QueryReportSubscriptionQuery │ 企业客户      │ 订阅状态          │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 运营触发的 L4 任务总览

以下L4任务由运营人员（客服、风控、合规、财务、技术运维）触发：

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              运营触发的 L4 任务清单                                               │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.1 汇出汇款域 - 运营触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.1.x.1 人工审核通过│ ApprovePaymentCommand        │ 合规审核员    │ 审核通过付款      │   │
│  │ L4.1.x.2 人工审核拒绝│ RejectPaymentCommand         │ 合规审核员    │ 拒绝付款申请      │   │
│  │ L4.1.x.3 补录贸易背景│ SupplementTradeDocsCommand   │ 客服          │ 协助补充材料      │   │
│  │ L4.1.x.4 强制取消订单│ ForceCancelPaymentCommand    │ 运营主管      │ 强制取消问题订单  │   │
│  │ L4.1.x.5 手动重试出款│ RetryPaymentCommand          │ 技术运维      │ 重试失败的出款    │   │
│  │ L4.1.x.6 手动确认到账│ ManualConfirmArrivalCommand  │ 财务          │ 手动确认到账状态  │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.2 汇入汇款域 - 运营触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.2.x.1 手动入账    │ ManualCreditCommand          │ 财务          │ 手动入账到客户    │   │
│  │ L4.2.x.2 发起退汇    │ InitiateReturnCommand        │ 客服/合规     │ 发起退汇流程      │   │
│  │ L4.2.x.3 处理追索    │ ProcessRecallCommand         │ 合规          │ 处理追索请求      │   │
│  │ L4.2.x.4 审批出金    │ ApproveWithdrawCommand       │ 财务主管      │ 大额出金审批      │   │
│  │ L4.2.x.5 拒绝出金    │ RejectWithdrawCommand        │ 风控/财务     │ 拒绝出金申请      │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.3 换汇域 - 运营触发任务                                   │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.3.x.1 配置汇率加点│ ConfigureFxSpreadCommand     │ 财务/产品     │ 设置客户加点      │   │
│  │ L4.3.x.2 设置汇率上下限│ SetFxRateLimitCommand       │ 风控          │ 汇率波动限制      │   │
│  │ L4.3.x.3 手动调整汇率│ ManualAdjustFxRateCommand    │ 财务主管      │ 特殊汇率调整      │   │
│  │ L4.3.x.4 触发头寸对冲│ TriggerHedgeCommand          │ 财务/系统     │ 手动触发对冲      │   │
│  │ L4.3.x.5 配置对冲阈值│ ConfigureHedgeThresholdCmd   │ 风控          │ 设置对冲触发条件  │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.4 清结算域 - 运营触发任务                                 │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.4.x.1 发起手动清算│ TriggerManualSettlementCmd   │ 财务          │ 手动触发清算      │   │
│  │ L4.4.x.2 处理对账差异│ HandleReconcileDiffCommand   │ 财务          │ 处理对账不平      │   │
│  │ L4.4.x.3 调账处理    │ AdjustAccountCommand         │ 财务主管      │ 账务调整          │   │
│  │ L4.4.x.4 确认清算结果│ ConfirmSettlementCommand     │ 财务          │ 确认清算完成      │   │
│  │ L4.4.x.5 重新发起对账│ RetryReconciliationCommand   │ 技术运维      │ 重试失败的对账    │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.5 风控合规域 - 运营触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.5.x.1 人工风控审核│ ManualRiskReviewCommand      │ 风控专员      │ 人工风控审核      │   │
│  │ L4.5.x.2 加入黑名单  │ AddToBlacklistCommand        │ 风控/合规     │ 添加黑名单        │   │
│  │ L4.5.x.3 移出黑名单  │ RemoveFromBlacklistCommand   │ 风控主管      │ 移除黑名单        │   │
│  │ L4.5.x.4 调整风控规则│ UpdateRiskRuleCommand        │ 风控          │ 修改风控规则      │   │
│  │ L4.5.x.5 冻结账户    │ FreezeAccountCommand         │ 风控/合规     │ 冻结可疑账户      │   │
│  │ L4.5.x.6 解冻账户    │ UnfreezeAccountCommand       │ 风控主管      │ 解除账户冻结      │   │
│  │ L4.5.x.7 提交SAR报告 │ SubmitSarReportCommand       │ 合规          │ 可疑活动报告      │   │
│  │ L4.5.x.8 更新制裁名单│ UpdateSanctionListCommand    │ 合规          │ 更新制裁筛查库    │   │
│  │ L4.5.x.9 配置AML规则 │ ConfigureAmlRuleCommand      │ 合规          │ 配置AML检测规则   │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.6 争议处理域 - 运营触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.6.x.1 受理拒付    │ AcceptChargebackCommand      │ 客服          │ 受理拒付请求      │   │
│  │ L4.6.x.2 拒付申诉    │ DisputeChargebackCommand     │ 客服/合规     │ 对拒付进行申诉    │   │
│  │ L4.6.x.3 分配申诉工单│ AssignComplaintCommand       │ 客服主管      │ 分配处理人        │   │
│  │ L4.6.x.4 处理申诉    │ ProcessComplaintCommand      │ 客服          │ 处理客户申诉      │   │
│  │ L4.6.x.5 申诉结案    │ CloseComplaintCommand        │ 客服          │ 关闭申诉工单      │   │
│  │ L4.6.x.6 发起赔付    │ InitiateCompensationCommand  │ 客服主管      │ 发起客户赔付      │   │
│  │ L4.6.x.7 审批赔付    │ ApproveCompensationCommand   │ 财务主管      │ 审批赔付金额      │   │
│  │ L4.6.x.8 请求调单    │ RequestRetrievalCommand      │ 客服          │ 向通道请求调单    │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.7 商户管理域 - 运营触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.7.x.1 审核商户入驻│ ReviewMerchantAppCommand     │ 商务/合规     │ 审核入驻申请      │   │
│  │ L4.7.x.2 批准商户入驻│ ApproveMerchantCommand       │ 商务主管      │ 批准入驻          │   │
│  │ L4.7.x.3 拒绝商户入驻│ RejectMerchantCommand        │ 商务/合规     │ 拒绝入驻申请      │   │
│  │ L4.7.x.4 调整商户等级│ AdjustMerchantTierCommand    │ 商务          │ 调整商户分级      │   │
│  │ L4.7.x.5 配置商户费率│ ConfigureMerchantFeeCommand  │ 商务/财务     │ 设置商户费率      │   │
│  │ L4.7.x.6 暂停商户服务│ SuspendMerchantCommand       │ 风控/商务     │ 暂停商户          │   │
│  │ L4.7.x.7 恢复商户服务│ ResumeMerchantCommand        │ 商务主管      │ 恢复商户          │   │
│  │ L4.7.x.8 终止商户合作│ TerminateMerchantCommand     │ 商务主管/法务 │ 终止合作          │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.8 账户管理域 - 运营触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.8.x.1 审核KYC资料 │ ReviewKycCommand             │ 合规          │ 审核个人认证      │   │
│  │ L4.8.x.2 审核KYB资料 │ ReviewKybCommand             │ 合规          │ 审核企业认证      │   │
│  │ L4.8.x.3 通过认证    │ ApproveKycKybCommand         │ 合规          │ 通过认证审核      │   │
│  │ L4.8.x.4 拒绝认证    │ RejectKycKybCommand          │ 合规          │ 拒绝认证申请      │   │
│  │ L4.8.x.5 要求补充材料│ RequestAdditionalDocsCommand │ 合规          │ 要求补充材料      │   │
│  │ L4.8.x.6 手动重置密码│ AdminResetPasswordCommand    │ 客服主管      │ 管理员重置密码    │   │
│  │ L4.8.x.7 手动解绑MFA │ AdminUnbindMfaCommand        │ 客服主管      │ 管理员解绑MFA     │   │
│  │ L4.8.x.8 关闭账户    │ CloseAccountCommand          │ 合规/客服     │ 关闭客户账户      │   │
│  │ L4.8.x.9 调整账户限额│ AdjustAccountLimitCommand    │ 风控/商务     │ 调整交易限额      │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.9 通道管理域 - 运营触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.9.x.1 添加新通道  │ AddChannelCommand            │ 技术/商务     │ 接入新通道        │   │
│  │ L4.9.x.2 配置通道参数│ ConfigureChannelCommand      │ 技术运维      │ 配置通道参数      │   │
│  │ L4.9.x.3 启用通道    │ EnableChannelCommand         │ 技术运维      │ 上线通道          │   │
│  │ L4.9.x.4 禁用通道    │ DisableChannelCommand        │ 技术运维      │ 下线通道          │   │
│  │ L4.9.x.5 配置路由规则│ ConfigureRoutingRuleCommand  │ 产品/技术     │ 设置路由策略      │   │
│  │ L4.9.x.6 调整通道权重│ AdjustChannelWeightCommand   │ 运营          │ 调整通道分流      │   │
│  │ L4.9.x.7 设置通道限额│ SetChannelLimitCommand       │ 风控/财务     │ 设置通道限额      │   │
│  │ L4.9.x.8 通道切换    │ SwitchChannelCommand         │ 技术运维      │ 紧急通道切换      │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.10 费用管理域 - 运营触发任务                              │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.10.x.1 配置基础费率│ ConfigureBaseFeeCommand      │ 产品/财务     │ 设置基础费率      │   │
│  │ L4.10.x.2 配置阶梯费率│ ConfigureTieredFeeCommand    │ 产品/财务     │ 设置阶梯定价      │   │
│  │ L4.10.x.3 设置特殊费率│ SetSpecialFeeCommand         │ 商务          │ 特殊客户费率      │   │
│  │ L4.10.x.4 配置分润规则│ ConfigureSharingRuleCommand  │ 财务          │ 设置分润比例      │   │
│  │ L4.10.x.5 执行分润结算│ ExecuteSharingSettleCommand  │ 财务          │ 执行分润结算      │   │
│  │ L4.10.x.6 费用减免    │ WaiveFeeCommand              │ 客服主管      │ 减免客户费用      │   │
│  │ L4.10.x.7 生成账单    │ GenerateInvoiceCommand       │ 财务          │ 生成客户账单      │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.11 资金管理域 - 运营触发任务                              │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.11.x.1 发起资金调拨│ InitiateFundTransferCommand  │ 财务          │ 内部资金调拨      │   │
│  │ L4.11.x.2 审批资金调拨│ ApproveFundTransferCommand   │ 财务主管      │ 审批调拨申请      │   │
│  │ L4.11.x.3 设置预警阈值│ SetAlertThresholdCommand     │ 财务/风控     │ 资金预警阈值      │   │
│  │ L4.11.x.4 处理预警    │ HandleFundAlertCommand       │ 财务          │ 处理资金预警      │   │
│  │ L4.11.x.5 备付金充值  │ TopUpReserveCommand          │ 财务          │ 备付金账户充值    │   │
│  │ L4.11.x.6 备付金提取  │ WithdrawReserveCommand       │ 财务主管      │ 备付金提取        │   │
│  │ L4.11.x.7 配置银行账户│ ConfigureBankAccountCommand  │ 财务          │ 配置银行对接      │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.12 报表分析域 - 运营触发任务                              │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发者        │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.12.x.1 生成交易报表│ GenerateTxReportCommand      │ 运营/财务     │ 生成交易统计      │   │
│  │ L4.12.x.2 生成财务报表│ GenerateFinReportCommand     │ 财务          │ 生成财务报表      │   │
│  │ L4.12.x.3 生成监管报表│ GenerateRegReportCommand     │ 合规          │ 生成监管报送      │   │
│  │ L4.12.x.4 提交监管报送│ SubmitRegReportCommand       │ 合规          │ 提交监管机构      │   │
│  │ L4.12.x.5 配置报表模板│ ConfigureReportTemplateCmd   │ 产品/运营     │ 配置报表格式      │   │
│  │ L4.12.x.6 配置大屏指标│ ConfigureDashboardCommand    │ 产品/运营     │ 配置实时大屏      │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 系统自动触发的 L4 任务总览

以下L4任务由系统自动触发（定时任务、事件驱动、状态机流转）：

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              系统自动触发的 L4 任务清单                                           │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.1 汇出汇款域 - 系统触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发方式      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.1.s.1 自动风控评估│ AutoRiskAssessCommand        │ 事件驱动      │ 订单创建后自动    │   │
│  │ L4.1.s.2 自动通道路由│ AutoChannelRoutingCommand    │ 事件驱动      │ 风控通过后自动    │   │
│  │ L4.1.s.3 自动资金冻结│ AutoFreezeBalanceCommand     │ 事件驱动      │ 路由成功后自动    │   │
│  │ L4.1.s.4 自动出款提交│ AutoSubmitPaymentCommand     │ 事件驱动      │ 冻结成功后自动    │   │
│  │ L4.1.s.5 订单超时处理│ HandlePaymentTimeoutCommand  │ 定时任务      │ 超时订单自动取消  │   │
│  │ L4.1.s.6 报价过期处理│ HandleQuoteExpiredCommand    │ 定时任务      │ 过期报价自动失效  │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.2 汇入汇款域 - 系统触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发方式      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.2.s.1 自动入账处理│ AutoCreditAccountCommand     │ 事件驱动      │ 收款确认后自动    │   │
│  │ L4.2.s.2 自动换汇执行│ AutoFxConversionCommand      │ 事件驱动      │ 入账后自动换汇    │   │
│  │ L4.2.s.3 自动通知客户│ AutoNotifyRecipientCommand   │ 事件驱动      │ 入账后自动通知    │   │
│  │ L4.2.s.4 出金自动审批│ AutoApproveWithdrawCommand   │ 事件驱动      │ 小额出金自动通过  │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.3 换汇域 - 系统触发任务                                   │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发方式      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.3.s.1 汇率自动更新│ UpdateFxRateCommand          │ 定时任务      │ 定时拉取市场汇率  │   │
│  │ L4.3.s.2 头寸自动对冲│ AutoHedgePositionCommand     │ 阈值触发      │ 头寸超阈值自动    │   │
│  │ L4.3.s.3 远期合约到期│ SettleForwardContractCommand │ 定时任务      │ 合约到期自动结算  │   │
│  │ L4.3.s.4 锁汇过期释放│ ReleaseLockRateCommand       │ 定时任务      │ 锁汇超时自动释放  │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.4 清结算域 - 系统触发任务                                 │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发方式      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.4.s.1 日终清算    │ DailySettlementCommand       │ 定时任务      │ 每日清算批处理    │   │
│  │ L4.4.s.2 自动对账    │ AutoReconciliationCommand    │ 定时任务      │ 定时对账检查      │   │
│  │ L4.4.s.3 商户自动结算│ AutoMerchantSettleCommand    │ 定时任务      │ T+N自动结算       │   │
│  │ L4.4.s.4 分账自动执行│ AutoSplitAccountCommand      │ 事件驱动      │ 订单完成后分账    │   │
│  │ L4.4.s.5 差错自动挂账│ AutoSuspenseEntryCommand     │ 事件驱动      │ 对账差异自动挂账  │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.5 风控合规域 - 系统触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发方式      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.5.s.1 实时风控扫描│ RealTimeRiskScanCommand      │ 事件驱动      │ 每笔交易实时扫描  │   │
│  │ L4.5.s.2 制裁名单筛查│ SanctionScreeningCommand     │ 事件驱动      │ 交易方自动筛查    │   │
│  │ L4.5.s.3 AML规则检测 │ AmlRuleCheckCommand          │ 事件驱动      │ AML规则自动检测   │   │
│  │ L4.5.s.4 累计限额检查│ CumulativeLimitCheckCommand  │ 事件驱动      │ 累计交易限额检查  │   │
│  │ L4.5.s.5 可疑交易标记│ FlagSuspiciousTxCommand      │ 事件驱动      │ 自动标记可疑交易  │   │
│  │ L4.5.s.6 定期名单更新│ ScheduledListUpdateCommand   │ 定时任务      │ 定期更新制裁名单  │   │
│  │ L4.5.s.7 KYC到期提醒 │ KycExpiryReminderCommand     │ 定时任务      │ KYC过期前提醒     │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.6 争议处理域 - 系统触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发方式      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.6.s.1 申诉超时提醒│ ComplaintTimeoutAlertCommand │ 定时任务      │ 处理超时自动提醒  │   │
│  │ L4.6.s.2 自动升级工单│ AutoEscalateComplaintCommand │ 定时任务      │ 超期自动升级      │   │
│  │ L4.6.s.3 拒付窗口提醒│ ChargebackWindowAlertCommand │ 定时任务      │ 申诉窗口即将关闭  │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.8 账户管理域 - 系统触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发方式      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.8.s.1 账户休眠检查│ CheckDormantAccountCommand   │ 定时任务      │ 长期未活动账户    │   │
│  │ L4.8.s.2 密码过期提醒│ PasswordExpiryAlertCommand   │ 定时任务      │ 密码即将过期提醒  │   │
│  │ L4.8.s.3 登录异常锁定│ AutoLockAccountCommand       │ 事件驱动      │ 多次失败自动锁定  │   │
│  │ L4.8.s.4 自动解锁账户│ AutoUnlockAccountCommand     │ 定时任务      │ 锁定超时自动解锁  │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.9 通道管理域 - 系统触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发方式      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.9.s.1 通道健康检查│ ChannelHealthCheckCommand    │ 定时任务      │ 定期检测通道状态  │   │
│  │ L4.9.s.2 自动降级通道│ AutoDegradeChannelCommand    │ 阈值触发      │ 失败率高自动降级  │   │
│  │ L4.9.s.3 自动恢复通道│ AutoRecoverChannelCommand    │ 定时任务      │ 降级后自动恢复    │   │
│  │ L4.9.s.4 通道限额重置│ ResetChannelLimitCommand     │ 定时任务      │ 每日限额重置      │   │
│  │ L4.9.s.5 通道成本刷新│ RefreshChannelCostCommand    │ 定时任务      │ 定时更新通道成本  │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.10 费用管理域 - 系统触发任务                              │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发方式      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.10.s.1 自动计费   │ AutoCalculateFeeCommand      │ 事件驱动      │ 交易完成自动计费  │   │
│  │ L4.10.s.2 月度账单生成│ GenerateMonthlyBillCommand   │ 定时任务      │ 每月自动生成账单  │   │
│  │ L4.10.s.3 分润自动结算│ AutoProfitSharingCommand     │ 定时任务      │ 定期分润结算      │   │
│  │ L4.10.s.4 费率阶梯更新│ UpdateTierLevelCommand       │ 定时任务      │ 月度交易量评级    │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.11 资金管理域 - 系统触发任务                              │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发方式      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.11.s.1 资金头寸检查│ CheckFundPositionCommand     │ 定时任务      │ 定时检查头寸      │   │
│  │ L4.11.s.2 低水位预警  │ LowBalanceAlertCommand       │ 阈值触发      │ 余额低于阈值预警  │   │
│  │ L4.11.s.3 自动头寸调拨│ AutoFundRebalanceCommand     │ 阈值触发      │ 自动平衡各账户    │   │
│  │ L4.11.s.4 日终轧账    │ DailyBalancingCommand        │ 定时任务      │ 每日轧账核对      │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.12 报表分析域 - 系统触发任务                              │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发方式      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.12.s.1 日报自动生成│ GenerateDailyReportCommand   │ 定时任务      │ 每日自动生成日报  │   │
│  │ L4.12.s.2 周报自动生成│ GenerateWeeklyReportCommand  │ 定时任务      │ 每周自动生成周报  │   │
│  │ L4.12.s.3 监管报表生成│ GenerateRegulatoryReportCmd  │ 定时任务      │ 定期监管报送      │   │
│  │ L4.12.s.4 大屏数据刷新│ RefreshDashboardDataCommand  │ 定时任务      │ 实时大屏数据更新  │   │
│  │ L4.12.s.5 订阅报表推送│ PushSubscribedReportCommand  │ 定时任务      │ 推送订阅的报表    │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 外部系统触发的 L4 任务总览

以下L4任务由外部系统触发（通道回调、银行通知、第三方Webhook）：

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              外部系统触发的 L4 任务清单                                           │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.1 汇出汇款域 - 外部触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发来源      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.1.e.1 出款状态回调│ PaymentStatusCallbackCommand │ 通道回调      │ 通道状态通知      │   │
│  │ L4.1.e.2 出款成功确认│ PaymentSuccessCallbackCmd    │ 通道回调      │ 出款成功通知      │   │
│  │ L4.1.e.3 出款失败通知│ PaymentFailureCallbackCmd    │ 通道回调      │ 出款失败通知      │   │
│  │ L4.1.e.4 银行退汇通知│ BankReturnNotifyCommand      │ 银行通知      │ 银行退汇          │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.2 汇入汇款域 - 外部触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发来源      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.2.e.1 收款到账通知│ InboundPaymentNotifyCommand  │ 银行通知      │ 银行入账通知      │   │
│  │ L4.2.e.2 SWIFT报文接收│ SwiftMessageReceivedCommand  │ SWIFT网络     │ MT103/MT199等     │   │
│  │ L4.2.e.3 代收成功回调│ CollectionSuccessCallbackCmd │ 收单通道      │ 代收成功通知      │   │
│  │ L4.2.e.4 追索请求接收│ RecallRequestReceivedCommand │ SWIFT网络     │ gpi追索请求       │   │
│  │ L4.2.e.5 出金到账确认│ WithdrawArrivalCallbackCmd   │ 代付通道      │ 提现到账通知      │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.3 换汇域 - 外部触发任务                                   │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发来源      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.3.e.1 汇率行情推送│ FxRateFeedCommand            │ 汇率提供商    │ 实时汇率推送      │   │
│  │ L4.3.e.2 对冲成交确认│ HedgeDealConfirmCommand      │ 银行/交易商   │ 对冲成交通知      │   │
│  │ L4.3.e.3 头寸报告接收│ PositionReportReceivedCmd    │ 做市商        │ 头寸报告          │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.4 清结算域 - 外部触发任务                                 │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发来源      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.4.e.1 通道对账文件│ ChannelReconFileReceivedCmd  │ 通道          │ 通道对账文件      │   │
│  │ L4.4.e.2 银行对账单  │ BankStatementReceivedCommand │ 银行          │ 银行日对账单      │   │
│  │ L4.4.e.3 清算结果通知│ ClearingResultNotifyCommand  │ 清算机构      │ 清算结果通知      │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.5 风控合规域 - 外部触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发来源      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.5.e.1 制裁名单更新│ SanctionListUpdateCommand    │ 名单提供商    │ OFAC/UN等更新     │   │
│  │ L4.5.e.2 KYC验证回调 │ KycVerificationCallbackCmd   │ KYC服务商     │ 身份验证结果      │   │
│  │ L4.5.e.3 设备指纹结果│ DeviceFingerprintResultCmd   │ 风控服务商    │ 设备风险评估      │   │
│  │ L4.5.e.4 监管查询通知│ RegulatoryInquiryCommand     │ 监管机构      │ 监管调查请求      │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.6 争议处理域 - 外部触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发来源      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.6.e.1 拒付通知接收│ ChargebackNotifyCommand      │ 卡组织/银行   │ 拒付通知          │   │
│  │ L4.6.e.2 调单请求接收│ RetrievalRequestCommand      │ 卡组织        │ 调单请求          │   │
│  │ L4.6.e.3 仲裁结果通知│ ArbitrationResultCommand     │ 卡组织        │ 仲裁结果          │   │
│  │ L4.6.e.4 预仲裁通知  │ PreArbitrationNotifyCommand  │ 卡组织        │ 预仲裁通知        │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.8 账户管理域 - 外部触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发来源      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.8.e.1 银行卡鉴权结果│ CardVerificationCallbackCmd  │ 银联/网联     │ 银行卡鉴权结果    │   │
│  │ L4.8.e.2 实名认证结果│ RealNameVerifyCallbackCmd    │ 公安/征信     │ 实名认证结果      │   │
│  │ L4.8.e.3 企业工商验证│ BusinessVerifyCallbackCmd    │ 工商系统      │ 企业信息验证      │   │
│  │ L4.8.e.4 协议签约回调│ AgreementSignCallbackCommand │ 银行          │ 代扣协议签约结果  │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              L2.9 通道管理域 - 外部触发任务                               │   │
│  ├──────────────────────┬──────────────────────────────┬───────────────┬───────────────────┤   │
│  │ L4 任务              │ Command                      │ 触发来源      │ 说明              │   │
│  ├──────────────────────┼──────────────────────────────┼───────────────┼───────────────────┤   │
│  │ L4.9.e.1 通道余额通知│ ChannelBalanceNotifyCommand  │ 通道          │ 通道余额变动      │   │
│  │ L4.9.e.2 通道费率更新│ ChannelFeeUpdateCommand      │ 通道          │ 通道费率变更      │   │
│  │ L4.9.e.3 通道维护通知│ ChannelMaintenanceNotifyCmd  │ 通道          │ 维护窗口通知      │   │
│  │ L4.9.e.4 通道限额变更│ ChannelLimitChangeCommand    │ 通道          │ 限额变更通知      │   │
│  └──────────────────────┴──────────────────────────────┴───────────────┴───────────────────┘   │
│                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.5 L4 任务触发者角色规范

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              触发者角色规范定义                                                   │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              客户类型                                                     │   │
│  ├──────────────────────┬───────────────────────────────────────────────────────────────────┤   │
│  │ 角色标识              │ 说明                                                              │   │
│  ├──────────────────────┼───────────────────────────────────────────────────────────────────┤   │
│  │ 个人客户              │ C端个人用户，完成KYC认证                                          │   │
│  │ 企业客户              │ B端企业用户，完成KYB认证                                          │   │
│  │ 商户                  │ API接入商户，签约合作协议                                         │   │
│  │ 企业/个人客户         │ 两类客户均可触发                                                  │   │
│  └──────────────────────┴───────────────────────────────────────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              运营角色（按职能划分）                                       │   │
│  ├──────────────────────┬───────────────────────────────────────────────────────────────────┤   │
│  │ 角色标识              │ 职责范围                                                          │   │
│  ├──────────────────────┼───────────────────────────────────────────────────────────────────┤   │
│  │ 客服                  │ 客户咨询、工单处理、基础操作协助                                  │   │
│  │ 客服主管              │ 工单分配、升级处理、权限操作审批                                  │   │
│  │ 风控                  │ 风控规则配置、可疑交易审核、风险评估                              │   │
│  │ 风控主管              │ 高风险决策、黑名单管理、规则审批                                  │   │
│  │ 合规                  │ KYC/KYB审核、AML检测、监管报送                                    │   │
│  │ 合规主管              │ 合规决策、SAR报告审批、监管对接                                   │   │
│  │ 财务                  │ 日常对账、清算操作、资金管理                                      │   │
│  │ 财务主管              │ 大额审批、调账授权、资金调拨审批                                  │   │
│  │ 技术运维              │ 系统配置、故障处理、通道维护                                      │   │
│  │ 商务                  │ 商户对接、费率谈判、合作洽谈                                      │   │
│  │ 商务主管              │ 商户审批、合同签署、合作终止                                      │   │
│  │ 产品                  │ 产品配置、规则设计、功能发布                                      │   │
│  │ 运营                  │ 日常运营、数据分析、活动配置                                      │   │
│  │ 运营主管              │ 运营决策、紧急处理、跨部门协调                                    │   │
│  │ 法务                  │ 合同审核、法律咨询、争议处理                                      │   │
│  └──────────────────────┴───────────────────────────────────────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              系统触发类型                                                 │   │
│  ├──────────────────────┬───────────────────────────────────────────────────────────────────┤   │
│  │ 触发方式              │ 说明                                                              │   │
│  ├──────────────────────┼───────────────────────────────────────────────────────────────────┤   │
│  │ 事件驱动              │ 领域事件触发，如订单创建、状态变更                                │   │
│  │ 定时任务              │ Cron调度触发，如日终清算、定期对账                                │   │
│  │ 阈值触发              │ 指标达到阈值触发，如头寸超限、余额不足                            │   │
│  │ 状态机流转            │ 状态机自动流转触发，如审批通过后自动进入下一步                    │   │
│  └──────────────────────┴───────────────────────────────────────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              外部系统类型                                                 │   │
│  ├──────────────────────┬───────────────────────────────────────────────────────────────────┤   │
│  │ 来源标识              │ 说明                                                              │   │
│  ├──────────────────────┼───────────────────────────────────────────────────────────────────┤   │
│  │ 通道回调              │ 支付通道的异步回调通知                                            │   │
│  │ 银行通知              │ 合作银行的账户变动、到账通知                                      │   │
│  │ SWIFT网络             │ SWIFT报文（MT103/MT199等）                                        │   │
│  │ 卡组织                │ Visa/MasterCard的拒付、调单通知                                   │   │
│  │ 清算机构              │ 银联、网联等清算结果                                              │   │
│  │ 监管机构              │ 央行、外管局等监管查询                                            │   │
│  │ KYC服务商             │ 身份验证、OCR识别结果                                             │   │
│  │ 风控服务商            │ 设备指纹、行为分析结果                                            │   │
│  │ 名单提供商            │ OFAC、UN等制裁名单更新                                            │   │
│  │ 汇率提供商            │ Reuters、Bloomberg等汇率数据                                      │   │
│  │ 做市商                │ 外汇交易做市商                                                    │   │
│  │ 工商系统              │ 企业工商信息验证                                                  │   │
│  │ 公安/征信             │ 实名认证、身份核验                                                │   │
│  │ 银联/网联             │ 银行卡鉴权、快捷支付                                              │   │
│  └──────────────────────┴───────────────────────────────────────────────────────────────────┘   │
│                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.6 L4 任务优先级分类

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              L4 任务优先级定义与分类                                               │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              优先级定义                                                   │   │
│  ├──────┬─────────┬─────────────────────────────────────────────────────────────────────────┤   │
│  │ 级别 │ SLA     │ 定义                                                                    │   │
│  ├──────┼─────────┼─────────────────────────────────────────────────────────────────────────┤   │
│  │ P0   │ < 100ms │ 关键路径：直接影响资金流转、交易成功率、客户体验的核心任务              │   │
│  │ P1   │ < 500ms │ 高优先级：影响业务连续性、合规要求、风险控制的重要任务                  │   │
│  │ P2   │ < 2s    │ 中优先级：影响运营效率、客户满意度的常规任务                            │   │
│  │ P3   │ < 10s   │ 低优先级：后台处理、报表生成、非实时任务                                │   │
│  │ P4   │ 分钟级  │ 批处理：日终清算、定期对账、报表汇总等批量任务                          │   │
│  └──────┴─────────┴─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 3.6.1 P0 关键路径任务（< 100ms）

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              P0 关键路径任务 - 影响资金流转与交易成功率                           │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 客户触发 - P0                                                                            │   │
│  ├────────────────────────┬──────────────────────────────┬──────────────────────────────────┤   │
│  │ L4 任务                │ Command                      │ 关键原因                         │   │
│  ├────────────────────────┼──────────────────────────────┼──────────────────────────────────┤   │
│  │ 创建付款订单           │ CreatePaymentOrderCommand    │ 交易入口，直接影响转化率         │   │
│  │ 确认换汇报价           │ ConfirmFxQuoteCommand        │ 汇率时效性，影响客户成本         │   │
│  │ 锁定汇率               │ LockFxRateCommand            │ 汇率锁定窗口期，超时即失效       │   │
│  │ 确认换汇               │ ConfirmFxDealCommand         │ 换汇成交，资金状态变更           │   │
│  │ 发起入金               │ InitiateDepositCommand       │ 充值入口，影响后续交易           │   │
│  │ 确认入金               │ ConfirmDepositCommand        │ 资金入账确认                     │   │
│  │ 发起出金               │ InitiateWithdrawCommand      │ 提现入口，客户资金流出           │   │
│  │ 确认出金               │ ConfirmWithdrawCommand       │ 提现确认，影响客户体验           │   │
│  └────────────────────────┴──────────────────────────────┴──────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 系统触发 - P0                                                                            │   │
│  ├────────────────────────┬──────────────────────────────┬──────────────────────────────────┤   │
│  │ L4 任务                │ Command                      │ 关键原因                         │   │
│  ├────────────────────────┼──────────────────────────────┼──────────────────────────────────┤   │
│  │ 实时风控扫描           │ RealTimeRiskScanCommand      │ 交易拦截，直接影响成功率         │   │
│  │ 制裁名单筛查           │ SanctionScreeningCommand     │ 合规前置，阻断风险交易           │   │
│  │ 自动资金冻结           │ AutoFreezeBalanceCommand     │ 资金安全，防止超额               │   │
│  │ 自动通道路由           │ AutoChannelRoutingCommand    │ 路由效率，影响出款速度           │   │
│  └────────────────────────┴──────────────────────────────┴──────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 外部触发 - P0                                                                            │   │
│  ├────────────────────────┬──────────────────────────────┬──────────────────────────────────┤   │
│  │ L4 任务                │ Command                      │ 关键原因                         │   │
│  ├────────────────────────┼──────────────────────────────┼──────────────────────────────────┤   │
│  │ 汇率行情推送           │ FxRateFeedCommand            │ 汇率实时性，影响报价准确性       │   │
│  │ 出款状态回调           │ PaymentStatusCallbackCommand │ 状态同步，影响客户查询           │   │
│  │ 出款成功确认           │ PaymentSuccessCallbackCmd    │ 交易闭环，更新订单状态           │   │
│  │ 收款到账通知           │ InboundPaymentNotifyCommand  │ 入账实时性，影响资金可用         │   │
│  └────────────────────────┴──────────────────────────────┴──────────────────────────────────┘   │
│                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 3.6.2 P1 高优先级任务（< 500ms）

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              P1 高优先级任务 - 影响业务连续性与合规                               │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 客户触发 - P1                                                                            │   │
│  ├────────────────────────┬──────────────────────────────┬──────────────────────────────────┤   │
│  │ L4 任务                │ Command                      │ 优先原因                         │   │
│  ├────────────────────────┼──────────────────────────────┼──────────────────────────────────┤   │
│  │ 获取汇率报价           │ RequestFxQuoteCommand        │ 用户等待，影响转化               │   │
│  │ 取消付款申请           │ CancelPaymentCommand         │ 用户操作，需即时响应             │   │
│  │ 选择支付方式           │ SelectPaymentMethodCommand   │ 支付流程，用户等待               │   │
│  │ 验证绑卡短信           │ VerifyBindCardSmsCommand     │ 短信时效，用户等待               │   │
│  │ 提交申诉               │ SubmitComplaintCommand       │ 客户诉求，需及时受理             │   │
│  │ 验证手机/邮箱          │ VerifyContactCommand         │ 注册流程，用户等待               │   │
│  └────────────────────────┴──────────────────────────────┴──────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 运营触发 - P1                                                                            │   │
│  ├────────────────────────┬──────────────────────────────┬──────────────────────────────────┤   │
│  │ L4 任务                │ Command                      │ 优先原因                         │   │
│  ├────────────────────────┼──────────────────────────────┼──────────────────────────────────┤   │
│  │ 人工审核通过           │ ApprovePaymentCommand        │ 阻塞交易，需快速处理             │   │
│  │ 人工审核拒绝           │ RejectPaymentCommand         │ 阻塞交易，需快速反馈             │   │
│  │ 冻结账户               │ FreezeAccountCommand         │ 风险控制，需立即生效             │   │
│  │ 加入黑名单             │ AddToBlacklistCommand        │ 风险阻断，需立即生效             │   │
│  │ 手动入账               │ ManualCreditCommand          │ 资金入账，客户等待               │   │
│  │ 审批出金               │ ApproveWithdrawCommand       │ 资金流出，客户等待               │   │
│  │ 通道切换               │ SwitchChannelCommand         │ 紧急容灾，影响成功率             │   │
│  └────────────────────────┴──────────────────────────────┴──────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 系统触发 - P1                                                                            │   │
│  ├────────────────────────┬──────────────────────────────┬──────────────────────────────────┤   │
│  │ L4 任务                │ Command                      │ 优先原因                         │   │
│  ├────────────────────────┼──────────────────────────────┼──────────────────────────────────┤   │
│  │ AML规则检测            │ AmlRuleCheckCommand          │ 合规要求，需实时检测             │   │
│  │ 累计限额检查           │ CumulativeLimitCheckCommand  │ 风控要求，防止超限               │   │
│  │ 自动入账处理           │ AutoCreditAccountCommand     │ 资金可用性，影响客户             │   │
│  │ 自动出款提交           │ AutoSubmitPaymentCommand     │ 交易流转，影响时效               │   │
│  │ 头寸自动对冲           │ AutoHedgePositionCommand     │ 风险敞口，需及时对冲             │   │
│  │ 低水位预警             │ LowBalanceAlertCommand       │ 资金安全，需及时响应             │   │
│  │ 自动降级通道           │ AutoDegradeChannelCommand    │ 服务稳定性，快速熔断             │   │
│  └────────────────────────┴──────────────────────────────┴──────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 外部触发 - P1                                                                            │   │
│  ├────────────────────────┬──────────────────────────────┬──────────────────────────────────┤   │
│  │ L4 任务                │ Command                      │ 优先原因                         │   │
│  ├────────────────────────┼──────────────────────────────┼──────────────────────────────────┤   │
│  │ 出款失败通知           │ PaymentFailureCallbackCmd    │ 异常处理，需快速响应             │   │
│  │ 银行退汇通知           │ BankReturnNotifyCommand      │ 资金回退，需及时处理             │   │
│  │ 拒付通知接收           │ ChargebackNotifyCommand      │ 争议时效，需及时响应             │   │
│  │ 银行卡鉴权结果         │ CardVerificationCallbackCmd  │ 绑卡流程，用户等待               │   │
│  │ KYC验证回调            │ KycVerificationCallbackCmd   │ 开户流程，用户等待               │   │
│  │ 监管查询通知           │ RegulatoryInquiryCommand     │ 合规要求，需及时响应             │   │
│  └────────────────────────┴──────────────────────────────┴──────────────────────────────────┘   │
│                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 3.6.3 P2 中优先级任务（< 2s）

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              P2 中优先级任务 - 影响运营效率与客户满意度                           │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 客户触发 - P2                                                                            │   │
│  ├────────────────────────┬──────────────────────────────┬──────────────────────────────────┤   │
│  │ L4 任务                │ Command                      │ 说明                             │   │
│  ├────────────────────────┼──────────────────────────────┼──────────────────────────────────┤   │
│  │ 添加收款人             │ AddBeneficiaryCommand        │ 常规操作，可接受短暂等待         │   │
│  │ 编辑收款人             │ UpdateBeneficiaryCommand     │ 常规操作                         │   │
│  │ 发起绑卡               │ InitiateBindCardCommand      │ 非即时，可接受等待               │   │
│  │ 提交KYC资料            │ SubmitKycDocumentsCommand    │ 资料提交，可接受处理时间         │   │
│  │ 提交KYB资料            │ SubmitKybDocumentsCommand    │ 资料提交                         │   │
│  │ 修改登录密码           │ ChangePasswordCommand        │ 安全操作，可接受等待             │   │
│  │ 设置支付密码           │ SetPaymentPinCommand         │ 安全设置                         │   │
│  │ 绑定MFA设备            │ BindMfaDeviceCommand         │ 安全设置                         │   │
│  │ 补充材料               │ SubmitEvidenceCommand        │ 争议流程，非即时                 │   │
│  │ 创建远期合约           │ CreateForwardContractCommand │ 非即时交易                       │   │
│  │ 申请API接入            │ ApplyApiAccessCommand        │ 非即时，需审核                   │   │
│  │ 申请开票               │ RequestInvoiceCommand        │ 非即时                           │   │
│  └────────────────────────┴──────────────────────────────┴──────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 运营触发 - P2                                                                            │   │
│  ├────────────────────────┬──────────────────────────────┬──────────────────────────────────┤   │
│  │ L4 任务                │ Command                      │ 说明                             │   │
│  ├────────────────────────┼──────────────────────────────┼──────────────────────────────────┤   │
│  │ 审核KYC资料            │ ReviewKycCommand             │ 人工审核，非即时                 │   │
│  │ 审核KYB资料            │ ReviewKybCommand             │ 人工审核                         │   │
│  │ 审核商户入驻           │ ReviewMerchantAppCommand     │ 人工审核                         │   │
│  │ 处理申诉               │ ProcessComplaintCommand      │ 工单处理                         │   │
│  │ 分配申诉工单           │ AssignComplaintCommand       │ 工单分配                         │   │
│  │ 调整商户等级           │ AdjustMerchantTierCommand    │ 配置操作                         │   │
│  │ 配置商户费率           │ ConfigureMerchantFeeCommand  │ 配置操作                         │   │
│  │ 调整风控规则           │ UpdateRiskRuleCommand        │ 配置操作                         │   │
│  │ 配置路由规则           │ ConfigureRoutingRuleCommand  │ 配置操作                         │   │
│  │ 处理对账差异           │ HandleReconcileDiffCommand   │ 对账处理                         │   │
│  └────────────────────────┴──────────────────────────────┴──────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 系统触发 - P2                                                                            │   │
│  ├────────────────────────┬──────────────────────────────┬──────────────────────────────────┤   │
│  │ L4 任务                │ Command                      │ 说明                             │   │
│  ├────────────────────────┼──────────────────────────────┼──────────────────────────────────┤   │
│  │ 可疑交易标记           │ FlagSuspiciousTxCommand      │ 标记操作，非阻断                 │   │
│  │ 自动通知客户           │ AutoNotifyRecipientCommand   │ 通知类，可接受延迟               │   │
│  │ 自动换汇执行           │ AutoFxConversionCommand      │ 后续处理                         │   │
│  │ 分账自动执行           │ AutoSplitAccountCommand      │ 后续处理                         │   │
│  │ 通道健康检查           │ ChannelHealthCheckCommand    │ 定期检查                         │   │
│  │ 自动恢复通道           │ AutoRecoverChannelCommand    │ 恢复操作                         │   │
│  │ 自动计费               │ AutoCalculateFeeCommand      │ 后续处理                         │   │
│  └────────────────────────┴──────────────────────────────┴──────────────────────────────────┘   │
│                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 3.6.4 P3 低优先级任务（< 10s）

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              P3 低优先级任务 - 后台处理与非实时任务                               │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 客户触发 - P3                                                                            │   │
│  ├────────────────────────┬──────────────────────────────┬──────────────────────────────────┤   │
│  │ L4 任务                │ Command                      │ 说明                             │   │
│  ├────────────────────────┼──────────────────────────────┼──────────────────────────────────┤   │
│  │ 删除收款人             │ RemoveBeneficiaryCommand     │ 非关键操作                       │   │
│  │ 解绑银行卡             │ UnbindCardCommand            │ 非关键操作                       │   │
│  │ 设为默认卡             │ SetDefaultCardCommand        │ 偏好设置                         │   │
│  │ 设置通知偏好           │ SetNotificationPrefCommand   │ 偏好设置                         │   │
│  │ 撤回申诉               │ WithdrawComplaintCommand     │ 非即时                           │   │
│  │ 取消远期合约           │ CancelForwardContractCommand │ 非即时                           │   │
│  │ 配置回调地址           │ ConfigureWebhookCommand      │ 配置操作                         │   │
│  │ 配置IP白名单           │ ConfigureIpWhitelistCommand  │ 配置操作                         │   │
│  │ 导出交易报表           │ ExportTransactionReportCmd   │ 报表生成                         │   │
│  │ 订阅定期报表           │ SubscribeReportCommand       │ 配置操作                         │   │
│  │ 自定义报表             │ CustomizeReportCommand       │ 配置操作                         │   │
│  │ 下载电子发票           │ DownloadInvoiceCommand       │ 文件下载                         │   │
│  └────────────────────────┴──────────────────────────────┴──────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 运营触发 - P3                                                                            │   │
│  ├────────────────────────┬──────────────────────────────┬──────────────────────────────────┤   │
│  │ L4 任务                │ Command                      │ 说明                             │   │
│  ├────────────────────────┼──────────────────────────────┼──────────────────────────────────┤   │
│  │ 移出黑名单             │ RemoveFromBlacklistCommand   │ 非紧急                           │   │
│  │ 解冻账户               │ UnfreezeAccountCommand       │ 非紧急                           │   │
│  │ 申诉结案               │ CloseComplaintCommand        │ 非即时                           │   │
│  │ 费用减免               │ WaiveFeeCommand              │ 非即时                           │   │
│  │ 配置基础费率           │ ConfigureBaseFeeCommand      │ 配置操作                         │   │
│  │ 配置阶梯费率           │ ConfigureTieredFeeCommand    │ 配置操作                         │   │
│  │ 添加新通道             │ AddChannelCommand            │ 配置操作                         │   │
│  │ 配置通道参数           │ ConfigureChannelCommand      │ 配置操作                         │   │
│  │ 配置报表模板           │ ConfigureReportTemplateCmd   │ 配置操作                         │   │
│  │ 配置大屏指标           │ ConfigureDashboardCommand    │ 配置操作                         │   │
│  │ 设置预警阈值           │ SetAlertThresholdCommand     │ 配置操作                         │   │
│  │ 配置银行账户           │ ConfigureBankAccountCommand  │ 配置操作                         │   │
│  └────────────────────────┴──────────────────────────────┴──────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 系统触发 - P3                                                                            │   │
│  ├────────────────────────┬──────────────────────────────┬──────────────────────────────────┤   │
│  │ L4 任务                │ Command                      │ 说明                             │   │
│  ├────────────────────────┼──────────────────────────────┼──────────────────────────────────┤   │
│  │ 订单超时处理           │ HandlePaymentTimeoutCommand  │ 定期清理                         │   │
│  │ 报价过期处理           │ HandleQuoteExpiredCommand    │ 定期清理                         │   │
│  │ 锁汇过期释放           │ ReleaseLockRateCommand       │ 定期清理                         │   │
│  │ 申诉超时提醒           │ ComplaintTimeoutAlertCommand │ 提醒类                           │   │
│  │ 拒付窗口提醒           │ ChargebackWindowAlertCommand │ 提醒类                           │   │
│  │ 密码过期提醒           │ PasswordExpiryAlertCommand   │ 提醒类                           │   │
│  │ KYC到期提醒            │ KycExpiryReminderCommand     │ 提醒类                           │   │
│  │ 账户休眠检查           │ CheckDormantAccountCommand   │ 定期检查                         │   │
│  │ 自动解锁账户           │ AutoUnlockAccountCommand     │ 定期处理                         │   │
│  │ 通道限额重置           │ ResetChannelLimitCommand     │ 定期重置                         │   │
│  │ 通道成本刷新           │ RefreshChannelCostCommand    │ 定期更新                         │   │
│  │ 费率阶梯更新           │ UpdateTierLevelCommand       │ 定期更新                         │   │
│  │ 大屏数据刷新           │ RefreshDashboardDataCommand  │ 定期刷新                         │   │
│  └────────────────────────┴──────────────────────────────┴──────────────────────────────────┘   │
│                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 3.6.5 P4 批处理任务（分钟级）

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              P4 批处理任务 - 日终清算与定期批量                                   │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 运营触发 - P4                                                                            │   │
│  ├────────────────────────┬──────────────────────────────┬──────────────────────────────────┤   │
│  │ L4 任务                │ Command                      │ 执行时间                         │   │
│  ├────────────────────────┼──────────────────────────────┼──────────────────────────────────┤   │
│  │ 发起手动清算           │ TriggerManualSettlementCmd   │ 非实时，批量处理                 │   │
│  │ 调账处理               │ AdjustAccountCommand         │ 财务操作，批量                   │   │
│  │ 生成交易报表           │ GenerateTxReportCommand      │ 报表生成                         │   │
│  │ 生成财务报表           │ GenerateFinReportCommand     │ 报表生成                         │   │
│  │ 生成监管报表           │ GenerateRegReportCommand     │ 报表生成                         │   │
│  │ 提交监管报送           │ SubmitRegReportCommand       │ 监管报送                         │   │
│  │ 执行分润结算           │ ExecuteSharingSettleCommand  │ 定期结算                         │   │
│  │ 生成账单               │ GenerateInvoiceCommand       │ 定期生成                         │   │
│  └────────────────────────┴──────────────────────────────┴──────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 系统触发 - P4                                                                            │   │
│  ├────────────────────────┬──────────────────────────────┬──────────────────────────────────┤   │
│  │ L4 任务                │ Command                      │ 执行时间                         │   │
│  ├────────────────────────┼──────────────────────────────┼──────────────────────────────────┤   │
│  │ 日终清算               │ DailySettlementCommand       │ 每日 00:00-02:00                 │   │
│  │ 自动对账               │ AutoReconciliationCommand    │ 每日 02:00-04:00                 │   │
│  │ 商户自动结算           │ AutoMerchantSettleCommand    │ T+N，批量执行                    │   │
│  │ 差错自动挂账           │ AutoSuspenseEntryCommand     │ 对账后批量                       │   │
│  │ 定期名单更新           │ ScheduledListUpdateCommand   │ 每日定时                         │   │
│  │ 汇率自动更新           │ UpdateFxRateCommand          │ 定时批量                         │   │
│  │ 远期合约到期           │ SettleForwardContractCommand │ 到期日批量                       │   │
│  │ 资金头寸检查           │ CheckFundPositionCommand     │ 定时检查                         │   │
│  │ 自动头寸调拨           │ AutoFundRebalanceCommand     │ 触发后批量                       │   │
│  │ 日终轧账               │ DailyBalancingCommand        │ 每日 23:00-00:00                 │   │
│  │ 月度账单生成           │ GenerateMonthlyBillCommand   │ 每月 1日                         │   │
│  │ 分润自动结算           │ AutoProfitSharingCommand     │ 每月定时                         │   │
│  │ 日报自动生成           │ GenerateDailyReportCommand   │ 每日 06:00                       │   │
│  │ 周报自动生成           │ GenerateWeeklyReportCommand  │ 每周一 08:00                     │   │
│  │ 监管报表生成           │ GenerateRegulatoryReportCmd  │ 按监管周期                       │   │
│  │ 订阅报表推送           │ PushSubscribedReportCommand  │ 按订阅周期                       │   │
│  │ 自动升级工单           │ AutoEscalateComplaintCommand │ 定期检查                         │   │
│  └────────────────────────┴──────────────────────────────┴──────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │ 外部触发 - P4（批量接收）                                                                │   │
│  ├────────────────────────┬──────────────────────────────┬──────────────────────────────────┤   │
│  │ L4 任务                │ Command                      │ 说明                             │   │
│  ├────────────────────────┼──────────────────────────────┼──────────────────────────────────┤   │
│  │ 通道对账文件           │ ChannelReconFileReceivedCmd  │ 每日批量接收                     │   │
│  │ 银行对账单             │ BankStatementReceivedCommand │ 每日批量接收                     │   │
│  │ 制裁名单更新           │ SanctionListUpdateCommand    │ 定期批量接收                     │   │
│  │ 清算结果通知           │ ClearingResultNotifyCommand  │ 批量接收                         │   │
│  └────────────────────────┴──────────────────────────────┴──────────────────────────────────┘   │
│                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 3.6.6 优先级分布统计

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              L4 任务优先级分布统计                                                │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │  优先级    │ 客户触发 │ 运营触发 │ 系统触发 │ 外部触发 │  合计   │   占比   │   SLA     │ │
│  ├───────────┼──────────┼──────────┼──────────┼──────────┼─────────┼──────────┼───────────┤ │
│  │  P0 关键  │    8     │    0     │    4     │    4     │   16    │   8%     │  < 100ms  │ │
│  │  P1 高    │    6     │    7     │    7     │    6     │   26    │  13%     │  < 500ms  │ │
│  │  P2 中    │   12     │   10     │    7     │    0     │   29    │  15%     │  < 2s     │ │
│  │  P3 低    │   12     │   12     │   13     │    0     │   37    │  19%     │  < 10s    │ │
│  │  P4 批    │    0     │    8     │   17     │    4     │   29    │  15%     │  分钟级   │ │
│  ├───────────┼──────────┼──────────┼──────────┼──────────┼─────────┼──────────┼───────────┤ │
│  │   未分类  │   27     │   46     │    5     │   18     │   96    │  48%     │   -       │ │
│  ├───────────┼──────────┼──────────┼──────────┼──────────┼─────────┼──────────┼───────────┤ │
│  │   合计    │   65     │   83     │   53     │   32     │  233    │  100%    │   -       │ │
│  └───────────┴──────────┴──────────┴──────────┴──────────┴─────────┴──────────┴───────────┘ │
│                                                                                                 │
│  优先级分布原则：                                                                               │
│  ├── P0 (8%): 交易核心路径，直接影响资金和成功率，需要极致性能优化                             │
│  ├── P1 (13%): 高优业务，影响连续性和合规，需要保障响应时效                                    │
│  ├── P2 (15%): 常规业务，影响效率和体验，需要合理响应                                          │
│  ├── P3 (19%): 后台任务，非实时要求，可以接受一定延迟                                          │
│  └── P4 (15%): 批处理任务，分钟级甚至小时级处理                                                │
│                                                                                                 │
│  技术实现建议：                                                                                 │
│  ├── P0: 同步处理 + 内存计算 + 连接池预热 + 热点数据缓存                                       │
│  ├── P1: 同步处理 + 异步补偿 + 超时熔断 + 限流保护                                             │
│  ├── P2: 异步消息队列 + 重试机制 + 批量聚合                                                    │
│  ├── P3: 异步消息队列 + 延迟队列 + 低优先级线程池                                              │
│  └── P4: 定时调度 + 分布式任务 + 分片处理 + 错峰执行                                           │
│                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.7 Command/Query 定义

#### 3.7.1 运营触发 Command 定义 (Rust)

```rust
// ============================================================================
// 运营触发的 Commands - 内部管理系统入口
// ============================================================================

use chrono::{DateTime, Utc};
use rust_decimal::Decimal;
use serde::{Deserialize, Serialize};
use uuid::Uuid;

// ----------------------------------------------------------------------------
// L2.1 汇出汇款域 - 运营触发 Commands
// ----------------------------------------------------------------------------

/// 人工审核通过付款
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ApprovePaymentCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub payment_id: String,
    pub approval_note: String,
    pub timestamp: DateTime<Utc>,
}

/// 人工审核拒绝付款
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct RejectPaymentCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub payment_id: String,
    pub reject_reason: RejectReason,
    pub reject_note: String,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum RejectReason {
    ComplianceIssue,
    DocumentMissing,
    SuspiciousActivity,
    SanctionHit,
    Other(String),
}

/// 强制取消订单
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ForceCancelPaymentCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub payment_id: String,
    pub cancel_reason: String,
    pub supervisor_approval: String,
    pub timestamp: DateTime<Utc>,
}

/// 手动重试出款
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct RetryPaymentCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub payment_id: String,
    pub retry_channel: Option<String>,
    pub timestamp: DateTime<Utc>,
}

// ----------------------------------------------------------------------------
// L2.5 风控合规域 - 运营触发 Commands
// ----------------------------------------------------------------------------

/// 人工风控审核
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ManualRiskReviewCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub transaction_id: String,
    pub review_result: RiskReviewResult,
    pub risk_score_override: Option<i32>,
    pub review_note: String,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum RiskReviewResult {
    Approved,
    Rejected,
    EscalateToManager,
    RequireMoreInfo,
}

/// 加入黑名单
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AddToBlacklistCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub entity_type: BlacklistEntityType,
    pub entity_id: String,
    pub entity_name: String,
    pub reason: String,
    pub expiry_date: Option<DateTime<Utc>>,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum BlacklistEntityType {
    Customer,
    Merchant,
    BankAccount,
    IpAddress,
    Device,
}

/// 冻结账户
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct FreezeAccountCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub customer_id: String,
    pub freeze_type: FreezeType,
    pub reason: String,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum FreezeType {
    FullFreeze,          // 完全冻结
    WithdrawOnly,        // 仅冻结出金
    TransactionOnly,     // 仅冻结交易
}

/// 解冻账户
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct UnfreezeAccountCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub customer_id: String,
    pub supervisor_approval: String,
    pub unfreeze_note: String,
    pub timestamp: DateTime<Utc>,
}

/// 提交SAR报告
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SubmitSarReportCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub customer_id: String,
    pub transaction_ids: Vec<String>,
    pub suspicious_activity_type: String,
    pub narrative: String,
    pub timestamp: DateTime<Utc>,
}

// ----------------------------------------------------------------------------
// L2.7 商户管理域 - 运营触发 Commands
// ----------------------------------------------------------------------------

/// 审核商户入驻
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ReviewMerchantAppCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub application_id: String,
    pub review_result: MerchantReviewResult,
    pub review_note: String,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum MerchantReviewResult {
    Approved,
    Rejected,
    RequireMoreDocs,
    EscalateToCompliance,
}

/// 配置商户费率
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ConfigureMerchantFeeCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub merchant_id: String,
    pub fee_type: FeeType,
    pub fee_rate: Decimal,
    pub min_fee: Option<Decimal>,
    pub max_fee: Option<Decimal>,
    pub effective_date: DateTime<Utc>,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum FeeType {
    TransactionFee,
    WithdrawFee,
    FxSpread,
    MonthlyFee,
}

/// 暂停商户服务
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SuspendMerchantCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub merchant_id: String,
    pub suspend_reason: String,
    pub suspend_type: SuspendType,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum SuspendType {
    Temporary,
    Permanent,
}

// ----------------------------------------------------------------------------
// L2.8 账户管理域 - 运营触发 Commands
// ----------------------------------------------------------------------------

/// 审核KYC/KYB资料
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ReviewKycCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub customer_id: String,
    pub review_result: KycReviewResult,
    pub risk_level: Option<RiskLevel>,
    pub review_note: String,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum KycReviewResult {
    Approved,
    Rejected,
    RequireAdditionalDocs,
    EscalateToSenior,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum RiskLevel {
    Low,
    Medium,
    High,
}

/// 调整账户限额
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AdjustAccountLimitCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub customer_id: String,
    pub limit_type: LimitType,
    pub new_limit: Decimal,
    pub reason: String,
    pub supervisor_approval: Option<String>,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum LimitType {
    DailyTransaction,
    SingleTransaction,
    MonthlyTransaction,
    DailyWithdraw,
}

// ----------------------------------------------------------------------------
// L2.9 通道管理域 - 运营触发 Commands
// ----------------------------------------------------------------------------

/// 添加新通道
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AddChannelCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub channel_code: String,
    pub channel_name: String,
    pub channel_type: ChannelType,
    pub supported_currencies: Vec<String>,
    pub supported_countries: Vec<String>,
    pub api_endpoint: String,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum ChannelType {
    Swift,
    LocalClearing,
    CardNetwork,
    Wallet,
    Crypto,
}

/// 配置路由规则
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ConfigureRoutingRuleCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub rule_name: String,
    pub priority: i32,
    pub conditions: Vec<RoutingCondition>,
    pub target_channel: String,
    pub fallback_channel: Option<String>,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct RoutingCondition {
    pub field: String,       // e.g., "amount", "currency", "country"
    pub operator: String,    // e.g., "eq", "gt", "in"
    pub value: String,
}

/// 紧急通道切换
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SwitchChannelCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub from_channel: String,
    pub to_channel: String,
    pub reason: String,
    pub auto_rollback_minutes: Option<u32>,
    pub timestamp: DateTime<Utc>,
}

// ----------------------------------------------------------------------------
// L2.11 资金管理域 - 运营触发 Commands
// ----------------------------------------------------------------------------

/// 发起资金调拨
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct InitiateFundTransferCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub from_account: String,
    pub to_account: String,
    pub amount: Decimal,
    pub currency: String,
    pub purpose: String,
    pub timestamp: DateTime<Utc>,
}

/// 设置资金预警阈值
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SetAlertThresholdCommand {
    pub command_id: Uuid,
    pub operator_id: String,
    pub account_id: String,
    pub alert_type: AlertType,
    pub threshold_amount: Decimal,
    pub notification_channels: Vec<String>,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum AlertType {
    LowBalance,
    HighBalance,
    LargeTransaction,
    AbnormalVolume,
}
```

#### 3.7.2 客户触发 Command 定义 (Rust)

```rust
// ============================================================================
// 客户触发的 Commands - 系统主入口
// ============================================================================

use chrono::{DateTime, Utc};
use rust_decimal::Decimal;
use serde::{Deserialize, Serialize};
use uuid::Uuid;

// ----------------------------------------------------------------------------
// L2.1 汇出汇款域 - 客户触发 Commands
// ----------------------------------------------------------------------------

/// L4.1.8.1 发起入金命令（充值）
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct InitiateDepositCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub wallet_id: String,
    pub amount: Decimal,
    pub currency: String,
    pub payment_method: PaymentMethod,
    pub idempotency_key: String,
    pub timestamp: DateTime<Utc>,
}

/// L4.1.8.2 选择支付方式命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SelectPaymentMethodCommand {
    pub command_id: Uuid,
    pub deposit_id: String,
    pub payment_method: PaymentMethod,
    pub bank_card_id: Option<String>,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum PaymentMethod {
    BoundCard { card_id: String },
    OnlineBanking { bank_code: String },
    ThirdParty { provider: String },
}

// ----------------------------------------------------------------------------
// L2.2 汇入汇款域 - 客户触发 Commands
// ----------------------------------------------------------------------------

/// L4.2.6.1 发起出金命令（提现）
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct InitiateWithdrawCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub wallet_id: String,
    pub amount: Decimal,
    pub currency: String,
    pub idempotency_key: String,
    pub timestamp: DateTime<Utc>,
}

/// L4.2.6.2 选择出金银行卡命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SelectWithdrawBankCommand {
    pub command_id: Uuid,
    pub withdraw_id: String,
    pub bank_card_id: String,
    pub timestamp: DateTime<Utc>,
}

/// L4.2.6.3 确认出金命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ConfirmWithdrawCommand {
    pub command_id: Uuid,
    pub withdraw_id: String,
    pub verification_code: String,
    pub timestamp: DateTime<Utc>,
}

// ----------------------------------------------------------------------------
// L2.6 争议处理域 - 客户触发 Commands
// ----------------------------------------------------------------------------

/// L4.6.5.1 提交申诉命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SubmitComplaintCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub transaction_id: String,
    pub complaint_type: ComplaintType,
    pub description: String,
    pub evidence_urls: Vec<String>,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum ComplaintType {
    TransactionDispute,
    AmountMismatch,
    UnauthorizedTransaction,
    ServiceQuality,
    Other(String),
}

/// L4.6.5.2 补充举证材料命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SubmitEvidenceCommand {
    pub command_id: Uuid,
    pub complaint_id: String,
    pub evidence_type: String,
    pub evidence_urls: Vec<String>,
    pub description: String,
    pub timestamp: DateTime<Utc>,
}

/// L4.6.5.3 撤回申诉命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct WithdrawComplaintCommand {
    pub command_id: Uuid,
    pub complaint_id: String,
    pub reason: String,
    pub timestamp: DateTime<Utc>,
}

// ----------------------------------------------------------------------------
// L2.7 商户管理域 - 商户触发 Commands
// ----------------------------------------------------------------------------

/// L4.7.1.1 提交商户入驻申请命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SubmitMerchantAppCommand {
    pub command_id: Uuid,
    pub company_name: String,
    pub business_license_no: String,
    pub legal_representative: String,
    pub contact_email: String,
    pub contact_phone: String,
    pub business_type: String,
    pub expected_volume: Decimal,
    pub timestamp: DateTime<Utc>,
}

/// L4.7.1.2 补充资质材料命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SubmitQualificationCommand {
    pub command_id: Uuid,
    pub merchant_app_id: String,
    pub document_type: String,
    pub document_url: String,
    pub timestamp: DateTime<Utc>,
}

/// L4.7.2.1 签署合同命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SignContractCommand {
    pub command_id: Uuid,
    pub merchant_id: String,
    pub contract_id: String,
    pub signature_data: String,
    pub timestamp: DateTime<Utc>,
}

/// L4.7.4.1 申请API接入命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ApplyApiAccessCommand {
    pub command_id: Uuid,
    pub merchant_id: String,
    pub environment: ApiEnvironment,
    pub ip_whitelist: Vec<String>,
    pub callback_url: String,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum ApiEnvironment {
    Sandbox,
    Production,
}

/// L4.7.4.2 重置API密钥命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ResetApiKeyCommand {
    pub command_id: Uuid,
    pub merchant_id: String,
    pub api_key_id: String,
    pub reason: String,
    pub timestamp: DateTime<Utc>,
}

// ----------------------------------------------------------------------------
// L2.8 账户管理域 - 客户触发 Commands
// ----------------------------------------------------------------------------

/// L4.8.1.1 提交注册申请命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SubmitRegistrationCommand {
    pub command_id: Uuid,
    pub customer_type: CustomerType,
    pub email: String,
    pub phone: String,
    pub password_hash: String,
    pub referral_code: Option<String>,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum CustomerType {
    Individual,
    Business,
}

/// L4.8.1.2 验证联系方式命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct VerifyContactCommand {
    pub command_id: Uuid,
    pub registration_id: String,
    pub contact_type: ContactType,
    pub verification_code: String,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum ContactType {
    Email,
    Phone,
}

/// L4.8.2.1 提交KYC资料命令（个人）
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SubmitKycDocumentsCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub id_type: IdDocumentType,
    pub id_number: String,
    pub id_front_url: String,
    pub id_back_url: String,
    pub selfie_url: String,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum IdDocumentType {
    IdCard,
    Passport,
    DrivingLicense,
}

/// L4.8.2.2 提交KYB资料命令（企业）
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SubmitKybDocumentsCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub company_name: String,
    pub registration_number: String,
    pub business_license_url: String,
    pub legal_rep_id_url: String,
    pub shareholder_docs: Vec<String>,
    pub timestamp: DateTime<Utc>,
}

/// L4.8.3.1 申请开户命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ApplyAccountOpeningCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub account_type: AccountType,
    pub base_currency: String,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum AccountType {
    Personal,
    Business,
}

/// L4.8.4.1 创建钱包命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct CreateWalletCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub account_id: String,
    pub currency: String,
    pub wallet_name: Option<String>,
    pub timestamp: DateTime<Utc>,
}

/// L4.8.6.1 发起绑卡命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct InitiateBindCardCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub card_number_encrypted: String,
    pub card_holder_name: String,
    pub bank_code: String,
    pub phone_number: String,
    pub id_number_encrypted: String,
    pub timestamp: DateTime<Utc>,
}

/// L4.8.6.2 验证绑卡短信命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct VerifyBindCardSmsCommand {
    pub command_id: Uuid,
    pub bind_card_request_id: String,
    pub sms_code: String,
    pub timestamp: DateTime<Utc>,
}

/// L4.8.6.3 解绑银行卡命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct UnbindCardCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub bank_card_id: String,
    pub verification_code: String,
    pub timestamp: DateTime<Utc>,
}

/// L4.8.6.4 设为默认卡命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SetDefaultCardCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub bank_card_id: String,
    pub timestamp: DateTime<Utc>,
}

// ----------------------------------------------------------------------------
// L2.1 汇出汇款域 - 补充 Commands
// ----------------------------------------------------------------------------

/// L4.1.1.3 添加收款人命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AddBeneficiaryCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub beneficiary_name: String,
    pub bank_account: String,
    pub bank_code: String,
    pub bank_name: String,
    pub country: String,
    pub swift_code: Option<String>,
    pub iban: Option<String>,
    pub timestamp: DateTime<Utc>,
}

/// L4.1.1.4 编辑收款人命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct UpdateBeneficiaryCommand {
    pub command_id: Uuid,
    pub beneficiary_id: String,
    pub beneficiary_name: Option<String>,
    pub bank_account: Option<String>,
    pub bank_code: Option<String>,
    pub timestamp: DateTime<Utc>,
}

/// L4.1.1.5 删除收款人命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct RemoveBeneficiaryCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub beneficiary_id: String,
    pub timestamp: DateTime<Utc>,
}

/// L4.1.4.1 上传批量文件命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct UploadBatchFileCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub file_name: String,
    pub file_hash: String,
    pub file_size: u64,
    pub file_format: BatchFileFormat,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum BatchFileFormat {
    Csv,
    Excel,
    Xml,
}

/// L4.1.4.2 确认批量付款命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ConfirmBatchPaymentCommand {
    pub command_id: Uuid,
    pub batch_id: String,
    pub verification_code: String,
    pub timestamp: DateTime<Utc>,
}

/// L4.1.8.3 确认入金命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ConfirmDepositCommand {
    pub command_id: Uuid,
    pub deposit_id: String,
    pub verification_code: String,
    pub timestamp: DateTime<Utc>,
}

// ----------------------------------------------------------------------------
// L2.3 换汇域 - 客户触发 Commands
// ----------------------------------------------------------------------------

/// L4.3.1.2 锁定汇率命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct LockFxRateCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub quote_id: String,
    pub lock_duration_seconds: u32,
    pub timestamp: DateTime<Utc>,
}

/// L4.3.1.3 确认换汇命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ConfirmFxDealCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub quote_id: String,
    pub source_wallet_id: String,
    pub target_wallet_id: String,
    pub timestamp: DateTime<Utc>,
}

/// L4.3.2.1 创建远期合约命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct CreateForwardContractCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub source_currency: String,
    pub target_currency: String,
    pub amount: Decimal,
    pub forward_rate: Decimal,
    pub settlement_date: DateTime<Utc>,
    pub timestamp: DateTime<Utc>,
}

/// L4.3.2.2 取消远期合约命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct CancelForwardContractCommand {
    pub command_id: Uuid,
    pub contract_id: String,
    pub reason: String,
    pub timestamp: DateTime<Utc>,
}

// ----------------------------------------------------------------------------
// L2.7 商户管理域 - 补充 Commands
// ----------------------------------------------------------------------------

/// L4.7.4.3 配置回调地址命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ConfigureWebhookCommand {
    pub command_id: Uuid,
    pub merchant_id: String,
    pub webhook_url: String,
    pub event_types: Vec<WebhookEventType>,
    pub secret_key: String,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum WebhookEventType {
    PaymentCompleted,
    PaymentFailed,
    RefundCompleted,
    SettlementCompleted,
}

/// L4.7.4.4 配置IP白名单命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ConfigureIpWhitelistCommand {
    pub command_id: Uuid,
    pub merchant_id: String,
    pub ip_addresses: Vec<String>,
    pub timestamp: DateTime<Utc>,
}

// ----------------------------------------------------------------------------
// L2.8 账户管理域 - 补充 Commands (安全相关)
// ----------------------------------------------------------------------------

/// L4.8.1.3 设置登录密码命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SetPasswordCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub password_hash: String,
    pub timestamp: DateTime<Utc>,
}

/// L4.8.5.1 修改登录密码命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ChangePasswordCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub old_password_hash: String,
    pub new_password_hash: String,
    pub timestamp: DateTime<Utc>,
}

/// L4.8.5.2 设置支付密码命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SetPaymentPinCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub pin_hash: String,
    pub verification_code: String,
    pub timestamp: DateTime<Utc>,
}

/// L4.8.5.3 修改支付密码命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ChangePaymentPinCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub old_pin_hash: String,
    pub new_pin_hash: String,
    pub timestamp: DateTime<Utc>,
}

/// L4.8.5.4 重置密码命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ResetPasswordCommand {
    pub command_id: Uuid,
    pub email_or_phone: String,
    pub verification_code: String,
    pub new_password_hash: String,
    pub timestamp: DateTime<Utc>,
}

/// L4.8.5.5 绑定MFA设备命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct BindMfaDeviceCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub mfa_type: MfaType,
    pub mfa_secret: String,
    pub verification_code: String,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum MfaType {
    Totp,
    Sms,
    Email,
}

/// L4.8.5.6 解绑MFA设备命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct UnbindMfaDeviceCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub mfa_device_id: String,
    pub verification_code: String,
    pub timestamp: DateTime<Utc>,
}

/// L4.8.5.7 设置通知偏好命令
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct SetNotificationPrefCommand {
    pub command_id: Uuid,
    pub customer_id: String,
    pub email_enabled: bool,
    pub sms_enabled: bool,
    pub push_enabled: bool,
    pub notification_types: Vec<NotificationType>,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum NotificationType {
    PaymentSuccess,
    PaymentFailed,
    DepositReceived,
    WithdrawCompleted,
    SecurityAlert,
    Marketing,
}
```

#### 3.7.3 客户触发 Query 定义 (Rust)

```rust
// ============================================================================
// 客户触发的 Queries - CQRS 查询端
// ============================================================================

use chrono::{DateTime, Utc};
use rust_decimal::Decimal;
use serde::{Deserialize, Serialize};

// ----------------------------------------------------------------------------
// 通用查询参数
// ----------------------------------------------------------------------------

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Pagination {
    pub page: u32,
    pub page_size: u32,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DateRange {
    pub start: DateTime<Utc>,
    pub end: DateTime<Utc>,
}

// ----------------------------------------------------------------------------
// 账户相关 Queries
// ----------------------------------------------------------------------------

/// 查询账户余额
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct QueryBalanceQuery {
    pub customer_id: String,
    pub currency: Option<String>,  // None表示查询所有币种
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct BalanceResult {
    pub currency: String,
    pub available: Decimal,
    pub frozen: Decimal,
    pub total: Decimal,
}

/// 查询交易记录
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct QueryTransactionHistoryQuery {
    pub customer_id: String,
    pub transaction_type: Option<TransactionType>,
    pub currency: Option<String>,
    pub date_range: Option<DateRange>,
    pub pagination: Pagination,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum TransactionType {
    Payment,
    Receipt,
    Deposit,
    Withdraw,
    FxDeal,
    Fee,
}

/// 查询付款状态
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct QueryPaymentStatusQuery {
    pub customer_id: String,
    pub payment_id: String,
}

/// 查询收款记录
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct QueryReceiptHistoryQuery {
    pub customer_id: String,
    pub date_range: Option<DateRange>,
    pub pagination: Pagination,
}

// ----------------------------------------------------------------------------
// 换汇相关 Queries
// ----------------------------------------------------------------------------

/// 查询实时汇率
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct QueryFxRateQuery {
    pub source_currency: String,
    pub target_currency: String,
    pub amount: Option<Decimal>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct FxRateResult {
    pub source_currency: String,
    pub target_currency: String,
    pub buy_rate: Decimal,
    pub sell_rate: Decimal,
    pub mid_rate: Decimal,
    pub valid_until: DateTime<Utc>,
}

/// 查询汇率历史
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct QueryFxHistoryQuery {
    pub source_currency: String,
    pub target_currency: String,
    pub date_range: DateRange,
    pub granularity: FxGranularity,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum FxGranularity {
    Minute,
    Hour,
    Day,
}

// ----------------------------------------------------------------------------
// 收款人相关 Queries
// ----------------------------------------------------------------------------

/// 查询收款人列表
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct QueryBeneficiaryListQuery {
    pub customer_id: String,
    pub country: Option<String>,
    pub keyword: Option<String>,
    pub pagination: Pagination,
}

// ----------------------------------------------------------------------------
// 银行卡相关 Queries
// ----------------------------------------------------------------------------

/// 查询绑定银行卡
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct QueryBoundCardsQuery {
    pub customer_id: String,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct BoundCardResult {
    pub card_id: String,
    pub card_number_masked: String,  // **** **** **** 1234
    pub bank_name: String,
    pub card_type: String,
    pub is_default: bool,
    pub bindtime: DateTime<Utc>,
}

// ----------------------------------------------------------------------------
// 申诉相关 Queries
// ----------------------------------------------------------------------------

/// 查询申诉进度
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct QueryComplaintStatusQuery {
    pub customer_id: String,
    pub complaint_id: Option<String>,  // None表示查询所有申诉
    pub pagination: Option<Pagination>,
}

// ----------------------------------------------------------------------------
// 对账单相关 Queries
// ----------------------------------------------------------------------------

/// 下载交易对账单
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DownloadStatementQuery {
    pub customer_id: String,
    pub date_range: DateRange,
    pub format: StatementFormat,
    pub include_details: bool,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum StatementFormat {
    Pdf,
    Excel,
    Csv,
}

// ----------------------------------------------------------------------------
// 商户专属 Queries
// ----------------------------------------------------------------------------

/// 查询API调用记录
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct QueryApiLogsQuery {
    pub merchant_id: String,
    pub api_endpoint: Option<String>,
    pub status_code: Option<u16>,
    pub date_range: Option<DateRange>,
    pub pagination: Pagination,
}

/// 查询结算记录
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct QuerySettlementHistoryQuery {
    pub merchant_id: String,
    pub settlement_status: Option<SettlementStatus>,
    pub date_range: Option<DateRange>,
    pub pagination: Pagination,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum SettlementStatus {
    Pending,
    Processing,
    Completed,
    Failed,
}
```

### 3.8 L4-Command 映射总览

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                           L4 业务任务 → Command 映射总表                                          │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              汇出汇款域 Commands                                         │   │
│  ├──────────────────┬──────────────────────────────┬───────────────────────────────────────┤   │
│  │ L4 任务          │ Command                      │ Handler                               │   │
│  ├──────────────────┼──────────────────────────────┼───────────────────────────────────────┤   │
│  │ 创建付款订单     │ CreatePaymentOrderCommand    │ CreatePaymentOrderHandler             │   │
│  │ 贸易背景审核     │ ReviewTradeBackgroundCommand │ ReviewTradeBackgroundHandler          │   │
│  │ 风险评估审查     │ AssessRiskCommand            │ AssessRiskHandler                     │   │
│  │ 换汇报价获取     │ RequestFxQuoteCommand        │ RequestFxQuoteHandler                 │   │
│  │ 换汇执行         │ ExecuteFxDealCommand         │ ExecuteFxDealHandler                  │   │
│  │ 通道路由选择     │ SelectChannelRouteCommand    │ SelectChannelRouteHandler             │   │
│  │ 资金冻结         │ FreezeBalanceCommand         │ FreezeBalanceHandler                  │   │
│  │ 通道出款提交     │ SubmitToChannelCommand       │ SubmitToChannelHandler                │   │
│  │ 出款状态跟踪     │ UpdatePaymentStatusCommand   │ UpdatePaymentStatusHandler            │   │
│  │ 完成通知发送     │ SendCompletionNoticeCommand  │ SendCompletionNoticeHandler           │   │
│  │ 取消订单         │ CancelPaymentOrderCommand    │ CancelPaymentOrderHandler             │   │
│  │ 退款处理         │ RefundPaymentCommand         │ RefundPaymentHandler                  │   │
│  └──────────────────┴──────────────────────────────┴───────────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              风控合规域 Commands                                         │   │
│  ├──────────────────┬──────────────────────────────┬───────────────────────────────────────┤   │
│  │ L4 任务          │ Command                      │ Handler                               │   │
│  ├──────────────────┼──────────────────────────────┼───────────────────────────────────────┤   │
│  │ 制裁名单筛查     │ ScreenSanctionListCommand    │ ScreenSanctionListHandler             │   │
│  │ 反洗钱规则检测   │ DetectAmlViolationCommand    │ DetectAmlViolationHandler             │   │
│  │ 欺诈检测         │ DetectFraudCommand           │ DetectFraudHandler                    │   │
│  │ 额度校验         │ ValidateLimitCommand         │ ValidateLimitHandler                  │   │
│  │ 人工审核分配     │ AssignManualReviewCommand    │ AssignManualReviewHandler             │   │
│  │ 审核决策记录     │ RecordReviewDecisionCommand  │ RecordReviewDecisionHandler           │   │
│  │ 可疑交易报告生成 │ GenerateSarReportCommand     │ GenerateSarReportHandler              │   │
│  │ KYC验证          │ VerifyKycCommand             │ VerifyKycHandler                      │   │
│  │ KYB验证          │ VerifyKybCommand             │ VerifyKybHandler                      │   │
│  └──────────────────┴──────────────────────────────┴───────────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              换汇域 Commands                                             │   │
│  ├──────────────────┬──────────────────────────────┬───────────────────────────────────────┤   │
│  │ L4 任务          │ Command                      │ Handler                               │   │
│  ├──────────────────┼──────────────────────────────┼───────────────────────────────────────┤   │
│  │ 汇率询价         │ QueryFxRateCommand           │ QueryFxRateHandler                    │   │
│  │ 最优报价聚合     │ AggregateBestQuoteCommand    │ AggregateBestQuoteHandler             │   │
│  │ 客户报价计算     │ CalculateCustomerRateCommand │ CalculateCustomerRateHandler          │   │
│  │ 报价锁定         │ LockFxQuoteCommand           │ LockFxQuoteHandler                    │   │
│  │ 换汇成交         │ ExecuteFxDealCommand         │ ExecuteFxDealHandler                  │   │
│  │ 头寸更新         │ UpdatePositionCommand        │ UpdatePositionHandler                 │   │
│  │ 对冲触发判断     │ EvaluateHedgeTriggerCommand  │ EvaluateHedgeTriggerHandler           │   │
│  │ 对冲执行         │ ExecuteHedgeCommand          │ ExecuteHedgeHandler                   │   │
│  └──────────────────┴──────────────────────────────┴───────────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              清结算域 Commands                                           │   │
│  ├──────────────────┬──────────────────────────────┬───────────────────────────────────────┤   │
│  │ L4 任务          │ Command                      │ Handler                               │   │
│  ├──────────────────┼──────────────────────────────┼───────────────────────────────────────┤   │
│  │ 交易汇总         │ SummarizeTransactionsCommand │ SummarizeTransactionsHandler          │   │
│  │ 轧差计算         │ CalculateNettingCommand      │ CalculateNettingHandler               │   │
│  │ 清算文件生成     │ GenerateClearingFileCommand  │ GenerateClearingFileHandler           │   │
│  │ 清算指令发送     │ SendClearingInstructionCmd   │ SendClearingInstructionHandler        │   │
│  │ 清算结果接收     │ ReceiveClearingResultCommand │ ReceiveClearingResultHandler          │   │
│  │ 对账文件获取     │ FetchReconciliationFileCmd   │ FetchReconciliationFileHandler        │   │
│  │ 自动对账         │ ExecuteAutoReconcileCommand  │ ExecuteAutoReconcileHandler           │   │
│  │ 差异处理         │ HandleDiscrepancyCommand     │ HandleDiscrepancyHandler              │   │
│  └──────────────────┴──────────────────────────────┴───────────────────────────────────────┘   │
│                                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                              账户域 Commands                                             │   │
│  ├──────────────────┬──────────────────────────────┬───────────────────────────────────────┤   │
│  │ L4 任务          │ Command                      │ Handler                               │   │
│  ├──────────────────┼──────────────────────────────┼───────────────────────────────────────┤   │
│  │ 创建账户         │ CreateAccountCommand         │ CreateAccountHandler                  │   │
│  │ 创建钱包         │ CreateWalletCommand          │ CreateWalletHandler                   │   │
│  │ 充值             │ DepositCommand               │ DepositHandler                        │   │
│  │ 提现             │ WithdrawCommand              │ WithdrawHandler                       │   │
│  │ 冻结资金         │ FreezeBalanceCommand         │ FreezeBalanceHandler                  │   │
│  │ 解冻资金         │ UnfreezeBalanceCommand       │ UnfreezeBalanceHandler                │   │
│  │ 转账             │ TransferCommand              │ TransferHandler                       │   │
│  │ 调账             │ AdjustBalanceCommand         │ AdjustBalanceHandler                  │   │
│  └──────────────────┴──────────────────────────────┴───────────────────────────────────────┘   │
│                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.9 汇出汇款域 L4 任务与Command

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L3.1.1 B2B贸易付款流程 → L4 业务任务 → Command                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ L4.1.1.1 创建付款订单                                                        │
│ ├── Command: CreatePaymentOrderCommand                                      │
│ ├── 输入: 付款申请信息、发票、合同                                           │
│ ├── 输出: 付款订单                                                          │
│ ├── 执行角色: 企业财务                                                       │
│ ├── SLA: 实时                                                               │
│ └── 产生事件: PaymentOrderCreatedEvent                                      │
│                                                                             │
│ L4.1.1.2 贸易背景审核                                                        │
│ ├── Command: ReviewTradeBackgroundCommand                                   │
│ ├── 输入: 付款订单、贸易单据                                                 │
│ ├── 输出: 审核结果                                                          │
│ ├── 执行角色: 合规审核员/系统自动                                            │
│ ├── SLA: ≤ 4小时 (自动) / ≤ 24小时 (人工)                                   │
│ └── 产生事件: TradeBackgroundReviewedEvent                                  │
│                                                                             │
│ L4.1.1.3 风险评估审查                                                        │
│ ├── Command: AssessRiskCommand                                              │
│ ├── 输入: 付款订单、客户信息                                                 │
│ ├── 输出: 风险评分、审查结论                                                 │
│ ├── 执行角色: 风控系统/风控专员                                              │
│ ├── SLA: ≤ 30秒 (自动) / ≤ 2小时 (人工)                                     │
│ └── 产生事件: RiskAssessedEvent                                             │
│                                                                             │
│ L4.1.1.4 换汇报价获取                                                        │
│ ├── Command: RequestFxQuoteCommand                                          │
│ ├── 输入: 源币种、目标币种、金额                                             │
│ ├── 输出: 汇率报价 (30秒有效)                                               │
│ ├── 执行角色: 系统自动                                                       │
│ ├── SLA: ≤ 100ms                                                            │
│ └── 产生事件: FxQuoteRequestedEvent                                         │
│                                                                             │
│ L4.1.1.5 换汇执行                                                            │
│ ├── Command: ExecuteFxDealCommand                                           │
│ ├── 输入: 确认的汇率报价                                                     │
│ ├── 输出: 换汇成交记录                                                       │
│ ├── 执行角色: 系统自动                                                       │
│ ├── SLA: ≤ 500ms                                                            │
│ └── 产生事件: FxDealExecutedEvent                                           │
│                                                                             │
│ L4.1.1.6 通道路由选择                                                        │
│ ├── Command: SelectChannelRouteCommand                                      │
│ ├── 输入: 付款订单、目标国家/银行                                            │
│ ├── 输出: 最优通道决策                                                       │
│ ├── 执行角色: 系统自动                                                       │
│ ├── SLA: ≤ 200ms                                                            │
│ └── 产生事件: ChannelRouteSelectedEvent                                     │
│                                                                             │
│ L4.1.1.7 资金冻结                                                            │
│ ├── Command: FreezeBalanceCommand                                           │
│ ├── 输入: 付款订单、账户信息                                                 │
│ ├── 输出: 冻结记录                                                          │
│ ├── 执行角色: 系统自动                                                       │
│ ├── SLA: ≤ 100ms                                                            │
│ └── 产生事件: BalanceFrozenEvent                                            │
│                                                                             │
│ L4.1.1.8 通道出款提交                                                        │
│ ├── Command: SubmitToChannelCommand                                         │
│ ├── 输入: 付款指令、通道配置                                                 │
│ ├── 输出: 通道提交确认                                                       │
│ ├── 执行角色: 系统自动                                                       │
│ ├── SLA: ≤ 3秒                                                              │
│ └── 产生事件: ChannelSubmittedEvent                                         │
│                                                                             │
│ L4.1.1.9 出款状态跟踪                                                        │
│ ├── Command: UpdatePaymentStatusCommand                                     │
│ ├── 输入: 通道订单号                                                         │
│ ├── 输出: 出款状态更新                                                       │
│ ├── 执行角色: 系统自动                                                       │
│ ├── SLA: 实时/轮询                                                          │
│ └── 产生事件: PaymentStatusUpdatedEvent                                     │
│                                                                             │
│ L4.1.1.10 完成通知发送                                                       │
│ ├── Command: SendCompletionNoticeCommand                                    │
│ ├── 输入: 订单完成状态                                                       │
│ ├── 输出: 通知记录                                                          │
│ ├── 执行角色: 系统自动                                                       │
│ ├── SLA: ≤ 1秒                                                              │
│ └── 产生事件: CompletionNoticeSentEvent                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.9.1 Command 定义 (Rust)

```rust
// ============================================================================
// 汇出汇款域 Commands
// ============================================================================

/// L4.1.1.1 创建付款订单命令
#[derive(Debug, Clone)]
pub struct CreatePaymentOrderCommand {
    // 命令元数据
    pub command_id: CommandId,
    pub idempotency_key: IdempotencyKey,
    pub timestamp: DateTime<Utc>,
    pub operator_id: OperatorId,

    // 业务数据
    pub merchant_id: MerchantId,
    pub order_type: OrderType,
    pub source: PaymentSource,
    pub destination: PaymentDestination,
    pub amount: Money,
    pub purpose: PaymentPurpose,
    pub reference: Option<String>,
    pub attachments: Vec<Attachment>,
}

/// L4.1.1.2 贸易背景审核命令
#[derive(Debug, Clone)]
pub struct ReviewTradeBackgroundCommand {
    pub command_id: CommandId,
    pub order_id: OrderId,
    pub reviewer_id: Option<ReviewerId>,  // None = 自动审核
    pub trade_documents: Vec<TradeDocument>,
    pub review_type: ReviewType,
}

/// L4.1.1.3 风险评估审查命令
#[derive(Debug, Clone)]
pub struct AssessRiskCommand {
    pub command_id: CommandId,
    pub order_id: OrderId,
    pub assessment_type: AssessmentType,
    pub override_score: Option<RiskScore>,  // 人工覆盖评分
    pub assessor_id: Option<AssessorId>,
}

/// L4.1.1.4 换汇报价请求命令
#[derive(Debug, Clone)]
pub struct RequestFxQuoteCommand {
    pub command_id: CommandId,
    pub order_id: OrderId,
    pub source_currency: CurrencyCode,
    pub dest_currency: CurrencyCode,
    pub amount: Decimal,
    pub direction: FxDirection,  // Buy / Sell
    pub quote_type: QuoteType,   // Indicative / Firm
}

/// L4.1.1.5 换汇执行命令
#[derive(Debug, Clone)]
pub struct ExecuteFxDealCommand {
    pub command_id: CommandId,
    pub order_id: OrderId,
    pub quote_id: QuoteId,
    pub confirmed_rate: Decimal,
}

/// L4.1.1.6 通道路由选择命令
#[derive(Debug, Clone)]
pub struct SelectChannelRouteCommand {
    pub command_id: CommandId,
    pub order_id: OrderId,
    pub preferred_channel: Option<ChannelId>,
    pub routing_priority: RoutingPriority,  // Cost / Speed / Reliability
    pub exclude_channels: Vec<ChannelId>,
}

/// L4.1.1.7 资金冻结命令
#[derive(Debug, Clone)]
pub struct FreezeBalanceCommand {
    pub command_id: CommandId,
    pub account_id: AccountId,
    pub wallet_id: WalletId,
    pub amount: Decimal,
    pub currency: CurrencyCode,
    pub reference_type: ReferenceType,
    pub reference_id: String,
    pub reason: FreezeReason,
}

/// L4.1.1.8 通道出款提交命令
#[derive(Debug, Clone)]
pub struct SubmitToChannelCommand {
    pub command_id: CommandId,
    pub order_id: OrderId,
    pub channel_id: ChannelId,
    pub payment_instruction: PaymentInstruction,
    pub priority: PaymentPriority,
}

/// L4.1.1.9 出款状态更新命令
#[derive(Debug, Clone)]
pub struct UpdatePaymentStatusCommand {
    pub command_id: CommandId,
    pub order_id: OrderId,
    pub channel_ref: String,
    pub new_status: PaymentStatus,
    pub status_reason: Option<String>,
    pub channel_timestamp: DateTime<Utc>,
}

/// L4.1.1.10 完成通知发送命令
#[derive(Debug, Clone)]
pub struct SendCompletionNoticeCommand {
    pub command_id: CommandId,
    pub order_id: OrderId,
    pub notification_type: NotificationType,
    pub channels: Vec<NotificationChannel>,  // Email, SMS, Webhook
    pub template_id: TemplateId,
}

/// 取消订单命令
#[derive(Debug, Clone)]
pub struct CancelPaymentOrderCommand {
    pub command_id: CommandId,
    pub order_id: OrderId,
    pub reason: CancellationReason,
    pub operator_id: OperatorId,
}

/// 退款命令
#[derive(Debug, Clone)]
pub struct RefundPaymentCommand {
    pub command_id: CommandId,
    pub order_id: OrderId,
    pub refund_amount: Decimal,
    pub refund_reason: RefundReason,
    pub operator_id: OperatorId,
}
```

### 3.10 风控合规域 L4 任务与Command

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L2.5 风控合规域 → L4 业务任务 → Command                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ L4.5.1 制裁名单筛查                                                          │
│ ├── Command: ScreenSanctionListCommand                                      │
│ ├── 输入: 交易方名称、证件号、地址                                           │
│ ├── 输出: 筛查结果 (命中/未命中/疑似)                                        │
│ ├── 数据源: OFAC, UN, EU, 本地名单                                          │
│ ├── SLA: ≤ 500ms                                                            │
│ └── 产生事件: SanctionScreenedEvent                                         │
│                                                                             │
│ L4.5.2 反洗钱规则检测                                                        │
│ ├── Command: DetectAmlViolationCommand                                      │
│ ├── 输入: 交易信息、历史交易                                                 │
│ ├── 输出: AML风险评分、触发规则                                              │
│ ├── 规则库: 结构化拆分、快进快出、异常模式                                   │
│ ├── SLA: ≤ 1秒                                                              │
│ └── 产生事件: AmlViolationDetectedEvent                                     │
│                                                                             │
│ L4.5.3 欺诈检测                                                              │
│ ├── Command: DetectFraudCommand                                             │
│ ├── 输入: 交易信息、设备信息、行为数据                                       │
│ ├── 输出: 欺诈风险评分                                                       │
│ ├── 模型: ML模型 + 规则引擎                                                  │
│ ├── SLA: ≤ 200ms                                                            │
│ └── 产生事件: FraudDetectedEvent                                            │
│                                                                             │
│ L4.5.4 额度校验                                                              │
│ ├── Command: ValidateLimitCommand                                           │
│ ├── 输入: 交易金额、客户ID                                                   │
│ ├── 输出: 额度校验结果                                                       │
│ ├── 校验维度: 单笔、日累计、月累计                                           │
│ ├── SLA: ≤ 50ms                                                             │
│ └── 产生事件: LimitValidatedEvent                                           │
│                                                                             │
│ L4.5.5 人工审核分配                                                          │
│ ├── Command: AssignManualReviewCommand                                      │
│ ├── 输入: 待审订单                                                          │
│ ├── 输出: 审核任务分配                                                       │
│ ├── 分配规则: 负载均衡、技能匹配                                             │
│ ├── SLA: ≤ 1分钟                                                            │
│ └── 产生事件: ManualReviewAssignedEvent                                     │
│                                                                             │
│ L4.5.6 审核决策记录                                                          │
│ ├── Command: RecordReviewDecisionCommand                                    │
│ ├── 输入: 审核结论、审核意见                                                 │
│ ├── 输出: 审核记录                                                          │
│ ├── 要求: 完整审计轨迹                                                       │
│ ├── SLA: 实时                                                               │
│ └── 产生事件: ReviewDecisionRecordedEvent                                   │
│                                                                             │
│ L4.5.7 可疑交易报告生成                                                      │
│ ├── Command: GenerateSarReportCommand                                       │
│ ├── 输入: 可疑交易信息                                                       │
│ ├── 输出: STR/SAR报告                                                       │
│ ├── 格式: 监管要求格式                                                       │
│ ├── SLA: ≤ 24小时                                                           │
│ └── 产生事件: SarReportGeneratedEvent                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.10.1 风控合规域 Command 定义

```rust
// ============================================================================
// 风控合规域 Commands
// ============================================================================

/// L4.5.1 制裁名单筛查命令
#[derive(Debug, Clone)]
pub struct ScreenSanctionListCommand {
    pub command_id: CommandId,
    pub order_id: OrderId,
    pub entities: Vec<ScreeningEntity>,
    pub screening_sources: Vec<SanctionSource>,  // OFAC, UN, EU, LOCAL
}

#[derive(Debug, Clone)]
pub struct ScreeningEntity {
    pub entity_type: EntityType,  // Payer, Payee, Intermediary
    pub name: String,
    pub aliases: Vec<String>,
    pub id_number: Option<String>,
    pub id_type: Option<IdType>,
    pub address: Option<Address>,
    pub country: CountryCode,
    pub date_of_birth: Option<NaiveDate>,
}

/// L4.5.2 反洗钱规则检测命令
#[derive(Debug, Clone)]
pub struct DetectAmlViolationCommand {
    pub command_id: CommandId,
    pub order_id: OrderId,
    pub transaction: TransactionData,
    pub customer_id: CustomerId,
    pub detection_rules: Vec<AmlRuleId>,  // 空则执行全部规则
}

#[derive(Debug, Clone)]
pub struct TransactionData {
    pub amount: Decimal,
    pub currency: CurrencyCode,
    pub source_country: CountryCode,
    pub dest_country: CountryCode,
    pub transaction_type: TransactionType,
    pub timestamp: DateTime<Utc>,
}

/// L4.5.3 欺诈检测命令
#[derive(Debug, Clone)]
pub struct DetectFraudCommand {
    pub command_id: CommandId,
    pub order_id: OrderId,
    pub transaction: TransactionData,
    pub device_fingerprint: Option<DeviceFingerprint>,
    pub behavior_signals: Vec<BehaviorSignal>,
    pub ip_address: Option<IpAddr>,
}

/// L4.5.4 额度校验命令
#[derive(Debug, Clone)]
pub struct ValidateLimitCommand {
    pub command_id: CommandId,
    pub customer_id: CustomerId,
    pub amount: Decimal,
    pub currency: CurrencyCode,
    pub limit_types: Vec<LimitType>,  // Single, Daily, Monthly
}

/// L4.5.5 人工审核分配命令
#[derive(Debug, Clone)]
pub struct AssignManualReviewCommand {
    pub command_id: CommandId,
    pub order_id: OrderId,
    pub review_type: ManualReviewType,
    pub priority: ReviewPriority,
    pub required_skills: Vec<ReviewerSkill>,
    pub deadline: Option<DateTime<Utc>>,
}

/// L4.5.6 审核决策记录命令
#[derive(Debug, Clone)]
pub struct RecordReviewDecisionCommand {
    pub command_id: CommandId,
    pub review_task_id: ReviewTaskId,
    pub order_id: OrderId,
    pub reviewer_id: ReviewerId,
    pub decision: ReviewDecision,
    pub reason: String,
    pub supporting_documents: Vec<DocumentRef>,
}

#[derive(Debug, Clone)]
pub enum ReviewDecision {
    Approve,
    Reject { reason_code: RejectReasonCode },
    Escalate { to_level: EscalationLevel },
    RequestInfo { info_type: InfoRequestType },
}

/// L4.5.7 可疑交易报告生成命令
#[derive(Debug, Clone)]
pub struct GenerateSarReportCommand {
    pub command_id: CommandId,
    pub order_id: OrderId,
    pub suspicious_activity: SuspiciousActivityType,
    pub narrative: String,
    pub supporting_transactions: Vec<OrderId>,
    pub reporting_jurisdiction: Jurisdiction,
}
```

### 3.11 换汇域 L4 任务与Command

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L2.3 换汇域 → L4 业务任务 → Command                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ L4.3.1 汇率询价                                                              │
│ ├── Command: QueryFxRateCommand                                             │
│ ├── 输入: 币种对、金额、方向                                                 │
│ ├── 输出: 多源汇率报价                                                       │
│ ├── 数据源: 银行、流动性提供商                                               │
│ ├── SLA: ≤ 50ms                                                             │
│ └── 产生事件: FxRateQueriedEvent                                            │
│                                                                             │
│ L4.3.2 最优报价聚合                                                          │
│ ├── Command: AggregateBestQuoteCommand                                      │
│ ├── 输入: 多源汇率报价                                                       │
│ ├── 输出: 最优执行价格                                                       │
│ ├── 策略: 最优价格、加权平均                                                 │
│ ├── SLA: ≤ 20ms                                                             │
│ └── 产生事件: BestQuoteAggregatedEvent                                      │
│                                                                             │
│ L4.3.3 客户报价计算                                                          │
│ ├── Command: CalculateCustomerRateCommand                                   │
│ ├── 输入: 银行间汇率、客户等级                                               │
│ ├── 输出: 客户汇率 (含加点)                                                  │
│ ├── 规则: 阶梯定价、协议定价                                                 │
│ ├── SLA: ≤ 10ms                                                             │
│ └── 产生事件: CustomerRateCalculatedEvent                                   │
│                                                                             │
│ L4.3.4 报价锁定                                                              │
│ ├── Command: LockFxQuoteCommand                                             │
│ ├── 输入: 客户确认的报价                                                     │
│ ├── 输出: 锁定的报价记录                                                     │
│ ├── 有效期: 30秒                                                            │
│ ├── SLA: ≤ 50ms                                                             │
│ └── 产生事件: FxQuoteLockedEvent                                            │
│                                                                             │
│ L4.3.5 换汇成交                                                              │
│ ├── Command: ExecuteFxDealCommand                                           │
│ ├── 输入: 锁定的报价                                                         │
│ ├── 输出: 成交记录                                                          │
│ ├── 操作: 更新头寸、记账                                                     │
│ ├── SLA: ≤ 100ms                                                            │
│ └── 产生事件: FxDealExecutedEvent                                           │
│                                                                             │
│ L4.3.6 头寸更新                                                              │
│ ├── Command: UpdatePositionCommand                                          │
│ ├── 输入: 换汇成交记录                                                       │
│ ├── 输出: 更新后的币种头寸                                                   │
│ ├── 检查: 头寸限额                                                          │
│ ├── SLA: ≤ 50ms                                                             │
│ └── 产生事件: PositionUpdatedEvent                                          │
│                                                                             │
│ L4.3.7 对冲触发判断                                                          │
│ ├── Command: EvaluateHedgeTriggerCommand                                    │
│ ├── 输入: 当前头寸、限额配置                                                 │
│ ├── 输出: 是否需要对冲                                                       │
│ ├── 阈值: 70%限额利用率                                                     │
│ ├── SLA: ≤ 20ms                                                             │
│ └── 产生事件: HedgeTriggerEvaluatedEvent                                                             │
│                                                                             │
│ L4.3.8 对冲执行                                                              │
│ ├── Command: ExecuteHedgeCommand                                            │
│ ├── 输入: 对冲指令、目标头寸                                                 │
│ ├── 输出: 对冲成交确认                                                       │
│ ├── 通道: 银行间市场/流动性提供商                                            │
│ ├── SLA: ≤ 5秒                                                              │
│ └── 产生事件: HedgeExecutedEvent                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.11.1 换汇域 Command 定义

```rust
// ============================================================================
// 换汇域 Commands
// ============================================================================

/// L4.3.1 汇率询价命令
#[derive(Debug, Clone)]
pub struct QueryFxRateCommand {
    pub command_id: CommandId,
    pub idempotency_key: IdempotencyKey,
    pub timestamp: DateTime<Utc>,

    // 询价参数
    pub source_currency: CurrencyCode,
    pub dest_currency: CurrencyCode,
    pub amount: Decimal,
    pub direction: FxDirection,      // Buy / Sell
    pub quote_type: QuoteType,       // Indicative / Firm
    pub liquidity_providers: Vec<LiquidityProviderId>,  // 指定LP，空则查询全部
}

#[derive(Debug, Clone, PartialEq)]
pub enum FxDirection {
    Buy,   // 买入目标币种
    Sell,  // 卖出目标币种
}

#[derive(Debug, Clone, PartialEq)]
pub enum QuoteType {
    Indicative,  // 参考报价
    Firm,        // 可成交报价
}

/// L4.3.2 最优报价聚合命令
#[derive(Debug, Clone)]
pub struct AggregateBestQuoteCommand {
    pub command_id: CommandId,
    pub inquiry_id: InquiryId,
    pub lp_quotes: Vec<LpQuote>,
    pub aggregation_strategy: AggregationStrategy,
}

#[derive(Debug, Clone)]
pub struct LpQuote {
    pub lp_id: LiquidityProviderId,
    pub bid_rate: Decimal,
    pub ask_rate: Decimal,
    pub spread: Decimal,
    pub available_amount: Decimal,
    pub valid_until: DateTime<Utc>,
    pub tier: PricingTier,
}

#[derive(Debug, Clone, PartialEq)]
pub enum AggregationStrategy {
    BestPrice,           // 最优价格
    WeightedAverage,     // 加权平均
    VolumeWeighted,      // 成交量加权
    TimePriority,        // 时间优先
}

/// L4.3.3 客户报价计算命令
#[derive(Debug, Clone)]
pub struct CalculateCustomerRateCommand {
    pub command_id: CommandId,
    pub order_id: OrderId,
    pub best_market_rate: Decimal,
    pub customer_id: CustomerId,
    pub merchant_id: MerchantId,
    pub amount: Decimal,
    pub currency_pair: CurrencyPair,
}

#[derive(Debug, Clone)]
pub struct CurrencyPair {
    pub base: CurrencyCode,
    pub quote: CurrencyCode,
}

/// L4.3.4 报价锁定命令
#[derive(Debug, Clone)]
pub struct LockFxQuoteCommand {
    pub command_id: CommandId,
    pub order_id: OrderId,
    pub quote_id: QuoteId,
    pub customer_rate: Decimal,
    pub source_amount: Decimal,
    pub dest_amount: Decimal,
    pub lock_duration_seconds: u32,  // 默认30秒
}

/// L4.3.5 换汇成交命令
#[derive(Debug, Clone)]
pub struct ExecuteFxDealCommand {
    pub command_id: CommandId,
    pub idempotency_key: IdempotencyKey,
    pub order_id: OrderId,
    pub quote_id: QuoteId,
    pub confirmed_rate: Decimal,
    pub source_amount: Decimal,
    pub dest_amount: Decimal,
    pub value_date: NaiveDate,
}

/// L4.3.6 头寸更新命令
#[derive(Debug, Clone)]
pub struct UpdatePositionCommand {
    pub command_id: CommandId,
    pub deal_id: DealId,
    pub currency_pair: CurrencyPair,
    pub position_change: Decimal,      // 正数为多头，负数为空头
    pub change_type: PositionChangeType,
    pub timestamp: DateTime<Utc>,
}

#[derive(Debug, Clone, PartialEq)]
pub enum PositionChangeType {
    CustomerDeal,    // 客户成交
    HedgeDeal,       // 对冲成交
    PositionAdjust,  // 手工调整
    Settlement,      // 结算
}

/// L4.3.7 对冲触发判断命令
#[derive(Debug, Clone)]
pub struct EvaluateHedgeTriggerCommand {
    pub command_id: CommandId,
    pub currency_pair: CurrencyPair,
    pub current_position: Decimal,
    pub position_limit: PositionLimit,
    pub market_conditions: MarketConditions,
}

#[derive(Debug, Clone)]
pub struct PositionLimit {
    pub intraday_limit: Decimal,
    pub overnight_limit: Decimal,
    pub warning_threshold_pct: Decimal,  // 告警阈值百分比，如 70%
    pub hard_limit_pct: Decimal,         // 硬限额百分比，如 90%
}

#[derive(Debug, Clone)]
pub struct MarketConditions {
    pub volatility_level: VolatilityLevel,
    pub liquidity_score: u8,  // 1-10
    pub market_session: MarketSession,
    pub is_holiday: bool,
}

#[derive(Debug, Clone, PartialEq)]
pub enum VolatilityLevel {
    Low,
    Normal,
    High,
    Extreme,
}

#[derive(Debug, Clone, PartialEq)]
pub enum MarketSession {
    Asian,
    European,
    American,
    Overlap,
    Closed,
}

/// L4.3.8 对冲执行命令
#[derive(Debug, Clone)]
pub struct ExecuteHedgeCommand {
    pub command_id: CommandId,
    pub idempotency_key: IdempotencyKey,
    pub hedge_request_id: HedgeRequestId,
    pub currency_pair: CurrencyPair,
    pub hedge_amount: Decimal,
    pub direction: FxDirection,
    pub target_lps: Vec<LiquidityProviderId>,
    pub execution_style: ExecutionStyle,
    pub price_limit: Option<Decimal>,
    pub urgency: HedgeUrgency,
}

#[derive(Debug, Clone, PartialEq)]
pub enum ExecutionStyle {
    Aggressive,  // 立即成交
    Passive,     // 挂单等待
    Iceberg,     // 冰山订单
    Twap,        // 时间加权平均
}

#[derive(Debug, Clone, PartialEq)]
pub enum HedgeUrgency {
    Immediate,   // 立即
    Normal,      // 正常
    Opportunistic, // 机会性
}
```

### 3.12 清结算域 L4 任务与Command

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L2.4 清结算域 → L4 业务任务 → Command                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ L4.4.1 交易汇总                                                              │
│ ├── Command: SummarizeTransactionsCommand                                   │
│ ├── 输入: 日终交易记录、汇总维度                                             │
│ ├── 输出: 按通道/币种/商户汇总报表                                           │
│ ├── 时点: T日 EOD                                                           │
│ ├── SLA: ≤ 30分钟                                                           │
│ └── 产生事件: TransactionsSummarizedEvent                                   │
│                                                                             │
│ L4.4.2 轧差计算                                                              │
│ ├── Command: CalculateNettingCommand                                        │
│ ├── 输入: 交易汇总数据、轧差规则                                             │
│ ├── 输出: 净额清算金额                                                       │
│ ├── 方式: 双边净额、多边净额                                                 │
│ ├── SLA: ≤ 10分钟                                                           │
│ └── 产生事件: NettingCalculatedEvent                                        │
│                                                                             │
│ L4.4.3 清算文件生成                                                          │
│ ├── Command: GenerateClearingFileCommand                                    │
│ ├── 输入: 轧差结果、文件格式配置                                             │
│ ├── 输出: 清算指令文件                                                       │
│ ├── 格式: ISO 20022 / SWIFT MT / 通道专用                                   │
│ ├── SLA: ≤ 5分钟                                                            │
│ └── 产生事件: ClearingFileGeneratedEvent                                    │
│                                                                             │
│ L4.4.4 清算指令发送                                                          │
│ ├── Command: SendClearingInstructionCommand                                 │
│ ├── 输入: 清算指令文件、目标通道                                             │
│ ├── 输出: 发送确认、通道回执                                                 │
│ ├── 通道: SWIFT/本地清算/RTGS                                                │
│ ├── SLA: 按清算窗口                                                         │
│ └── 产生事件: ClearingInstructionSentEvent                                  │
│                                                                             │
│ L4.4.5 清算结果接收                                                          │
│ ├── Command: ReceiveClearingResultCommand                                   │
│ ├── 输入: 通道反馈消息                                                       │
│ ├── 输出: 清算状态更新                                                       │
│ ├── 处理: 成功/失败/部分/待确认                                              │
│ ├── SLA: 实时                                                               │
│ └── 产生事件: ClearingResultReceivedEvent                                   │
│                                                                             │
│ L4.4.6 对账文件获取                                                          │
│ ├── Command: FetchReconciliationFileCommand                                 │
│ ├── 输入: 对账日期、通道ID                                                   │
│ ├── 输出: 通道对账文件                                                       │
│ ├── 来源: SFTP/API/MQ                                                       │
│ ├── SLA: T+1 上午                                                           │
│ └── 产生事件: ReconciliationFileFetchedEvent                                │
│                                                                             │
│ L4.4.7 自动对账                                                              │
│ ├── Command: ExecuteAutoReconcileCommand                                    │
│ ├── 输入: 内部记录、通道对账单、匹配规则                                     │
│ ├── 输出: 对账结果 (平账/差异明细)                                           │
│ ├── 匹配规则: 金额容差、时间窗口、参考号模糊匹配                             │
│ ├── SLA: ≤ 1小时                                                            │
│ └── 产生事件: AutoReconcileCompletedEvent                                   │
│                                                                             │
│ L4.4.8 差异处理                                                              │
│ ├── Command: HandleDiscrepancyCommand                                       │
│ ├── 输入: 不平记录、处理策略                                                 │
│ ├── 输出: 调账/追索/挂账记录                                                 │
│ ├── 处理: 短款追索、长款退回、挂账待查                                       │
│ ├── SLA: ≤ 3工作日                                                          │
│ └── 产生事件: DiscrepancyHandledEvent                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.12.1 清结算域 Command 定义

```rust
// ============================================================================
// 清结算域 Commands
// ============================================================================

/// L4.4.1 交易汇总命令
#[derive(Debug, Clone)]
pub struct SummarizeTransactionsCommand {
    pub command_id: CommandId,
    pub settlement_date: NaiveDate,
    pub dimensions: Vec<SummaryDimension>,
    pub channel_ids: Option<Vec<ChannelId>>,  // None = 全部通道
    pub include_pending: bool,
}

#[derive(Debug, Clone, PartialEq)]
pub enum SummaryDimension {
    Channel,
    Currency,
    Merchant,
    OrderType,
    Country,
}

/// L4.4.2 轧差计算命令
#[derive(Debug, Clone)]
pub struct CalculateNettingCommand {
    pub command_id: CommandId,
    pub settlement_date: NaiveDate,
    pub netting_type: NettingType,
    pub channel_id: ChannelId,
    pub currency: CurrencyCode,
    pub transaction_summary_id: SummaryId,
}

#[derive(Debug, Clone, PartialEq)]
pub enum NettingType {
    Bilateral,     // 双边净额
    Multilateral,  // 多边净额
    Gross,         // 全额清算（无轧差）
}

/// L4.4.3 清算文件生成命令
#[derive(Debug, Clone)]
pub struct GenerateClearingFileCommand {
    pub command_id: CommandId,
    pub netting_result_id: NettingResultId,
    pub file_format: ClearingFileFormat,
    pub channel_id: ChannelId,
    pub value_date: NaiveDate,
    pub priority: ClearingPriority,
}

#[derive(Debug, Clone, PartialEq)]
pub enum ClearingFileFormat {
    Iso20022Pacs008,   // ISO 20022 Customer Credit Transfer
    Iso20022Pacs009,   // ISO 20022 Financial Institution Credit Transfer
    SwiftMt103,        // SWIFT MT103
    SwiftMt202,        // SWIFT MT202
    ChannelSpecific(String),  // 通道专用格式
}

#[derive(Debug, Clone, PartialEq)]
pub enum ClearingPriority {
    Normal,
    High,
    Urgent,
}

/// L4.4.4 清算指令发送命令
#[derive(Debug, Clone)]
pub struct SendClearingInstructionCommand {
    pub command_id: CommandId,
    pub idempotency_key: IdempotencyKey,
    pub clearing_file_id: ClearingFileId,
    pub channel_id: ChannelId,
    pub delivery_method: DeliveryMethod,
    pub scheduled_time: Option<DateTime<Utc>>,  // None = 立即发送
}

#[derive(Debug, Clone, PartialEq)]
pub enum DeliveryMethod {
    SwiftNet,
    Sftp { host: String, path: String },
    Api { endpoint: String },
    Mq { queue: String },
}

/// L4.4.5 清算结果接收命令
#[derive(Debug, Clone)]
pub struct ReceiveClearingResultCommand {
    pub command_id: CommandId,
    pub channel_id: ChannelId,
    pub channel_reference: String,
    pub result_type: ClearingResultType,
    pub result_status: ClearingStatus,
    pub failure_reason: Option<ClearingFailureReason>,
    pub channel_timestamp: DateTime<Utc>,
    pub raw_message: Option<String>,
}

#[derive(Debug, Clone, PartialEq)]
pub enum ClearingResultType {
    Ack,           // 接收确认
    Nack,          // 拒绝
    StatusUpdate,  // 状态更新
    Final,         // 最终结果
}

#[derive(Debug, Clone, PartialEq)]
pub enum ClearingStatus {
    Accepted,
    Rejected,
    Pending,
    Settled,
    PartiallySettled,
    Failed,
}

#[derive(Debug, Clone)]
pub struct ClearingFailureReason {
    pub code: String,
    pub description: String,
    pub is_retryable: bool,
}

/// L4.4.6 对账文件获取命令
#[derive(Debug, Clone)]
pub struct FetchReconciliationFileCommand {
    pub command_id: CommandId,
    pub reconciliation_date: NaiveDate,
    pub channel_id: ChannelId,
    pub file_type: ReconciliationFileType,
    pub fetch_method: FetchMethod,
}

#[derive(Debug, Clone, PartialEq)]
pub enum ReconciliationFileType {
    DailyStatement,
    TransactionDetail,
    BalanceReport,
    FeeStatement,
}

#[derive(Debug, Clone)]
pub enum FetchMethod {
    Sftp { host: String, path: String, credentials: SftpCredentials },
    Api { endpoint: String, auth: ApiAuth },
    Email { mailbox: String },
    Manual,  // 人工上传
}

/// L4.4.7 自动对账命令
#[derive(Debug, Clone)]
pub struct ExecuteAutoReconcileCommand {
    pub command_id: CommandId,
    pub reconciliation_date: NaiveDate,
    pub channel_id: ChannelId,
    pub internal_records_query: RecordsQuery,
    pub external_file_id: FileId,
    pub matching_rules: Vec<MatchingRule>,
    pub tolerance_config: ToleranceConfig,
}

#[derive(Debug, Clone)]
pub struct RecordsQuery {
    pub date_range: DateRange,
    pub status_filter: Vec<PaymentStatus>,
    pub channel_filter: Option<ChannelId>,
}

#[derive(Debug, Clone)]
pub struct MatchingRule {
    pub rule_id: RuleId,
    pub rule_type: MatchingRuleType,
    pub priority: u8,
    pub is_mandatory: bool,
}

#[derive(Debug, Clone, PartialEq)]
pub enum MatchingRuleType {
    ExactAmount,
    AmountWithTolerance(Decimal),  // 金额容差
    ReferenceNumber,
    FuzzyReference,                 // 模糊参考号匹配
    TimeWindow(Duration),           // 时间窗口
    Composite(Vec<MatchingRuleType>),
}

#[derive(Debug, Clone)]
pub struct ToleranceConfig {
    pub amount_tolerance: Decimal,          // 金额容差（绝对值）
    pub amount_tolerance_pct: Decimal,      // 金额容差（百分比）
    pub time_tolerance_hours: u32,          // 时间容差（小时）
    pub allow_partial_match: bool,          // 允许部分匹配
}

/// L4.4.8 差异处理命令
#[derive(Debug, Clone)]
pub struct HandleDiscrepancyCommand {
    pub command_id: CommandId,
    pub discrepancy_id: DiscrepancyId,
    pub reconciliation_id: ReconciliationId,
    pub handling_action: DiscrepancyAction,
    pub operator_id: OperatorId,
    pub notes: Option<String>,
}

#[derive(Debug, Clone, PartialEq)]
pub enum DiscrepancyAction {
    AutoAdjust,                    // 自动调账
    ManualAdjust {
        adjustment_type: AdjustmentType,
        amount: Decimal,
        account_id: AccountId,
    },
    CreateChargeback {             // 发起追索
        reason: ChargebackReason,
        deadline: NaiveDate,
    },
    PendingInvestigation {         // 挂账待查
        expected_resolution_date: NaiveDate,
    },
    WriteOff {                     // 核销
        approval_id: ApprovalId,
    },
    Ignore {                       // 忽略（金额过小）
        reason: String,
    },
}

#[derive(Debug, Clone, PartialEq)]
pub enum AdjustmentType {
    CreditAdjustment,   // 贷方调整
    DebitAdjustment,    // 借方调整
    FeeAdjustment,      // 费用调整
    FxAdjustment,       // 汇差调整
}
```

### 3.13 账户域 L4 任务与Command

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L2.6 账户域 → L4 业务任务 → Command                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ L4.6.1 创建账户                                                              │
│ ├── Command: CreateAccountCommand                                           │
│ ├── 输入: 客户信息、账户类型                                                 │
│ ├── 输出: 账户ID                                                            │
│ ├── 执行角色: 系统/运营                                                      │
│ ├── SLA: ≤ 1秒                                                              │
│ └── 产生事件: AccountCreatedEvent                                           │
│                                                                             │
│ L4.6.2 创建钱包                                                              │
│ ├── Command: CreateWalletCommand                                            │
│ ├── 输入: 账户ID、币种                                                       │
│ ├── 输出: 钱包ID                                                            │
│ ├── 执行角色: 系统自动                                                       │
│ ├── SLA: ≤ 500ms                                                            │
│ └── 产生事件: WalletCreatedEvent                                            │
│                                                                             │
│ L4.6.3 充值                                                                  │
│ ├── Command: DepositCommand                                                 │
│ ├── 输入: 钱包ID、金额、来源                                                 │
│ ├── 输出: 交易流水号                                                         │
│ ├── 执行角色: 系统自动                                                       │
│ ├── SLA: ≤ 200ms                                                            │
│ └── 产生事件: DepositCompletedEvent                                         │
│                                                                             │
│ L4.6.4 提现                                                                  │
│ ├── Command: WithdrawCommand                                                │
│ ├── 输入: 钱包ID、金额、目标                                                 │
│ ├── 输出: 交易流水号                                                         │
│ ├── 执行角色: 系统自动                                                       │
│ ├── SLA: ≤ 200ms                                                            │
│ └── 产生事件: WithdrawCompletedEvent                                        │
│                                                                             │
│ L4.6.5 冻结资金                                                              │
│ ├── Command: FreezeBalanceCommand                                           │
│ ├── 输入: 钱包ID、金额、冻结原因                                             │
│ ├── 输出: 冻结记录ID                                                         │
│ ├── 执行角色: 系统/风控                                                      │
│ ├── SLA: ≤ 100ms                                                            │
│ └── 产生事件: BalanceFrozenEvent                                            │
│                                                                             │
│ L4.6.6 解冻资金                                                              │
│ ├── Command: UnfreezeBalanceCommand                                         │
│ ├── 输入: 冻结记录ID、解冻原因                                               │
│ ├── 输出: 解冻确认                                                          │
│ ├── 执行角色: 系统/风控                                                      │
│ ├── SLA: ≤ 100ms                                                            │
│ └── 产生事件: BalanceUnfrozenEvent                                          │
│                                                                             │
│ L4.6.7 转账                                                                  │
│ ├── Command: TransferCommand                                                │
│ ├── 输入: 源钱包、目标钱包、金额                                             │
│ ├── 输出: 转账流水号                                                         │
│ ├── 执行角色: 系统自动                                                       │
│ ├── SLA: ≤ 200ms                                                            │
│ └── 产生事件: TransferCompletedEvent                                        │
│                                                                             │
│ L4.6.8 调账                                                                  │
│ ├── Command: AdjustBalanceCommand                                           │
│ ├── 输入: 钱包ID、调整金额、原因                                             │
│ ├── 输出: 调账流水号                                                         │
│ ├── 执行角色: 财务/系统                                                      │
│ ├── SLA: ≤ 200ms                                                            │
│ └── 产生事件: BalanceAdjustedEvent                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.13.1 账户域 Command 定义

```rust
// ============================================================================
// 账户域 Commands
// ============================================================================

/// L4.6.1 创建账户命令
#[derive(Debug, Clone)]
pub struct CreateAccountCommand {
    pub command_id: CommandId,
    pub idempotency_key: IdempotencyKey,
    pub customer_id: CustomerId,
    pub account_type: AccountType,
    pub account_name: String,
    pub base_currency: CurrencyCode,
    pub initial_wallets: Vec<CurrencyCode>,  // 初始创建的钱包币种
}

#[derive(Debug, Clone, PartialEq)]
pub enum AccountType {
    Personal,
    Business,
    Settlement,  // 结算账户
    Transit,     // 过渡户
    Suspense,    // 暂挂户
}

/// L4.6.2 创建钱包命令
#[derive(Debug, Clone)]
pub struct CreateWalletCommand {
    pub command_id: CommandId,
    pub account_id: AccountId,
    pub currency: CurrencyCode,
    pub wallet_type: WalletType,
}

#[derive(Debug, Clone, PartialEq)]
pub enum WalletType {
    Available,   // 可用余额
    Frozen,      // 冻结余额
    Pending,     // 在途余额
}

/// L4.6.3 充值命令
#[derive(Debug, Clone)]
pub struct DepositCommand {
    pub command_id: CommandId,
    pub idempotency_key: IdempotencyKey,
    pub wallet_id: WalletId,
    pub amount: Decimal,
    pub currency: CurrencyCode,
    pub source: DepositSource,
    pub reference: String,
    pub metadata: Option<serde_json::Value>,
}

#[derive(Debug, Clone)]
pub enum DepositSource {
    BankTransfer { bank_ref: String },
    InternalTransfer { from_wallet: WalletId },
    Settlement { clearing_id: ClearingId },
    Refund { original_order_id: OrderId },
    Adjustment { adjustment_id: AdjustmentId },
}

/// L4.6.4 提现命令
#[derive(Debug, Clone)]
pub struct WithdrawCommand {
    pub command_id: CommandId,
    pub idempotency_key: IdempotencyKey,
    pub wallet_id: WalletId,
    pub amount: Decimal,
    pub currency: CurrencyCode,
    pub destination: WithdrawDestination,
    pub reference: String,
}

#[derive(Debug, Clone)]
pub enum WithdrawDestination {
    BankAccount { bank_code: String, account_number: String },
    InternalTransfer { to_wallet: WalletId },
    Payment { order_id: OrderId },
}

/// L4.6.5 冻结资金命令
#[derive(Debug, Clone)]
pub struct FreezeBalanceCommand {
    pub command_id: CommandId,
    pub wallet_id: WalletId,
    pub amount: Decimal,
    pub freeze_reason: FreezeReason,
    pub reference_type: ReferenceType,
    pub reference_id: String,
    pub expiry: Option<DateTime<Utc>>,  // 自动解冻时间
}

#[derive(Debug, Clone, PartialEq)]
pub enum FreezeReason {
    PaymentPending,      // 待付款
    RiskHold,            // 风控冻结
    DisputeHold,         // 争议冻结
    RegulatoryHold,      // 监管冻结
    SettlementPending,   // 待结算
}

#[derive(Debug, Clone, PartialEq)]
pub enum ReferenceType {
    PaymentOrder,
    RiskCase,
    Dispute,
    RegulatoryCase,
    Settlement,
}

/// L4.6.6 解冻资金命令
#[derive(Debug, Clone)]
pub struct UnfreezeBalanceCommand {
    pub command_id: CommandId,
    pub freeze_id: FreezeId,
    pub unfreeze_amount: Option<Decimal>,  // None = 全部解冻
    pub unfreeze_reason: UnfreezeReason,
    pub operator_id: OperatorId,
}

#[derive(Debug, Clone, PartialEq)]
pub enum UnfreezeReason {
    PaymentCompleted,
    PaymentCancelled,
    RiskCleared,
    DisputeResolved,
    RegulatoryCleared,
    Expired,
    ManualRelease,
}

/// L4.6.7 转账命令
#[derive(Debug, Clone)]
pub struct TransferCommand {
    pub command_id: CommandId,
    pub idempotency_key: IdempotencyKey,
    pub from_wallet_id: WalletId,
    pub to_wallet_id: WalletId,
    pub amount: Decimal,
    pub currency: CurrencyCode,
    pub transfer_type: TransferType,
    pub reference: String,
    pub memo: Option<String>,
}

#[derive(Debug, Clone, PartialEq)]
pub enum TransferType {
    P2P,             // 个人转个人
    B2B,             // 企业转企业
    Internal,        // 内部调拨
    Settlement,      // 结算划转
    FeeCollection,   // 手续费收取
}

/// L4.6.8 调账命令
#[derive(Debug, Clone)]
pub struct AdjustBalanceCommand {
    pub command_id: CommandId,
    pub idempotency_key: IdempotencyKey,
    pub wallet_id: WalletId,
    pub adjustment_type: BalanceAdjustmentType,
    pub amount: Decimal,  // 正数增加，负数减少
    pub reason: AdjustmentReason,
    pub approval_id: ApprovalId,
    pub operator_id: OperatorId,
    pub notes: String,
}

#[derive(Debug, Clone, PartialEq)]
pub enum BalanceAdjustmentType {
    Credit,   // 贷方调整（增加）
    Debit,    // 借方调整（减少）
}

#[derive(Debug, Clone, PartialEq)]
pub enum AdjustmentReason {
    ReconciliationDiff,   // 对账差异
    FeeCorrection,        // 费用更正
    FxDifference,         // 汇差
    ManualCorrection,     // 人工更正
    SystemError,          // 系统错误
    Promotion,            // 营销活动
    Compensation,         // 赔付
}
```

---

## 4. L5 步骤与规则详解

### 4.1 L4.1.1.1 创建付款订单 → L5 步骤

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L4.1.1.1 创建付款订单 → L5 执行步骤                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ L5.1.1.1.1 接收付款请求                                                      │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 接收并解析客户提交的付款请求                                    │ │
│ │ 输入数据:                                                                │ │
│ │   - merchant_id: 商户ID                                                  │ │
│ │   - payer_name: 付款人名称                                               │ │
│ │   - payee_name: 收款人名称                                               │ │
│ │   - payee_account: 收款账号                                              │ │
│ │   - payee_bank: 收款银行                                                 │ │
│ │   - source_currency: 源币种                                              │ │
│ │   - dest_currency: 目标币种                                              │ │
│ │   - amount: 金额                                                         │ │
│ │   - purpose: 付款目的                                                    │ │
│ │   - invoice_ref: 发票引用 (B2B)                                          │ │
│ │ 输出: 原始请求对象                                                       │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.1.1.1.2 参数格式校验                                                      │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 校验所有输入参数的格式有效性                                    │ │
│ │ 校验规则:                                                                │ │
│ │   R1: merchant_id 必须是有效UUID                                         │ │
│ │   R2: amount > 0 且精度 ≤ 8位小数                                        │ │
│ │   R3: source_currency 必须是ISO 4217标准币种                             │ │
│ │   R4: dest_currency 必须是ISO 4217标准币种                               │ │
│ │   R5: payee_account 格式符合目标国家银行账号规则                          │ │
│ │   R6: payee_bank 必须是有效的SWIFT/BIC代码或本地银行代码                  │ │
│ │   R7: payer_name/payee_name 长度 1-140 字符                              │ │
│ │   R8: purpose 必须是预定义的付款目的代码                                  │ │
│ │ 异常处理: 任一规则失败 → 返回 VALIDATION_ERROR                           │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.1.1.1.3 商户状态校验                                                      │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 校验商户账户状态是否允许发起付款                                │ │
│ │ 校验规则:                                                                │ │
│ │   R1: 商户状态 = ACTIVE                                                  │ │
│ │   R2: 商户KYB状态 = APPROVED                                             │ │
│ │   R3: 商户无冻结标记                                                     │ │
│ │   R4: 商户有付款权限 (permission.outward_payment = true)                 │ │
│ │ 查询: SELECT status, kyb_status, frozen, permissions FROM merchants     │ │
│ │        WHERE merchant_id = ?                                             │ │
│ │ 异常处理: 状态异常 → 返回 MERCHANT_NOT_ELIGIBLE                          │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.1.1.1.4 币种走廊校验                                                      │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 校验源币种到目标币种的通道是否支持                              │ │
│ │ 校验规则:                                                                │ │
│ │   R1: 存在支持该币种对的活跃通道                                         │ │
│ │   R2: 目标国家未被制裁/限制                                              │ │
│ │   R3: 该商户类型允许使用该走廊                                           │ │
│ │ 查询: SELECT * FROM corridors                                            │ │
│ │        WHERE source_currency = ? AND dest_currency = ?                   │ │
│ │        AND status = 'ACTIVE'                                             │ │
│ │ 异常处理: 无可用走廊 → 返回 CORRIDOR_NOT_SUPPORTED                       │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.1.1.1.5 金额限额校验                                                      │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 校验交易金额是否在允许范围内                                    │ │
│ │ 校验规则:                                                                │ │
│ │   R1: amount >= 走廊最小金额 (如 $10)                                    │ │
│ │   R2: amount <= 走廊最大金额 (如 $1,000,000)                             │ │
│ │   R3: amount <= 商户单笔限额                                             │ │
│ │   R4: 今日累计 + amount <= 商户日限额                                    │ │
│ │   R5: 本月累计 + amount <= 商户月限额                                    │ │
│ │ 计算: daily_total = SUM(amount) WHERE merchant_id = ? AND DATE = TODAY  │ │
│ │ 异常处理: 超限 → 返回 AMOUNT_LIMIT_EXCEEDED                              │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.1.1.1.6 生成订单号                                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 生成全局唯一的订单标识                                          │ │
│ │ 生成规则:                                                                │ │
│ │   格式: {区域代码}{日期}{序列号}{校验位}                                  │ │
│ │   示例: SG20251203000001X                                                │ │
│ │   算法: Snowflake / UUID v7                                              │ │
│ │ 唯一性保证: 分布式ID生成器                                               │ │
│ │ 输出: order_id                                                           │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.1.1.1.7 计算手续费                                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 根据商户等级和交易类型计算手续费                                │ │
│ │ 计算规则:                                                                │ │
│ │   fee = MAX(fixed_fee + amount * rate, min_fee)                          │ │
│ │   fee = MIN(fee, max_fee) if max_fee is set                              │ │
│ │                                                                          │ │
│ │ 费率表查询:                                                              │ │
│ │   SELECT fixed_fee, rate, min_fee, max_fee FROM fee_rules               │ │
│ │   WHERE merchant_tier = ? AND order_type = ? AND corridor = ?           │ │
│ │                                                                          │ │
│ │ 阶梯定价示例:                                                            │ │
│ │   Tier 1 ($0-100K/月):   固定 $5 + 0.8%                                 │ │
│ │   Tier 2 ($100K-1M/月):  固定 $3 + 0.5%                                 │ │
│ │   Tier 3 ($1M+/月):      固定 $1 + 0.3%                                 │ │
│ │                                                                          │ │
│ │ 输出: fee_amount, fee_currency                                           │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.1.1.1.8 创建订单记录                                                      │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 将订单信息持久化到数据库                                        │ │
│ │ 数据库操作:                                                              │ │
│ │   INSERT INTO payment_orders (                                           │ │
│ │     order_id, merchant_id, order_type,                                   │ │
│ │     source_currency, dest_currency, source_amount,                       │ │
│ │     payer_name, payee_name, payee_account, payee_bank,                   │ │
│ │     purpose, fee_amount, fee_currency,                                   │ │
│ │     status, created_at, updated_at                                       │ │
│ │   ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'CREATED', NOW())    │ │
│ │                                                                          │ │
│ │ 事务要求: 与余额检查在同一事务内                                         │ │
│ │ 幂等性: 基于 idempotency_key 去重                                        │ │
│ │ 输出: 订单创建确认                                                       │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.1.1.1.9 发布订单创建事件                                                  │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 发布领域事件通知下游系统                                        │ │
│ │ 事件定义:                                                                │ │
│ │   {                                                                      │ │
│ │     "event_type": "ORDER_CREATED",                                       │ │
│ │     "event_id": "uuid",                                                  │ │
│ │     "timestamp": "2025-12-03T10:00:00Z",                                 │ │
│ │     "payload": {                                                         │ │
│ │       "order_id": "SG20251203000001X",                                   │ │
│ │       "merchant_id": "uuid",                                             │ │
│ │       "amount": 10000.00,                                                │ │
│ │       "currency": "USD"                                                  │ │
│ │     }                                                                    │ │
│ │   }                                                                      │ │
│ │ 发布通道: Kafka topic: payment.order.events                              │ │
│ │ 消费者: 风控系统、通知系统、统计系统                                     │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.1.1.1.10 返回创建结果                                                     │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 组装并返回订单创建结果                                          │ │
│ │ 返回数据:                                                                │ │
│ │   {                                                                      │ │
│ │     "order_id": "SG20251203000001X",                                     │ │
│ │     "status": "CREATED",                                                 │ │
│ │     "source_amount": 10000.00,                                           │ │
│ │     "source_currency": "USD",                                            │ │
│ │     "fee_amount": 85.00,                                                 │ │
│ │     "fee_currency": "USD",                                               │ │
│ │     "total_debit": 10085.00,                                             │ │
│ │     "estimated_arrival": "2025-12-03T14:00:00Z",                         │ │
│ │     "next_step": "COMPLIANCE_CHECK"                                      │ │
│ │   }                                                                      │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 L4.5.1 制裁名单筛查 → L5 步骤

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L4.5.1 制裁名单筛查 → L5 执行步骤                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ L5.5.1.1 提取筛查要素                                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 从交易中提取需要筛查的实体信息                                  │ │
│ │ 提取字段:                                                                │ │
│ │   - 付款人: name, id_number, address, country                            │ │
│ │   - 收款人: name, account, bank_name, bank_country                       │ │
│ │   - 关联方: beneficial_owner, intermediary_bank                          │ │
│ │ 标准化处理:                                                              │ │
│ │   - 姓名: 转大写、去除特殊字符、拆分姓/名                                │ │
│ │   - 地址: 标准化国家代码                                                 │ │
│ │ 输出: 筛查实体列表                                                       │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.5.1.2 OFAC名单筛查                                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 对美国OFAC制裁名单进行筛查                                      │ │
│ │ 数据源: SDN List, Consolidated Sanctions List                            │ │
│ │ 匹配算法:                                                                │ │
│ │   - 精确匹配: 姓名、证件号完全一致                                       │ │
│ │   - 模糊匹配: Levenshtein距离 ≤ 2 或 相似度 ≥ 85%                       │ │
│ │   - 别名匹配: 检查 aka/fka 字段                                          │ │
│ │   - 音译匹配: Soundex/Metaphone 算法                                     │ │
│ │ 输出: OFAC筛查结果 (hit_score, matched_entries)                          │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.5.1.3 UN制裁名单筛查                                                      │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 对联合国安理会制裁名单进行筛查                                  │ │
│ │ 数据源: UN Security Council Consolidated List                            │ │
│ │ 匹配规则: 同 OFAC                                                        │ │
│ │ 输出: UN筛查结果                                                         │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.5.1.4 EU制裁名单筛查                                                      │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 对欧盟制裁名单进行筛查                                          │ │
│ │ 数据源: EU Consolidated Financial Sanctions List                         │ │
│ │ 匹配规则: 同 OFAC                                                        │ │
│ │ 输出: EU筛查结果                                                         │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.5.1.5 本地监管名单筛查                                                    │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 对本地监管要求的名单进行筛查                                    │ │
│ │ 数据源:                                                                  │ │
│ │   - MAS (新加坡): Terrorism (Suppression of Financing) Act              │ │
│ │   - FCA (英国): HM Treasury Sanctions List                               │ │
│ │   - FinCEN (美国): 314(a) List                                           │ │
│ │ 匹配规则: 同 OFAC                                                        │ │
│ │ 输出: 本地筛查结果                                                       │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.5.1.6 内部黑名单筛查                                                      │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 对公司内部维护的黑名单进行筛查                                  │ │
│ │ 数据源: 内部风控黑名单数据库                                             │ │
│ │ 名单类型:                                                                │ │
│ │   - 欺诈黑名单: 历史欺诈账户                                             │ │
│ │   - 高风险名单: 历史可疑交易账户                                         │ │
│ │   - 合作方黑名单: 被终止合作的商户                                       │ │
│ │ 输出: 内部筛查结果                                                       │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.5.1.7 汇总筛查结果                                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 汇总所有名单的筛查结果                                          │ │
│ │ 决策逻辑:                                                                │ │
│ │                                                                          │ │
│ │   if (任一名单精确命中) {                                                │ │
│ │       result = BLOCKED;                                                  │ │
│ │       action = 自动拒绝 + 生成SAR;                                       │ │
│ │   } else if (任一名单相似度 ≥ 85%) {                                     │ │
│ │       result = POTENTIAL_MATCH;                                          │ │
│ │       action = 人工审核;                                                 │ │
│ │   } else if (任一名单相似度 ≥ 70%) {                                     │ │
│ │       result = POSSIBLE_MATCH;                                           │ │
│ │       action = 增强监控;                                                 │ │
│ │   } else {                                                               │ │
│ │       result = CLEAR;                                                    │ │
│ │       action = 继续处理;                                                 │ │
│ │   }                                                                      │ │
│ │                                                                          │ │
│ │ 输出: final_result, action_required, matched_records                     │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.5.1.8 记录筛查日志                                                        │ │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 记录完整的筛查审计日志                                          │ │
│ │ 日志内容:                                                                │ │
│ │   - 筛查时间戳                                                           │ │
│ │   - 筛查实体信息                                                         │ │
│ │   - 各名单筛查结果                                                       │ │
│ │   - 最终决策                                                             │ │
│ │   - 名单版本号                                                           │ │
│ │ 保存期限: 7年 (监管要求)                                                 │ │
│ │ 存储: sanction_screening_logs 表                                         │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 L4.3.5 换汇成交 → L5 步骤

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L4.3.5 换汇成交 → L5 执行步骤                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ L5.3.5.1 验证报价有效性                                                      │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 验证客户提交的报价是否仍然有效                                  │ │
│ │ 校验规则:                                                                │ │
│ │   R1: quote_id 存在且状态为 LOCKED                                       │ │
│ │   R2: NOW() < valid_until (报价未过期, 通常30秒)                         │ │
│ │   R3: 报价金额与请求金额一致                                             │ │
│ │   R4: 报价未被其他交易使用 (一次性)                                      │ │
│ │                                                                          │ │
│ │ 查询: SELECT * FROM fx_quotes                                            │ │
│ │        WHERE quote_id = ? AND status = 'LOCKED'                          │ │
│ │        AND valid_until > NOW() FOR UPDATE                                │ │
│ │                                                                          │ │
│ │ 异常处理: 报价无效 → 返回 QUOTE_EXPIRED, 需重新询价                      │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.3.5.2 检查头寸限额                                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 检查换汇后头寸是否超限                                          │ │
│ │ 计算逻辑:                                                                │ │
│ │   // 买入目标币种 = 增加多头                                             │ │
│ │   // 卖出源币种 = 增加空头                                               │ │
│ │   new_source_position = current_source_position - source_amount          │ │
│ │   new_dest_position = current_dest_position + dest_amount                │ │
│ │                                                                          │ │
│ │ 校验规则:                                                                │ │
│ │   R1: |new_source_position| ≤ source_currency_limit                     │ │
│ │   R2: |new_dest_position| ≤ dest_currency_limit                         │ │
│ │   R3: total_gross_position ≤ gross_limit                                 │ │
│ │                                                                          │ │
│ │ 异常处理: 超限 → 返回 POSITION_LIMIT_EXCEEDED                            │ │
│ │          (可选: 触发自动对冲后重试)                                      │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.3.5.3 执行换汇记账                                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 在账务系统中执行换汇分录                                        │ │
│ │ 记账分录 (复式记账):                                                     │ │
│ │                                                                          │ │
│ │   // 客户视角: 卖出 USD 买入 SGD                                         │ │
│ │   借: 客户USD钱包    10,000.00 USD    (减少USD)                          │ │
│ │   贷: 客户SGD钱包    13,400.00 SGD    (增加SGD)                          │ │
│ │                                                                          │ │
│ │   // 公司视角: 买入 USD 卖出 SGD                                         │ │
│ │   借: 公司SGD头寸    13,400.00 SGD    (减少SGD)                          │ │
│ │   贷: 公司USD头寸    10,000.00 USD    (增加USD)                          │ │
│ │                                                                          │ │
│ │   // 换汇收益 (Markup)                                                   │ │
│ │   借: 客户USD钱包       30.00 USD     (扣除加点)                         │ │
│ │   贷: FX收入账户        30.00 USD     (确认收入)                         │ │
│ │                                                                          │ │
│ │ 事务要求: 所有分录在同一事务中, ACID保证                                 │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.3.5.4 更新头寸                                                            │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 更新公司各币种头寸                                              │ │
│ │ 更新操作:                                                                │ │
│ │   UPDATE currency_positions SET                                          │ │
│ │     long_position = long_position + ?,                                   │ │
│ │     net_position = net_position + ?,                                     │ │
│ │     updated_at = NOW()                                                   │ │
│ │   WHERE currency = 'USD';                                                │ │
│ │                                                                          │ │
│ │   UPDATE currency_positions SET                                          │ │
│ │     short_position = short_position + ?,                                 │ │
│ │     net_position = net_position - ?,                                     │ │
│ │     updated_at = NOW()                                                   │ │
│ │   WHERE currency = 'SGD';                                                │ │
│ │                                                                          │ │
│ │ 并发控制: 乐观锁 (version字段) 或 SELECT FOR UPDATE                      │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.3.5.5 创建成交记录                                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 创建换汇成交记录                                                │ │
│ │ 数据库操作:                                                              │ │
│ │   INSERT INTO fx_deals (                                                 │ │
│ │     deal_id, quote_id, order_id,                                         │ │
│ │     source_currency, dest_currency,                                      │ │
│ │     source_amount, dest_amount,                                          │ │
│ │     customer_rate, interbank_rate, markup,                               │ │
│ │     status, dealt_at                                                     │ │
│ │   ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'COMPLETED', NOW());          │ │
│ │                                                                          │ │
│ │ 输出: deal_id                                                            │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.3.5.6 更新报价状态                                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 将已使用的报价标记为已成交                                      │ │
│ │ 更新操作:                                                                │ │
│ │   UPDATE fx_quotes SET                                                   │ │
│ │     status = 'DEALT',                                                    │ │
│ │     deal_id = ?,                                                         │ │
│ │     dealt_at = NOW()                                                     │ │
│ │   WHERE quote_id = ?;                                                    │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.3.5.7 检查对冲触发条件                                                    │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 检查是否需要触发自动对冲                                        │ │
│ │ 触发条件:                                                                │ │
│ │   position_utilization = |net_position| / max_limit                     │ │
│ │                                                                          │ │
│ │   if (position_utilization ≥ 70%) {                                     │ │
│ │       trigger_hedge = true;                                              │ │
│ │       hedge_amount = net_position * 50%;  // 对冲50%敞口                │ │
│ │   }                                                                      │ │
│ │                                                                          │ │
│ │ 输出: trigger_hedge, hedge_amount                                        │ │
│ │ 后续: 异步触发对冲任务                                                   │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.3.5.8 发布成交事件                                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 发布换汇成交领域事件                                            │ │
│ │ 事件定义:                                                                │ │
│ │   {                                                                      │ │
│ │     "event_type": "FX_DEAL_COMPLETED",                                   │ │
│ │     "payload": {                                                         │ │
│ │       "deal_id": "FX20251203000001",                                     │ │
│ │       "order_id": "SG20251203000001X",                                   │ │
│ │       "source_currency": "USD",                                          │ │
│ │       "dest_currency": "SGD",                                            │ │
│ │       "source_amount": 10000.00,                                         │ │
│ │       "dest_amount": 13400.00,                                           │ │
│ │       "customer_rate": 1.3400,                                           │ │
│ │       "dealt_at": "2025-12-03T10:00:00Z"                                 │ │
│ │     }                                                                    │ │
│ │   }                                                                      │ │
│ │ 发布通道: Kafka topic: fx.deal.events                                    │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.4 L4.1.1.8 通道出款提交 → L5 步骤

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L4.1.1.8 通道出款提交 → L5 执行步骤                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ L5.1.1.8.1 获取通道配置                                                      │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 获取选定通道的连接和配置信息                                    │ │
│ │ 配置项:                                                                  │ │
│ │   - 通道类型: SWIFT_GPI / LOCAL_ACH / BANK_DIRECT                        │ │
│ │   - 连接参数: endpoint, credentials, timeout                             │ │
│ │   - 报文格式: ISO20022 / 通道专用                                        │ │
│ │   - 加密方式: TLS, 签名证书                                              │ │
│ │   - 重试策略: max_retries, retry_interval                                │ │
│ │                                                                          │ │
│ │ 查询: SELECT * FROM channel_configs WHERE channel_id = ?                 │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.1.1.8.2 检查通道状态                                                      │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 检查通道当前是否可用                                            │ │
│ │ 检查项:                                                                  │ │
│ │   R1: channel_status = 'ACTIVE'                                          │ │
│ │   R2: circuit_breaker_status != 'OPEN'                                   │ │
│ │   R3: daily_volume < daily_limit (未触及日限额)                          │ │
│ │   R4: 在通道工作时间内 (如有)                                            │ │
│ │                                                                          │ │
│ │ 异常处理: 通道不可用 → 触发降级到备用通道                                │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.1.1.8.3 组装报文                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 按通道要求组装付款报文                                          │ │
│ │                                                                          │ │
│ │ ISO 20022 pacs.008 报文示例:                                             │ │
│ │   <FIToFICstmrCdtTrf>                                                    │ │
│ │     <GrpHdr>                                                             │ │
│ │       <MsgId>MSG20251203000001</MsgId>                                   │ │
│ │       <CreDtTm>2025-12-03T10:00:00Z</CreDtTm>                            │ │
│ │       <NbOfTxs>1</NbOfTxs>                                               │ │
│ │       <SttlmInf><SttlmMtd>INDA</SttlmMtd></SttlmInf>                     │ │
│ │     </GrpHdr>                                                            │ │
│ │     <CdtTrfTxInf>                                                        │ │
│ │       <PmtId>                                                            │ │
│ │         <InstrId>SG20251203000001X</InstrId>                             │ │
│ │         <EndToEndId>E2E20251203000001</EndToEndId>                       │ │
│ │         <UETR>eb6305c9-1f7d-4e5b-9a98-f0a1234567cd</UETR>               │ │
│ │       </PmtId>                                                           │ │
│ │       <IntrBkSttlmAmt Ccy="SGD">13400.00</IntrBkSttlmAmt>                │ │
│ │       <Dbtr><Nm>Payer Company Ltd</Nm></Dbtr>                            │ │
│ │       <Cdtr><Nm>Payee Company Pte</Nm></Cdtr>                            │ │
│ │       <CdtrAcct><Id><IBAN>SG12DBSS1234567890</IBAN></Id></CdtrAcct>     │ │
│ │       <RmtInf><Ustrd>Invoice INV-2025-001</Ustrd></RmtInf>               │ │
│ │     </CdtTrfTxInf>                                                       │ │
│ │   </FIToFICstmrCdtTrf>                                                   │ │
│ │                                                                          │ │
│ │ 字段映射规则: 内部字段 → ISO 20022 字段                                  │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.1.1.8.4 报文签名                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 对报文进行数字签名                                              │ │
│ │ 签名算法: RSA-SHA256 / ECDSA                                             │ │
│ │ 签名流程:                                                                │ │
│ │   1. 计算报文摘要: hash = SHA256(message)                                │ │
│ │   2. 使用私钥签名: signature = RSA_SIGN(private_key, hash)              │ │
│ │   3. 附加签名到报文头                                                    │ │
│ │ 密钥来源: HSM (硬件安全模块)                                             │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.1.1.8.5 发送报文                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 通过通道接口发送付款报文                                        │ │
│ │ 发送方式 (按通道类型):                                                   │ │
│ │   - SWIFT: MQ/SFTP 传输                                                  │ │
│ │   - 银行API: HTTPS REST/SOAP                                             │ │
│ │   - 本地清算: 专线/VPN                                                   │ │
│ │                                                                          │ │
│ │ 超时设置: connect_timeout=5s, read_timeout=30s                           │ │
│ │ TLS版本: TLS 1.2+                                                        │ │
│ │                                                                          │ │
│ │ 记录请求日志:                                                            │ │
│ │   INSERT INTO channel_requests (                                         │ │
│ │     request_id, channel_id, order_id, request_body,                      │ │
│ │     sent_at, status                                                      │ │
│ │   ) VALUES (?, ?, ?, ?, NOW(), 'SENT');                                  │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.1.1.8.6 接收响应                                                          │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 接收并解析通道响应                                              │ │
│ │ 响应类型:                                                                │ │
│ │   - ACK: 报文已接收                                                      │ │
│ │   - ACCP: 已接受处理                                                     │ │
│ │   - RJCT: 已拒绝 (附带原因码)                                            │ │
│ │   - PDNG: 处理中                                                         │ │
│ │                                                                          │ │
│ │ 响应解析:                                                                │ │
│ │   - 提取通道参考号 (channel_ref)                                         │ │
│ │   - 提取状态码和描述                                                     │ │
│ │   - 提取预计处理时间                                                     │ │
│ │                                                                          │ │
│ │ 更新请求日志:                                                            │ │
│ │   UPDATE channel_requests SET                                            │ │
│ │     response_body = ?, response_code = ?,                                │ │
│ │     channel_ref = ?, received_at = NOW(), status = ?                     │ │
│ │   WHERE request_id = ?;                                                  │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.1.1.8.7 处理响应结果                                                      │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 根据响应结果更新订单状态                                        │ │
│ │ 决策逻辑:                                                                │ │
│ │                                                                          │ │
│ │   switch (response_status) {                                             │ │
│ │     case 'ACCP':                                                         │ │
│ │       order.status = 'CHANNEL_PROCESSING';                               │ │
│ │       order.channel_ref = response.channel_ref;                          │ │
│ │       // 启动状态轮询任务                                                │ │
│ │       schedule_status_polling(order_id, channel_id);                     │ │
│ │       break;                                                             │ │
│ │                                                                          │ │
│ │     case 'RJCT':                                                         │ │
│ │       if (is_retryable(response.reject_code)) {                          │ │
│ │         // 可重试错误: 重试或降级                                        │ │
│ │         retry_or_fallback(order, response);                              │ │
│ │       } else {                                                           │ │
│ │         // 不可重试: 标记失败                                            │ │
│ │         order.status = 'FAILED';                                         │ │
│ │         order.failure_reason = response.reject_reason;                   │ │
│ │         // 触发退款流程                                                  │ │
│ │         trigger_refund(order);                                           │ │
│ │       }                                                                  │ │
│ │       break;                                                             │ │
│ │                                                                          │ │
│ │     case 'TIMEOUT':                                                      │ │
│ │       // 超时处理: 记录待确认, 人工介入                                  │ │
│ │       order.status = 'PENDING_CONFIRMATION';                             │ │
│ │       alert_operations_team(order);                                      │ │
│ │       break;                                                             │ │
│ │   }                                                                      │ │
│ │                                                                          │ │
│ │ 可重试错误码: TIMEOUT, TEMP_UNAVAILABLE, RATE_LIMITED                    │ │
│ │ 不可重试错误码: INVALID_ACCOUNT, BENEFICIARY_REJECTED, SANCTIONED        │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.1.1.8.8 更新熔断器状态                                                    │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 根据请求结果更新通道熔断器                                      │ │
│ │ 更新逻辑:                                                                │ │
│ │                                                                          │ │
│ │   if (response_status == 'SUCCESS' || response_status == 'ACCP') {      │ │
│ │       circuit_breaker.record_success();                                  │ │
│ │   } else if (is_circuit_breaking_error(response_status)) {              │ │
│ │       circuit_breaker.record_failure();                                  │ │
│ │       if (circuit_breaker.failure_count >= threshold) {                  │ │
│ │           circuit_breaker.open();                                        │ │
│ │           alert_channel_degraded(channel_id);                            │ │
│ │       }                                                                  │ │
│ │   }                                                                      │ │
│ │                                                                          │ │
│ │ 熔断触发条件: 连续5次失败或1分钟内失败率>50%                             │ │
│ │ 恢复条件: 熔断30秒后, 允许探测请求, 连续3次成功则关闭熔断                │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.5 L4.4.7 自动对账 → L5 步骤

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ L4.4.7 自动对账 → L5 执行步骤                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ L5.4.7.1 加载内部交易记录                                                    │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 加载待对账日期的内部交易记录                                    │ │
│ │ 查询条件:                                                                │ │
│ │   SELECT order_id, channel_id, channel_ref, amount, currency,            │ │
│ │          status, completed_at                                            │ │
│ │   FROM payment_orders                                                    │ │
│ │   WHERE channel_id = ?                                                   │ │
│ │   AND DATE(completed_at) = ?                                             │ │
│ │   AND status IN ('COMPLETED', 'FAILED', 'REFUNDED');                     │ │
│ │                                                                          │ │
│ │ 输出: 内部交易列表 (按channel_ref索引)                                   │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.4.7.2 解析通道对账文件                                                    │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 解析通道提供的对账文件                                          │ │
│ │ 文件格式 (按通道):                                                       │ │
│ │   - SWIFT: MT940/MT950 或 camt.053                                       │ │
│ │   - 银行: CSV/XML 专有格式                                               │ │
│ │   - 本地清算: 清算所标准格式                                             │ │
│ │                                                                          │ │
│ │ 解析字段:                                                                │ │
│ │   - reference: 通道参考号                                                │ │
│ │   - amount: 金额                                                         │ │
│ │   - currency: 币种                                                       │ │
│ │   - status: 状态 (成功/失败/退回)                                        │ │
│ │   - value_date: 起息日                                                   │ │
│ │   - narrative: 附言                                                      │ │
│ │                                                                          │ │
│ │ 输出: 通道交易列表 (按reference索引)                                     │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.4.7.3 执行匹配                                                            │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 执行内部记录与通道记录的匹配                                    │ │
│ │ 匹配规则 (按优先级):                                                     │ │
│ │                                                                          │ │
│ │   // 规则1: 精确匹配 (通道参考号)                                        │ │
│ │   match_level_1(internal, channel):                                      │ │
│ │     internal.channel_ref == channel.reference                            │ │
│ │                                                                          │ │
│ │   // 规则2: 金额+时间匹配 (容差)                                         │ │
│ │   match_level_2(internal, channel):                                      │ │
│ │     internal.amount == channel.amount                                    │ │
│ │     AND internal.currency == channel.currency                            │ │
│ │     AND |internal.completed_at - channel.value_date| <= 1 day            │ │
│ │                                                                          │ │
│ │   // 规则3: 模糊匹配 (附言包含订单号)                                    │ │
│ │   match_level_3(internal, channel):                                      │ │
│ │     channel.narrative CONTAINS internal.order_id                         │ │
│ │                                                                          │ │
│ │ 匹配结果分类:                                                            │ │
│ │   - MATCHED: 精确匹配, 金额一致                                          │ │
│ │   - AMOUNT_MISMATCH: 匹配但金额不一致                                    │ │
│ │   - STATUS_MISMATCH: 匹配但状态不一致                                    │ │
│ │   - INTERNAL_ONLY: 内部有, 通道无 (短款)                                 │ │
│ │   - CHANNEL_ONLY: 通道有, 内部无 (长款)                                  │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.4.7.4 生成差异报告                                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 生成对账差异报告                                                │ │
│ │ 报告内容:                                                                │ │
│ │   {                                                                      │ │
│ │     "reconciliation_date": "2025-12-03",                                 │ │
│ │     "channel_id": "SWIFT_GPI",                                           │ │
│ │     "summary": {                                                         │ │
│ │       "total_internal": 1000,                                            │ │
│ │       "total_channel": 998,                                              │ │
│ │       "matched": 995,                                                    │ │
│ │       "amount_mismatch": 2,                                              │ │
│ │       "internal_only": 5,                                                │ │
│ │       "channel_only": 3,                                                 │ │
│ │       "match_rate": "99.5%"                                              │ │
│ │     },                                                                   │ │
│ │     "discrepancies": [                                                   │ │
│ │       {                                                                  │ │
│ │         "type": "AMOUNT_MISMATCH",                                       │ │
│ │         "order_id": "SG20251203000001X",                                 │ │
│ │         "internal_amount": 10000.00,                                     │ │
│ │         "channel_amount": 9985.00,                                       │ │
│ │         "difference": -15.00,                                            │ │
│ │         "reason": "Channel fee deducted"                                 │ │
│ │       }                                                                  │ │
│ │     ]                                                                    │ │
│ │   }                                                                      │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.4.7.5 自动处理已知差异                                                    │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 自动处理可识别原因的差异                                        │ │
│ │ 自动处理规则:                                                            │ │
│ │                                                                          │ │
│ │   // 规则1: 通道手续费扣除                                               │ │
│ │   if (difference == known_channel_fee) {                                 │ │
│ │     create_adjustment_entry(order_id, 'CHANNEL_FEE', difference);       │ │
│ │     mark_as_auto_reconciled();                                           │ │
│ │   }                                                                      │ │
│ │                                                                          │ │
│ │   // 规则2: 汇率差异 (小于阈值)                                          │ │
│ │   if (type == 'AMOUNT_MISMATCH' && |difference| < threshold) {          │ │
│ │     create_adjustment_entry(order_id, 'FX_DIFF', difference);           │ │
│ │     mark_as_auto_reconciled();                                           │ │
│ │   }                                                                      │ │
│ │                                                                          │ │
│ │   // 规则3: 延迟到账 (跨日)                                              │ │
│ │   if (type == 'INTERNAL_ONLY' && expected_date == tomorrow) {           │ │
│ │     mark_as_pending_next_day();                                          │ │
│ │   }                                                                      │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.4.7.6 创建人工审核任务                                                    │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 为无法自动处理的差异创建人工审核任务                            │ │
│ │ 任务分配规则:                                                            │ │
│ │   - 金额差异 > $1000: 分配给高级对账员                                   │ │
│ │   - 长款: 分配给合规团队                                                 │ │
│ │   - 短款: 分配给运营团队                                                 │ │
│ │                                                                          │ │
│ │ 任务创建:                                                                │ │
│ │   INSERT INTO reconciliation_tasks (                                     │ │
│ │     task_id, reconciliation_date, channel_id,                            │ │
│ │     discrepancy_type, order_id, amount_diff,                             │ │
│ │     priority, assigned_to, status, created_at                            │ │
│ │   ) VALUES (...);                                                        │ │
│ │                                                                          │ │
│ │ SLA: 普通差异24小时内处理, 大额差异4小时内处理                           │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.4.7.7 更新对账状态                                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 更新订单的对账状态                                              │ │
│ │ 状态更新:                                                                │ │
│ │   UPDATE payment_orders SET                                              │ │
│ │     reconciliation_status = CASE                                         │ │
│ │       WHEN matched THEN 'RECONCILED'                                     │ │
│ │       WHEN auto_adjusted THEN 'AUTO_RECONCILED'                          │ │
│ │       ELSE 'PENDING_REVIEW'                                              │ │
│ │     END,                                                                 │ │
│ │     reconciled_at = NOW()                                                │ │
│ │   WHERE order_id IN (?);                                                 │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│ L5.4.7.8 发送对账报告                                                        │
│ ┌─────────────────────────────────────────────────────────────────────────┐ │
│ │ 步骤描述: 发送对账完成报告                                                │ │
│ │ 报告接收人:                                                              │ │
│ │   - 财务团队: 每日对账汇总                                               │ │
│ │   - 运营团队: 差异明细                                                   │ │
│ │   - 管理层: 对账率趋势 (周报)                                            │ │
│ │                                                                          │ │
│ │ 告警条件:                                                                │ │
│ │   - 对账率 < 99%: 发送告警                                               │ │
│ │   - 大额未匹配 (>$10K): 立即告警                                         │ │
│ │   - 连续3天同一问题: 升级告警                                            │ │
│ └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 业务规则汇总

### 5.1 金额与限额规则

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              金额限额规则                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ R-AMT-001: 最小交易金额                                                      │
│ ├── 规则: amount >= corridor.min_amount                                     │
│ ├── 默认值: $10 或等值                                                      │
│ └── 异常: AMOUNT_TOO_SMALL                                                  │
│                                                                             │
│ R-AMT-002: 最大单笔金额                                                      │
│ ├── 规则: amount <= MIN(corridor.max_amount, merchant.single_limit)        │
│ ├── 个人客户: $50,000                                                       │
│ ├── 企业客户: $1,000,000                                                    │
│ └── 异常: AMOUNT_EXCEEDS_LIMIT                                              │
│                                                                             │
│ R-AMT-003: 日累计限额                                                        │
│ ├── 规则: today_total + amount <= merchant.daily_limit                     │
│ ├── 计算: SUM(amount) WHERE DATE(created_at) = TODAY                       │
│ └── 异常: DAILY_LIMIT_EXCEEDED                                              │
│                                                                             │
│ R-AMT-004: 月累计限额                                                        │
│ ├── 规则: month_total + amount <= merchant.monthly_limit                   │
│ ├── 计算: SUM(amount) WHERE MONTH(created_at) = CURRENT_MONTH              │
│ └── 异常: MONTHLY_LIMIT_EXCEEDED                                            │
│                                                                             │
│ R-AMT-005: 金额精度                                                          │
│ ├── 规则: decimal_places(amount) <= currency.precision                      │
│ ├── 示例: USD最多2位小数, BTC最多8位小数                                    │
│ └── 异常: INVALID_AMOUNT_PRECISION                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 风控规则

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              风控规则库                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ R-RISK-001: 首次交易审核                                                     │
│ ├── 条件: merchant.transaction_count == 0                                  │
│ ├── 动作: 触发人工审核                                                      │
│ └── 优先级: 高                                                              │
│                                                                             │
│ R-RISK-002: 大额交易审核                                                     │
│ ├── 条件: amount > merchant.auto_approval_limit                            │
│ ├── 阈值: 个人$10,000, 企业$100,000                                        │
│ ├── 动作: 触发增强审核                                                      │
│ └── 优先级: 高                                                              │
│                                                                             │
│ R-RISK-003: 高风险国家交易                                                   │
│ ├── 条件: dest_country IN high_risk_countries                              │
│ ├── 名单: 朝鲜、伊朗、叙利亚、古巴、委内瑞拉等                              │
│ ├── 动作: 阻止 或 增强审核                                                  │
│ └── 优先级: 最高                                                            │
│                                                                             │
│ R-RISK-004: 结构化拆分检测                                                   │
│ ├── 条件: 24小时内多笔交易合计接近申报阈值                                  │
│ ├── 阈值: 总额 $9,000-$10,000 范围内分3笔以上                              │
│ ├── 动作: 标记可疑, 触发AML审核                                            │
│ └── 优先级: 高                                                              │
│                                                                             │
│ R-RISK-005: 快进快出检测                                                     │
│ ├── 条件: 入金后短时间内大额出金                                            │
│ ├── 阈值: 入金7日内出金超过入金额80%                                       │
│ ├── 动作: 触发AML审核                                                       │
│ └── 优先级: 中                                                              │
│                                                                             │
│ R-RISK-006: 异常时间交易                                                     │
│ ├── 条件: 交易时间在非工作时间 (当地时间 22:00-06:00)                       │
│ ├── 动作: 增加风险评分 +10                                                  │
│ └── 优先级: 低                                                              │
│                                                                             │
│ R-RISK-007: 新收款人大额                                                     │
│ ├── 条件: 首次向该收款人付款且金额 > $5,000                                 │
│ ├── 动作: 增强审核                                                          │
│ └── 优先级: 中                                                              │
│                                                                             │
│ R-RISK-008: 频繁小额交易                                                     │
│ ├── 条件: 1小时内交易次数 > 10                                             │
│ ├── 动作: 触发频率限制, 标记异常                                            │
│ └── 优先级: 中                                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 换汇规则

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              换汇规则                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ R-FX-001: 报价有效期                                                         │
│ ├── 规则: quote_valid_seconds = 30                                          │
│ ├── 超时: 需重新询价                                                        │
│ └── 原因: 汇率波动风险控制                                                  │
│                                                                             │
│ R-FX-002: 阶梯加点                                                           │
│ ├── 规则: markup = tier_markup(merchant.monthly_volume)                    │
│ ├── Tier 1 (0-100K): 50 bps                                                │
│ ├── Tier 2 (100K-1M): 40 bps                                               │
│ ├── Tier 3 (1M-10M): 25 bps                                                │
│ ├── Tier 4 (10M+): 15 bps                                                  │
│ └── 计算: customer_rate = interbank_rate * (1 + markup)                    │
│                                                                             │
│ R-FX-003: 头寸限额                                                           │
│ ├── 规则: |net_position| <= currency.position_limit                        │
│ ├── USD: $10M                                                               │
│ ├── EUR: €8M                                                                │
│ ├── 新兴市场: $2M                                                           │
│ └── 超限动作: 触发自动对冲                                                  │
│                                                                             │
│ R-FX-004: 对冲触发                                                           │
│ ├── 规则: position_utilization >= 70%                                       │
│ ├── 对冲比例: 50% of net_position                                           │
│ └── 执行: 异步银行间市场对冲                                                │
│                                                                             │
│ R-FX-005: 报价偏离检测                                                       │
│ ├── 规则: |quote_rate - market_rate| / market_rate <= 0.5%                 │
│ ├── 超限: 告警 + 重新获取市场汇率                                           │
│ └── 原因: 防止报价异常                                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.4 通道路由规则

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              通道路由规则                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ R-ROUTE-001: 通道可用性                                                      │
│ ├── 规则: channel.status == 'ACTIVE'                                       │
│ │         AND circuit_breaker.state != 'OPEN'                              │
│ │         AND daily_volume < daily_limit                                   │
│ └── 不可用: 跳过该通道                                                      │
│                                                                             │
│ R-ROUTE-002: 走廊匹配                                                        │
│ ├── 规则: channel.supports(source_country, dest_country)                   │
│ │         AND channel.supports(source_currency, dest_currency)             │
│ └── 不匹配: 跳过该通道                                                      │
│                                                                             │
│ R-ROUTE-003: 金额范围                                                        │
│ ├── 规则: channel.min_amount <= amount <= channel.max_amount               │
│ └── 超范围: 跳过该通道                                                      │
│                                                                             │
│ R-ROUTE-004: 评分权重                                                        │
│ ├── 成本权重: 30%                                                           │
│ ├── 速度权重: 25%                                                           │
│ ├── 可靠性权重: 30%                                                         │
│ ├── 容量权重: 15%                                                           │
│ └── 选择: 综合评分最高的通道                                                │
│                                                                             │
│ R-ROUTE-005: 优先级覆盖                                                      │
│ ├── VIP商户: 优先使用银行直连                                               │
│ ├── 大额交易: 优先使用SWIFT GPI                                             │
│ ├── 紧急付款: 优先使用实时通道                                              │
│ └── 规则: 优先级 > 评分                                                     │
│                                                                             │
│ R-ROUTE-006: 降级策略                                                        │
│ ├── 主通道失败: 自动切换备用通道                                            │
│ ├── 最大重试: 3次                                                           │
│ ├── 重试间隔: 指数退避 (1s, 2s, 4s)                                         │
│ └── 全部失败: 标记订单失败, 触发退款                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 流程编排与状态机

### 6.1 订单状态机

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           订单状态机定义                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ 状态定义:                                                                    │
│ ┌───────────────────────────────────────────────────────────────────────┐   │
│ │ CREATED          │ 订单已创建, 待付款                                 │   │
│ │ PAYMENT_PENDING  │ 等待客户付款                                       │   │
│ │ PAYMENT_RECEIVED │ 已收到付款                                         │   │
│ │ COMPLIANCE_CHECK │ 合规审核中                                         │   │
│ │ COMPLIANCE_HOLD  │ 合规审核暂停 (等待补充材料)                        │   │
│ │ FX_PROCESSING    │ 换汇处理中                                         │   │
│ │ ROUTING          │ 通道路由中                                         │   │
│ │ CHANNEL_SUBMITTED│ 已提交通道                                         │   │
│ │ CHANNEL_PROCESSING│ 通道处理中                                        │   │
│ │ COMPLETED        │ 已完成                                             │   │
│ │ FAILED           │ 失败                                               │   │
│ │ CANCELLED        │ 已取消                                             │   │
│ │ REFUNDING        │ 退款中                                             │   │
│ │ REFUNDED         │ 已退款                                             │   │
│ └───────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│ 状态转换:                                                                    │
│                                                                             │
│   CREATED ─────────────────────────────────────────────┐                    │
│      │                                                  │ (用户取消)        │
│      ▼                                                  ▼                   │
│   PAYMENT_PENDING ───────────────────────────────> CANCELLED               │
│      │ (收到付款)                                                           │
│      ▼                                                                      │
│   PAYMENT_RECEIVED                                                          │
│      │                                                                      │
│      ▼                                                                      │
│   COMPLIANCE_CHECK ─────────────────┬───────────────────┐                  │
│      │ (通过)          (需补材料)    │      (拒绝)       │                  │
│      │                    ▼          │         ▼        │                  │
│      │            COMPLIANCE_HOLD ───┘      FAILED ─────┼───> REFUNDING    │
│      │                                                  │          │       │
│      ▼                                                  │          ▼       │
│   FX_PROCESSING                                         │      REFUNDED    │
│      │                                                  │                  │
│      ▼                                                  │                  │
│   ROUTING                                               │                  │
│      │                                                  │                  │
│      ▼                                                  │                  │
│   CHANNEL_SUBMITTED                                     │                  │
│      │                                                  │                  │
│      ▼                                                  │                  │
│   CHANNEL_PROCESSING ───────────────────────────────────┤                  │
│      │ (成功)                           (失败)          │                  │
│      ▼                                     ▼            │                  │
│   COMPLETED                              FAILED ────────┘                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 状态转换规则

```rust
// 状态机实现
pub struct OrderStateMachine;

impl OrderStateMachine {
    pub fn can_transition(from: OrderStatus, to: OrderStatus) -> bool {
        match (from, to) {
            // 创建后的转换
            (Created, PaymentPending) => true,
            (Created, Cancelled) => true,

            // 待付款的转换
            (PaymentPending, PaymentReceived) => true,
            (PaymentPending, Cancelled) => true,

            // 已收款的转换
            (PaymentReceived, ComplianceCheck) => true,

            // 合规审核的转换
            (ComplianceCheck, FxProcessing) => true,      // 通过
            (ComplianceCheck, ComplianceHold) => true,    // 暂停
            (ComplianceCheck, Failed) => true,            // 拒绝

            // 合规暂停的转换
            (ComplianceHold, ComplianceCheck) => true,    // 重新审核
            (ComplianceHold, Cancelled) => true,          // 超时取消

            // 换汇处理的转换
            (FxProcessing, Routing) => true,
            (FxProcessing, Failed) => true,

            // 路由的转换
            (Routing, ChannelSubmitted) => true,
            (Routing, Failed) => true,

            // 已提交通道的转换
            (ChannelSubmitted, ChannelProcessing) => true,
            (ChannelSubmitted, Failed) => true,

            // 通道处理中的转换
            (ChannelProcessing, Completed) => true,
            (ChannelProcessing, Failed) => true,

            // 失败的转换
            (Failed, Refunding) => true,

            // 退款中的转换
            (Refunding, Refunded) => true,

            _ => false,
        }
    }

    pub fn transition(order: &mut Order, to: OrderStatus) -> Result<(), StateError> {
        if !Self::can_transition(order.status, to) {
            return Err(StateError::InvalidTransition {
                from: order.status,
                to,
            });
        }

        // 记录状态变更
        order.status_history.push(StatusChange {
            from: order.status,
            to,
            changed_at: Utc::now(),
            reason: None,
        });

        order.status = to;
        order.updated_at = Utc::now();

        Ok(())
    }
}
```

---

## 7. 附录

### 7.1 缩写对照表

| 缩写 | 全称 | 说明 |
|------|------|------|
| L1 | Level 1 | 价值链层 |
| L2 | Level 2 | 流程域层 |
| L3 | Level 3 | 流程组层 |
| L4 | Level 4 | 业务任务层 |
| L5 | Level 5 | 步骤规则层 |
| SLA | Service Level Agreement | 服务级别协议 |
| R | Rule | 业务规则 |
| AML | Anti-Money Laundering | 反洗钱 |
| KYC | Know Your Customer | 了解你的客户 |
| FX | Foreign Exchange | 外汇 |
| bps | Basis Points | 基点 (0.01%) |

### 7.2 参考标准

- **APQC PCF**: Process Classification Framework
- **eTOM**: Enhanced Telecom Operations Map
- **BPMN 2.0**: Business Process Model and Notation
- **ISO 20022**: Financial Services Messaging Standard

---

**文档版本**: v1.0
**创建日期**: 2025-12-03
**作者**: 首席架构师
**建模方法**: 银行业五级流程模型

---

*本文档定义了跨境支付业务的标准化流程模型，从价值链到具体操作步骤，为系统实现和流程优化提供依据。*
